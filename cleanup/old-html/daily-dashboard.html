<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACT Daily Dashboard</title>
    <link rel="stylesheet" href="shared-styles.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f0f2f5;
            color: #333;
            line-height: 1.6;
        }
        
        .dashboard {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header .date {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .header .refresh-btn {
            float: right;
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
        }
        
        .header .refresh-btn:hover {
            background: white;
            color: #667eea;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .metric-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }
        
        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        
        .metric-card.urgent {
            border-left: 5px solid #e74c3c;
        }
        
        .metric-card.warning {
            border-left: 5px solid #f39c12;
        }
        
        .metric-card.success {
            border-left: 5px solid #27ae60;
        }
        
        .metric-card.info {
            border-left: 5px solid #3498db;
        }
        
        .metric-card h3 {
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
            margin-bottom: 10px;
        }
        
        .metric-card .value {
            font-size: 2.5em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .metric-card .change {
            font-size: 0.9em;
            color: #666;
        }
        
        .metric-card .change.positive {
            color: #27ae60;
        }
        
        .metric-card .change.negative {
            color: #e74c3c;
        }
        
        .action-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .action-section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .action-section h2 .badge {
            background: #e74c3c;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: normal;
        }
        
        .action-item {
            padding: 15px;
            border-left: 4px solid #3498db;
            background: #f8f9fa;
            margin-bottom: 15px;
            border-radius: 5px;
            transition: all 0.2s;
        }
        
        .action-item:hover {
            background: #e8f4f8;
            transform: translateX(5px);
        }
        
        .action-item.high-priority {
            border-left-color: #e74c3c;
        }
        
        .action-item.medium-priority {
            border-left-color: #f39c12;
        }
        
        .action-item h4 {
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .action-item .meta {
            font-size: 0.9em;
            color: #666;
        }
        
        .action-item .meta span {
            margin-right: 15px;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #ecf0f1;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .progress-bar .fill {
            height: 100%;
            background: #3498db;
            transition: width 0.3s;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #ecf0f1;
        }
        
        .tab {
            padding: 10px 20px;
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
        }
        
        .tab:hover {
            color: #3498db;
        }
        
        .tab.active {
            color: #3498db;
            border-bottom-color: #3498db;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        
        .empty-state svg {
            width: 100px;
            height: 100px;
            opacity: 0.3;
            margin-bottom: 20px;
        }
        
        @media (max-width: 768px) {
            .metrics-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .header .refresh-btn {
                float: none;
                display: block;
                margin-top: 20px;
            }
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <script src="menu-bar.js"></script>
</head>
<body>
    <div class="act-content">
        <div class="act-card">
            <div class="act-card-header">
            <button class="refresh-btn" onclick="refreshDashboard()">üîÑ Refresh</button>
            <h1>ACT Daily Dashboard</h1>
            <div class="date" id="current-date"></div>
        </div>

        <!-- Key Metrics -->
        <div class="metrics-grid">
            <div class="metric-card urgent" onclick="showTab('urgent')">
                <h3>üö® Urgent Actions</h3>
                <div class="value" id="urgent-count">0</div>
                <div class="change">Require immediate attention</div>
            </div>
            
            <div class="metric-card warning" onclick="showTab('opportunities')">
                <h3>üí∞ Open Opportunities</h3>
                <div class="value" id="opportunities-count">0</div>
                <div class="change" id="opportunities-value">$0 pipeline</div>
            </div>
            
            <div class="metric-card success" onclick="showTab('projects')">
                <h3>üöÄ Active Projects</h3>
                <div class="value" id="projects-count">0</div>
                <div class="change" id="projects-status">0 on track</div>
            </div>
            
            <div class="metric-card info" onclick="showTab('week')">
                <h3>üìÖ This Week</h3>
                <div class="value" id="week-actions">0</div>
                <div class="change">Actions scheduled</div>
            </div>
        </div>

        <!-- Action Sections -->
        <div class="action-section">
            <div class="tabs">
                <button class="tab active" onclick="showTab('urgent')">üö® Urgent</button>
                <button class="tab" onclick="showTab('today')">üìÖ Today</button>
                <button class="tab" onclick="showTab('week')">üìä This Week</button>
                <button class="tab" onclick="showTab('opportunities')">üí∞ Opportunities</button>
                <button class="tab" onclick="showTab('projects')">üöÄ Projects</button>
                <button class="tab" onclick="showTab('relationships')">ü§ù Relationships</button>
            </div>

            <!-- Urgent Tab -->
            <div id="urgent-tab" class="tab-content active">
                <h2>Urgent Actions <span class="badge" id="urgent-badge">0</span></h2>
                <div id="urgent-list" class="loading hidden">
                    <div class="spinner"></div>
                    <p>Loading urgent actions...</p>
                </div>
            </div>

            <!-- Today Tab -->
            <div id="today-tab" class="tab-content">
                <h2>Today's Actions</h2>
                <div id="today-list" class="loading hidden">
                    <div class="spinner"></div>
                    <p>Loading today's actions...</p>
                </div>
            </div>

            <!-- This Week Tab -->
            <div id="week-tab" class="tab-content">
                <h2>This Week's Priorities</h2>
                <div id="week-list" class="loading hidden">
                    <div class="spinner"></div>
                    <p>Loading weekly priorities...</p>
                </div>
            </div>

            <!-- Opportunities Tab -->
            <div id="opportunities-tab" class="tab-content">
                <h2>Opportunity Pipeline</h2>
                <div id="opportunities-list" class="loading hidden">
                    <div class="spinner"></div>
                    <p>Loading opportunities...</p>
                </div>
            </div>

            <!-- Projects Tab -->
            <div id="projects-tab" class="tab-content">
                <h2>Project Status</h2>
                <div id="projects-list" class="loading hidden">
                    <div class="spinner"></div>
                    <p>Loading projects...</p>
                </div>
            </div>

            <!-- Relationships Tab -->
            <div id="relationships-tab" class="tab-content">
                <h2>Relationship Management</h2>
                <div id="relationships-list" class="loading hidden">
                    <div class="spinner"></div>
                    <p>Loading relationships...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="notion-mcp-enhanced.js"></script>
    <script>
        // Initialize dashboard
        let dashboardData = {
            urgent: [],
            today: [],
            week: [],
            opportunities: [],
            projects: [],
            relationships: []
        };

        // Set current date
        document.getElementById('current-date').textContent = new Date().toLocaleDateString('en-AU', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });

        // Tab switching
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // Activate corresponding tab button
            event.target.classList.add('active');
        }

        // Load dashboard data
        async function loadDashboard() {
            try {
                // Initialize enhanced Notion integration
                const notion = new PlacematNotionIntegrationEnhanced();
                
                // Fetch all data from Notion
                console.log('Loading data from Notion...');
                const allData = await notion.getAllData();
                
                // Process data
                processUrgentActions(allData.projects, allData);
                processTodayActions(allData.projects, allData);
                processWeekActions(allData.projects, allData);
                processOpportunities(allData.opportunities || []);
                processProjects(allData.projects || []);
                processRelationships(allData.people || []);
                
                // Update metrics
                updateMetrics();
                
                // Render lists
                renderAllLists();
                
                console.log('Dashboard loaded successfully');
                console.log(`Projects: ${allData.projects.length}, Opportunities: ${allData.opportunities.length}`);
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
                showError('Failed to load dashboard data. Check console for details.');
            }
        }

        function processUrgentActions(projects, allData) {
            dashboardData.urgent = [];
            const now = new Date();
            
            // Check overdue project milestones
            projects.forEach(project => {
                if (project.nextMilestone && project.status === 'Active') {
                    const milestoneDate = new Date(project.nextMilestone);
                    if (milestoneDate < now) {
                        dashboardData.urgent.push({
                            type: 'milestone',
                            title: `Overdue: ${project.name}`,
                            description: 'Project milestone overdue',
                            priority: 'high',
                            owner: project.lead || 'Unassigned',
                            daysOverdue: Math.ceil((now - milestoneDate) / (1000 * 60 * 60 * 24))
                        });
                    }
                }
            });
            
            // Check urgent opportunities
            if (allData.opportunities) {
                allData.opportunities.forEach(opp => {
                    if (opp.deadline) {
                        const deadline = new Date(opp.deadline);
                        const daysUntil = Math.ceil((deadline - now) / (1000 * 60 * 60 * 24));
                        
                        if (daysUntil <= 3 && daysUntil >= 0 && opp.stage !== 'Closed Won') {
                            dashboardData.urgent.push({
                                type: 'opportunity',
                                title: opp.name,
                                description: `Deadline in ${daysUntil} days`,
                                priority: 'high',
                                owner: opp.primaryContact || 'Unassigned',
                                value: opp.amount
                            });
                        }
                    }
                });
            }
        }

        function processTodayActions(projects, allData) {
            dashboardData.today = [];
            const today = new Date().toDateString();
            
            // Add today's milestones
            projects.forEach(project => {
                if (project.nextMilestone) {
                    const milestoneDate = new Date(project.nextMilestone);
                    if (milestoneDate.toDateString() === today) {
                        dashboardData.today.push({
                            type: 'milestone',
                            title: project.name,
                            description: 'Project milestone due',
                            owner: project.lead || 'Unassigned'
                        });
                    }
                }
            });
            
            // Add today's opportunity actions
            if (allData.opportunities) {
                allData.opportunities.forEach(opp => {
                    if (opp.nextActionDate) {
                        const actionDate = new Date(opp.nextActionDate);
                        if (actionDate.toDateString() === today) {
                            dashboardData.today.push({
                                type: 'action',
                                title: opp.name,
                                description: opp.nextAction || 'Follow up',
                                owner: opp.primaryContact || 'Unassigned'
                            });
                        }
                    }
                });
            }
        }

        function processWeekActions(projects, allData) {
            dashboardData.week = [];
            const now = new Date();
            const weekEnd = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
            
            // Add project milestones for the week
            projects.forEach(project => {
                if (project.nextMilestone) {
                    const milestoneDate = new Date(project.nextMilestone);
                    if (milestoneDate > now && milestoneDate <= weekEnd) {
                        dashboardData.week.push({
                            type: 'milestone',
                            title: project.name,
                            date: milestoneDate,
                            owner: project.lead || 'Unassigned'
                        });
                    }
                }
            });
            
            // Add opportunity actions for the week
            if (allData.opportunities) {
                allData.opportunities.forEach(opp => {
                    if (opp.nextActionDate) {
                        const actionDate = new Date(opp.nextActionDate);
                        if (actionDate > now && actionDate <= weekEnd) {
                            dashboardData.week.push({
                                type: 'opportunity',
                                title: opp.name,
                                date: actionDate,
                                owner: opp.primaryContact || 'Unassigned'
                            });
                        }
                    }
                });
            }
            
            // Sort by date
            dashboardData.week.sort((a, b) => a.date - b.date);
        }

        function processOpportunities(opportunities) {
            dashboardData.opportunities = opportunities
                .filter(o => o.stage !== 'Closed Won' && o.stage !== 'Closed Lost')
                .map(o => ({
                    ...o,
                    weightedValue: (o.amount || 0) * (o.probability || 50) / 100
                }))
                .sort((a, b) => b.weightedValue - a.weightedValue);
        }

        function processProjects(projects) {
            dashboardData.projects = projects
                .filter(p => p.status === 'Active')
                .map(p => ({
                    ...p,
                    health: calculateProjectHealth(p)
                }))
                .sort((a, b) => {
                    // Sort by health status (urgent first)
                    const healthOrder = { red: 0, yellow: 1, green: 2 };
                    return healthOrder[a.health] - healthOrder[b.health];
                });
        }

        function calculateProjectHealth(project) {
            const now = new Date();
            
            // Check milestone status
            if (project.nextMilestone) {
                const milestoneDate = new Date(project.nextMilestone);
                const daysUntil = Math.ceil((milestoneDate - now) / (1000 * 60 * 60 * 24));
                
                if (daysUntil < 0) return 'red';
                if (daysUntil < 7) return 'yellow';
            }
            
            // Check funding status
            if (project.funding === 'Needs Funding') return 'yellow';
            
            return 'green';
        }

        function processRelationships(people) {
            dashboardData.relationships = [];
            const now = new Date();
            
            people
                .filter(p => p.relationshipType === 'Key' || p.influenceLevel === 'Decision Maker')
                .forEach(person => {
                    if (person.lastContactDate) {
                        const lastContact = new Date(person.lastContactDate);
                        const daysSince = Math.ceil((now - lastContact) / (1000 * 60 * 60 * 24));
                        
                        if (daysSince > 30) {
                            dashboardData.relationships.push({
                                ...person,
                                daysSinceContact: daysSince,
                                priority: daysSince > 60 ? 'high' : 'medium'
                            });
                        }
                    }
                });
            
            // Sort by days since contact
            dashboardData.relationships.sort((a, b) => b.daysSinceContact - a.daysSinceContact);
        }

        function updateMetrics() {
            // Update urgent count
            document.getElementById('urgent-count').textContent = dashboardData.urgent.length;
            document.getElementById('urgent-badge').textContent = dashboardData.urgent.length;
            
            // Update opportunities
            document.getElementById('opportunities-count').textContent = dashboardData.opportunities.length;
            const totalPipeline = dashboardData.opportunities.reduce((sum, o) => sum + (o.amount || 0), 0);
            document.getElementById('opportunities-value').textContent = `$${formatCurrency(totalPipeline)} pipeline`;
            
            // Update projects
            document.getElementById('projects-count').textContent = dashboardData.projects.length;
            const onTrack = dashboardData.projects.filter(p => p.health === 'green').length;
            document.getElementById('projects-status').textContent = `${onTrack} on track`;
            
            // Update week actions
            document.getElementById('week-actions').textContent = dashboardData.week.length;
        }

        function renderAllLists() {
            renderUrgentList();
            renderTodayList();
            renderWeekList();
            renderOpportunitiesList();
            renderProjectsList();
            renderRelationshipsList();
        }

        function renderUrgentList() {
            const container = document.getElementById('urgent-list');
            
            if (dashboardData.urgent.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>‚úÖ No urgent actions required!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = dashboardData.urgent.map(item => `
                <div class="action-item high-priority">
                    <h4>${item.title}</h4>
                    <p>${item.description}</p>
                    <div class="meta">
                        <span>üë§ ${item.owner}</span>
                        ${item.value ? `<span>üí∞ $${formatCurrency(item.value)}</span>` : ''}
                        ${item.daysOverdue ? `<span>‚è∞ ${item.daysOverdue} days overdue</span>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function renderTodayList() {
            const container = document.getElementById('today-list');
            
            if (dashboardData.today.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>No actions scheduled for today</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = dashboardData.today.map(item => `
                <div class="action-item">
                    <h4>${item.title}</h4>
                    <p>${item.description}</p>
                    <div class="meta">
                        <span>üë§ ${item.owner}</span>
                        <span>üìå ${item.type}</span>
                    </div>
                </div>
            `).join('');
        }

        function renderWeekList() {
            const container = document.getElementById('week-list');
            
            if (dashboardData.week.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>No actions scheduled this week</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = dashboardData.week.map(item => `
                <div class="action-item">
                    <h4>${item.title}</h4>
                    <div class="meta">
                        <span>üìÖ ${item.date.toLocaleDateString()}</span>
                        <span>üë§ ${item.owner}</span>
                        <span>üìå ${item.type}</span>
                    </div>
                </div>
            `).join('');
        }

        function renderOpportunitiesList() {
            const container = document.getElementById('opportunities-list');
            
            if (dashboardData.opportunities.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>No open opportunities</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = dashboardData.opportunities.map(opp => `
                <div class="action-item ${getPriorityClass(opp.amount)}">
                    <h4>${opp.name}</h4>
                    <div class="meta">
                        <span>üí∞ $${formatCurrency(opp.amount)}</span>
                        <span>üìä ${opp.probability}% probability</span>
                        <span>üéØ ${opp.stage}</span>
                        ${opp.deadline ? `<span>üìÖ Due ${new Date(opp.deadline).toLocaleDateString()}</span>` : ''}
                    </div>
                    <div class="progress-bar">
                        <div class="fill" style="width: ${getStageProgress(opp.stage)}%"></div>
                    </div>
                </div>
            `).join('');
        }

        function renderProjectsList() {
            const container = document.getElementById('projects-list');
            
            if (dashboardData.projects.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>No active projects</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = dashboardData.projects.map(project => `
                <div class="action-item ${project.health === 'red' ? 'high-priority' : project.health === 'yellow' ? 'medium-priority' : ''}">
                    <h4>${project.name}</h4>
                    <div class="meta">
                        <span>üè∑Ô∏è ${project.area}</span>
                        <span>üíµ $${formatCurrency(project.revenueActual || 0)} revenue</span>
                        <span>üë§ ${project.lead || 'Unassigned'}</span>
                        ${project.nextMilestone ? `<span>üéØ Next: ${new Date(project.nextMilestone).toLocaleDateString()}</span>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function renderRelationshipsList() {
            const container = document.getElementById('relationships-list');
            
            if (dashboardData.relationships.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>All key relationships are up to date</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = dashboardData.relationships.slice(0, 5).map(person => `
                <div class="action-item ${person.priority === 'high' ? 'high-priority' : 'medium-priority'}">
                    <h4>${person.fullName}</h4>
                    <div class="meta">
                        <span>üè¢ ${person.organization || 'Unknown'}</span>
                        <span>üìß No contact for ${person.daysSinceContact} days</span>
                        <span>üíº ${person.role || 'Unknown role'}</span>
                    </div>
                </div>
            `).join('');
        }

        // Helper functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-AU', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount || 0);
        }

        function getPriorityClass(amount) {
            if (amount > 100000) return 'high-priority';
            if (amount > 50000) return 'medium-priority';
            return '';
        }

        function getStageProgress(stage) {
            const stages = {
                'Discovery': 20,
                'Qualification': 40,
                'Proposal': 60,
                'Negotiation': 80,
                'Closed Won': 100
            };
            return stages[stage] || 0;
        }

        function showError(message) {
            console.error(message);
            // Could show a toast notification here
        }

        function refreshDashboard() {
            // Show loading state
            document.querySelectorAll('.tab-content > div').forEach(list => {
                list.innerHTML = '<div class="loading hidden"><div class="spinner"></div><p>Refreshing...</p></div>';
            });
            
            // Reload data
            loadDashboard();
        }

        // Auto-refresh every 5 minutes
        setInterval(refreshDashboard, 5 * 60 * 1000);

        // Load dashboard on page load
        window.addEventListener('load', loadDashboard);
    </script>
</body>
</html>