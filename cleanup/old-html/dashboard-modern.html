<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACT Placemat - Dashboard</title>
    <link rel="stylesheet" href="modern-styles.css">
</head>
<body>
    <div class="app-container">
        <div class="app-main">
            <header class="app-header">
                <h1 class="header-title">Dashboard</h1>
                <div class="header-actions">
                    <button class="btn btn-ghost btn-sm">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"/>
                        </svg>
                        Refresh
                    </button>
                    <button class="btn btn-primary btn-sm">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
                        </svg>
                        New Project
                    </button>
                </div>
            </header>

            <main class="app-content">
                <!-- Key Metrics -->
                <div class="metrics-grid" id="metrics-container">
                    <div class="metric-card">
                        <div class="metric-value" id="total-projects">-</div>
                        <div class="metric-label">Total Projects</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="active-projects">-</div>
                        <div class="metric-label">Active Projects</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="total-revenue">-</div>
                        <div class="metric-label">Total Revenue</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="revenue-potential">-</div>
                        <div class="metric-label">Revenue Potential</div>
                    </div>
                </div>

                <!-- Main Content Grid -->
                <div class="grid grid-cols-3" style="grid-template-columns: 2fr 1fr; gap: var(--space-6);">
                    <!-- Projects Overview -->
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Recent Projects</h2>
                            <p class="card-subtitle">Latest project activity and updates</p>
                        </div>
                        <div class="card-content">
                            <div id="projects-loading" class="loading hidden">
                                <div class="spinner"></div>
                                <!-- Loading projects... -->
                            </div>
                            <div id="projects-error" class="text-center text-secondary hidden">
                                Failed to load projects
                            </div>
                            <div id="projects-container" class="hidden">
                                <!-- Projects will be loaded here -->
                            </div>
                        </div>
                        <div class="card-footer">
                            <a href="/projects-enhanced.html" class="btn btn-secondary btn-sm">View All Projects</a>
                        </div>
                    </div>

                    <!-- Quick Stats & Actions -->
                    <div class="flex flex-col" style="gap: var(--space-6);">
                        <!-- Status Distribution -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Project Status</h3>
                            </div>
                            <div class="card-content">
                                <div id="status-distribution">
                                    <!-- Status chart will be loaded here -->
                                </div>
                            </div>
                        </div>

                        <!-- Quick Actions -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Quick Actions</h3>
                            </div>
                            <div class="card-content">
                                <div class="flex flex-col" style="gap: var(--space-3);">
                                    <a href="/projects-enhanced.html" class="btn btn-secondary">
                                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M3 3a1 1 0 000 2v8a2 2 0 002 2h2.586l-1.293 1.293a1 1 0 101.414 1.414L10 15.414l2.293 2.293a1 1 0 001.414-1.414L12.414 15H15a2 2 0 002-2V5a1 1 0 100-2H3zm11.707 4.707a1 1 0 00-1.414-1.414L10 9.586 8.707 8.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                        </svg>
                                        View All Projects
                                    </a>
                                    
                                    <a href="/opportunities.html" class="btn btn-secondary">
                                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                        View Opportunities
                                    </a>
                                    
                                    <a href="/analytics.html" class="btn btn-secondary">
                                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"/>
                                        </svg>
                                        View Analytics
                                    </a>
                                </div>
                            </div>
                        </div>

                        <!-- Recent Activity -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Recent Activity</h3>
                            </div>
                            <div class="card-content">
                                <div id="recent-activity" class="flex flex-col" style="gap: var(--space-3);">
                                    <!-- Activity items will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="modern-nav.js"></script>
    <script>
        let notion;
        let allData = {};

        async function initDashboard() {
            try {
                await loadDashboardData();
            } catch (error) {
                console.error('Failed to initialize dashboard:', error);
                showError('Failed to initialize dashboard');
            }
        }

        async function loadDashboardData() {
            try {
                console.log('Loading dashboard data...');
                
                const response = await fetch('/api/notion/real-projects');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                allData = await response.json();
                
                updateMetrics(allData);
                renderProjectsOverview(allData.projects);
                renderStatusDistribution(allData.projects);
                renderRecentActivity(allData.projects);
                
                hideLoading();
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showError('Failed to load dashboard data');
            }
        }

        function updateMetrics(data) {
            const metrics = {
                totalProjects: data.summary?.totalProjects || data.projects.length,
                activeProjects: data.summary?.activeProjects || data.projects.filter(p => p.status?.includes('Active')).length,
                totalRevenue: data.summary?.totalRevenue || 0,
                revenuePotential: data.summary?.totalPotential || 0
            };

            document.getElementById('total-projects').textContent = metrics.totalProjects;
            document.getElementById('active-projects').textContent = metrics.activeProjects;
            document.getElementById('total-revenue').textContent = formatCurrency(metrics.totalRevenue);
            document.getElementById('revenue-potential').textContent = formatCurrency(metrics.revenuePotential);
        }

        function renderProjectsOverview(projects) {
            const container = document.getElementById('projects-container');
            const recentProjects = projects.slice(0, 6);

            if (recentProjects.length === 0) {
                container.innerHTML = '<div class="text-center text-secondary">No projects found</div>';
                return;
            }

            container.innerHTML = `
                <div class="flex flex-col" style="gap: var(--space-4);">
                    ${recentProjects.map(project => `
                        <div class="flex items-center justify-between p-4" style="border: 1px solid var(--gray-200); border-radius: var(--radius-md); background: var(--surface-hover);">
                            <div class="flex-1">
                                <h4 class="font-medium text-primary mb-1">${project.name}</h4>
                                <p class="text-sm text-secondary">${project.location || project.state || 'Location not specified'}</p>
                            </div>
                            <div class="flex items-center" style="gap: var(--space-3);">
                                <div class="text-right">
                                    <div class="text-sm font-medium">${formatCurrency(project.revenueActual || 0)}</div>
                                    <div class="text-xs text-secondary">Revenue</div>
                                </div>
                                <div class="status-badge ${getStatusClass(project.status)}">
                                    ${cleanStatus(project.status)}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderStatusDistribution(projects) {
            const statusCount = {};
            projects.forEach(project => {
                const status = cleanStatus(project.status);
                statusCount[status] = (statusCount[status] || 0) + 1;
            });

            const container = document.getElementById('status-distribution');
            container.innerHTML = `
                <div class="flex flex-col" style="gap: var(--space-3);">
                    ${Object.entries(statusCount).map(([status, count]) => `
                        <div class="flex items-center justify-between">
                            <div class="flex items-center" style="gap: var(--space-2);">
                                <div class="status-badge ${getStatusClass(status)}">${status}</div>
                            </div>
                            <div class="font-semibold">${count}</div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderRecentActivity(projects) {
            const recentProjects = projects
                .filter(p => p.lastEditedTime)
                .sort((a, b) => new Date(b.lastEditedTime) - new Date(a.lastEditedTime))
                .slice(0, 5);

            const container = document.getElementById('recent-activity');
            container.innerHTML = recentProjects.map(project => `
                <div class="flex items-start" style="gap: var(--space-3);">
                    <div style="width: 8px; height: 8px; background: var(--primary); border-radius: 50%; margin-top: 6px; flex-shrink: 0;"></div>
                    <div class="flex-1">
                        <div class="text-sm font-medium text-primary">${project.name}</div>
                        <div class="text-xs text-secondary">${formatTimeAgo(project.lastEditedTime)}</div>
                    </div>
                </div>
            `).join('');
        }

        function hideLoading() {
            document.getElementById('projects-loading').classList.add('hidden');
            document.getElementById('projects-container').classList.remove('hidden');
        }

        function showError(message) {
            document.getElementById('projects-loading').classList.add('hidden');
            document.getElementById('projects-error').classList.remove('hidden');
            document.getElementById('projects-error').textContent = message;
        }

        function formatCurrency(amount) {
            if (!amount) return '$0';
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        function cleanStatus(status) {
            if (!status) return 'Unknown';
            return status.replace(/[ðŸ”¥ðŸŒ€ðŸŒ…]/g, '').trim() || 'Unknown';
        }

        function getStatusClass(status) {
            const cleanedStatus = cleanStatus(status).toLowerCase();
            if (cleanedStatus.includes('active')) return 'status-active';
            if (cleanedStatus.includes('ideation') || cleanedStatus.includes('planning')) return 'status-planning';
            if (cleanedStatus.includes('completed') || cleanedStatus.includes('sunsetting')) return 'status-completed';
            return 'status-planning';
        }

        function formatTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays} days ago`;
            if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;
            return `${Math.floor(diffDays / 30)} months ago`;
        }

        // Initialize dashboard when DOM is loaded
        document.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>
</html>