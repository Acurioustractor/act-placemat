<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Management Tools - ACT Placemat</title>
    <link rel="stylesheet" href="modern-styles.css">
    <style>
        .tools-container {
            padding: var(--space-6);
            padding-left: 280px; /* Account for sidebar */
            max-width: 1400px;
            margin: 0 auto;
        }

        .tools-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-6);
            margin-bottom: var(--space-6);
        }

        .tool-panel {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            border: 1px solid var(--gray-200);
        }

        .tool-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: var(--space-4);
        }

        .tool-title {
            font-size: var(--text-xl);
            font-weight: var(--font-semibold);
            color: var(--text-primary);
        }

        .filters-section {
            background: var(--gray-50);
            border-radius: var(--radius-md);
            padding: var(--space-4);
            margin-bottom: var(--space-4);
        }

        .filter-group {
            margin-bottom: var(--space-3);
        }

        .filter-label {
            display: block;
            font-size: var(--text-sm);
            font-weight: var(--font-medium);
            color: var(--text-secondary);
            margin-bottom: var(--space-1);
        }

        .filter-input, .filter-select {
            width: 100%;
            padding: var(--space-2);
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-sm);
            font-size: var(--text-sm);
        }

        .filter-checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: var(--space-2);
            margin-top: var(--space-2);
        }

        .filter-checkbox {
            display: flex;
            align-items: center;
            gap: var(--space-1);
            font-size: var(--text-sm);
        }

        .btn {
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-md);
            font-size: var(--text-sm);
            font-weight: var(--font-medium);
            cursor: pointer;
            border: none;
            transition: all var(--transition-fast);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-600);
        }

        .btn-secondary {
            background: var(--gray-100);
            color: var(--text-primary);
            border: 1px solid var(--gray-300);
        }

        .btn-secondary:hover {
            background: var(--gray-200);
        }

        .results-section {
            margin-top: var(--space-4);
        }

        .results-grid {
            display: grid;
            gap: var(--space-3);
        }

        .result-card {
            background: var(--background);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
            padding: var(--space-4);
            transition: all var(--transition-fast);
        }

        .result-card:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-sm);
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-2);
        }

        .result-title {
            font-weight: var(--font-semibold);
            color: var(--text-primary);
            margin-bottom: var(--space-1);
        }

        .result-meta {
            font-size: var(--text-sm);
            color: var(--text-secondary);
        }

        .result-tags {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-1);
            margin-top: var(--space-2);
        }

        .tag {
            background: var(--primary-100);
            color: var(--primary-700);
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-full);
            font-size: var(--text-xs);
        }

        .stats-card {
            background: var(--background);
            border-radius: var(--radius-md);
            padding: var(--space-4);
            text-align: center;
            border: 1px solid var(--gray-200);
        }

        .stat-number {
            font-size: var(--text-2xl);
            font-weight: var(--font-bold);
            color: var(--primary);
            display: block;
        }

        .stat-label {
            font-size: var(--text-sm);
            color: var(--text-secondary);
        }

        .quality-indicator {
            display: inline-flex;
            align-items: center;
            gap: var(--space-1);
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-full);
            font-size: var(--text-xs);
            font-weight: var(--font-medium);
        }

        .quality-excellent {
            background: var(--success-100);
            color: var(--success-700);
        }

        .quality-good {
            background: var(--warning-100);
            color: var(--warning-700);
        }

        .quality-poor {
            background: var(--error-100);
            color: var(--error-700);
        }

        .loading {
            display: none;
            text-align: center;
            padding: var(--space-4);
            color: var(--text-secondary);
        }

        .loading.show {
            display: block;
        }

        .export-section {
            margin-top: var(--space-4);
            padding-top: var(--space-4);
            border-top: 1px solid var(--gray-200);
        }

        .export-buttons {
            display: flex;
            gap: var(--space-2);
        }
    </style>
    <script src="modern-nav.js"></script>
</head>
<body>
    <div class="tools-container">
        <h1>üõ†Ô∏è Data Management Tools</h1>
        <p class="text-secondary">Advanced filtering, analysis, and export tools for your Supabase data</p>

        <div class="tools-grid">
            <!-- Storyteller Tools -->
            <div class="tool-panel">
                <div class="tool-header">
                    <h2 class="tool-title">üë• Storyteller Analysis</h2>
                    <span id="storyteller-count" class="stat-number">0</span>
                </div>

                <div class="filters-section">
                    <h3>Filters</h3>
                    
                    <div class="filter-group">
                        <label class="filter-label">Search</label>
                        <input type="text" id="storyteller-search" class="filter-input" placeholder="Search names, bios, locations...">
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Data Quality</label>
                        <div class="filter-checkbox-group">
                            <label class="filter-checkbox">
                                <input type="checkbox" id="has-bio"> Has Bio
                            </label>
                            <label class="filter-checkbox">
                                <input type="checkbox" id="has-image"> Has Profile Image
                            </label>
                            <label class="filter-checkbox">
                                <input type="checkbox" id="has-quotes"> Has Quotes
                            </label>
                        </div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Community</label>
                        <select id="community-filter" class="filter-select">
                            <option value="">All Communities</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Location</label>
                        <select id="location-filter" class="filter-select">
                            <option value="">All Locations</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Storyteller Type</label>
                        <select id="type-filter" class="filter-select">
                            <option value="">All Types</option>
                        </select>
                    </div>

                    <button class="btn btn-primary" onclick="filterStorytellers()">Apply Filters</button>
                    <button class="btn btn-secondary" onclick="clearFilters()">Clear</button>
                </div>

                <div class="results-section">
                    <div class="loading" id="storyteller-loading">Loading storytellers...</div>
                    <div id="storyteller-results" class="results-grid"></div>
                </div>

                <div class="export-section">
                    <h4>Export Options</h4>
                    <div class="export-buttons">
                        <button class="btn btn-secondary" onclick="exportStorytellers('json')">Export JSON</button>
                        <button class="btn btn-secondary" onclick="exportStorytellers('csv')">Export CSV</button>
                    </div>
                </div>
            </div>

            <!-- Story Tools -->
            <div class="tool-panel">
                <div class="tool-header">
                    <h2 class="tool-title">üìñ Story Analysis</h2>
                    <span id="story-count" class="stat-number">0</span>
                </div>

                <div class="filters-section">
                    <h3>Filters</h3>
                    
                    <div class="filter-group">
                        <label class="filter-label">Search</label>
                        <input type="text" id="story-search" class="filter-input" placeholder="Search titles, content, themes...">
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Media Assets</label>
                        <div class="filter-checkbox-group">
                            <label class="filter-checkbox">
                                <input type="checkbox" id="has-video"> Has Video
                            </label>
                            <label class="filter-checkbox">
                                <input type="checkbox" id="has-audio"> Has Audio
                            </label>
                            <label class="filter-checkbox">
                                <input type="checkbox" id="has-image-story"> Has Image
                            </label>
                            <label class="filter-checkbox">
                                <input type="checkbox" id="has-transcript"> Has Transcript
                            </label>
                        </div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Status</label>
                        <select id="status-filter" class="filter-select">
                            <option value="">All Statuses</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Medium</label>
                        <select id="medium-filter" class="filter-select">
                            <option value="">All Mediums</option>
                        </select>
                    </div>

                    <button class="btn btn-primary" onclick="filterStories()">Apply Filters</button>
                    <button class="btn btn-secondary" onclick="clearStoryFilters()">Clear</button>
                </div>

                <div class="results-section">
                    <div class="loading" id="story-loading">Loading stories...</div>
                    <div id="story-results" class="results-grid"></div>
                </div>

                <div class="export-section">
                    <h4>Export Options</h4>
                    <div class="export-buttons">
                        <button class="btn btn-secondary" onclick="exportStories('json')">Export JSON</button>
                        <button class="btn btn-secondary" onclick="exportStories('csv')">Export CSV</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Quality Dashboard -->
        <div class="tool-panel">
            <div class="tool-header">
                <h2 class="tool-title">üìä Data Quality Dashboard</h2>
                <button class="btn btn-secondary" onclick="refreshQualityAnalysis()">Refresh Analysis</button>
            </div>

            <div id="quality-dashboard" class="loading">Loading quality analysis...</div>
        </div>
    </div>

    <script>
        let filterOptions = {};
        let currentStorytellerFilters = {};
        let currentStoryFilters = {};

        // Initialize the interface
        async function initDataTools() {
            try {
                await Promise.all([
                    loadFilterOptions(),
                    loadInitialData(),
                    loadQualityDashboard()
                ]);
            } catch (error) {
                console.error('Error initializing data tools:', error);
            }
        }

        async function loadFilterOptions() {
            try {
                const [storytellerOptions, storyOptions] = await Promise.all([
                    fetch('/api/filter-options/storytellers').then(r => r.json()),
                    fetch('/api/filter-options/stories').then(r => r.json())
                ]);

                filterOptions.storytellers = storytellerOptions;
                filterOptions.stories = storyOptions;

                populateFilterDropdowns();
            } catch (error) {
                console.error('Error loading filter options:', error);
            }
        }

        function populateFilterDropdowns() {
            // Storyteller filters
            const communitySelect = document.getElementById('community-filter');
            const locationSelect = document.getElementById('location-filter');
            const typeSelect = document.getElementById('type-filter');

            if (filterOptions.storytellers.community_affiliation) {
                filterOptions.storytellers.community_affiliation.forEach(community => {
                    const option = document.createElement('option');
                    option.value = community;
                    option.textContent = community;
                    communitySelect.appendChild(option);
                });
            }

            if (filterOptions.storytellers.location) {
                filterOptions.storytellers.location.forEach(location => {
                    const option = document.createElement('option');
                    option.value = location;
                    option.textContent = location;
                    locationSelect.appendChild(option);
                });
            }

            if (filterOptions.storytellers.storyteller_type) {
                filterOptions.storytellers.storyteller_type.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type.charAt(0).toUpperCase() + type.slice(1);
                    typeSelect.appendChild(option);
                });
            }

            // Story filters
            const statusSelect = document.getElementById('status-filter');
            const mediumSelect = document.getElementById('medium-filter');

            if (filterOptions.stories.status) {
                filterOptions.stories.status.forEach(status => {
                    const option = document.createElement('option');
                    option.value = status;
                    option.textContent = status.charAt(0).toUpperCase() + status.slice(1);
                    statusSelect.appendChild(option);
                });
            }

            if (filterOptions.stories.medium) {
                filterOptions.stories.medium.forEach(medium => {
                    const option = document.createElement('option');
                    option.value = medium;
                    option.textContent = medium.charAt(0).toUpperCase() + medium.slice(1);
                    mediumSelect.appendChild(option);
                });
            }
        }

        async function loadInitialData() {
            await Promise.all([
                filterStorytellers(),
                filterStories()
            ]);
        }

        async function filterStorytellers() {
            const loading = document.getElementById('storyteller-loading');
            const results = document.getElementById('storyteller-results');
            
            loading.classList.add('show');
            results.innerHTML = '';

            try {
                const filters = {
                    search: document.getElementById('storyteller-search').value,
                    hasBio: document.getElementById('has-bio').checked ? true : null,
                    hasProfileImage: document.getElementById('has-image').checked ? true : null,
                    hasQuotes: document.getElementById('has-quotes').checked ? true : null,
                    communities: document.getElementById('community-filter').value ? [document.getElementById('community-filter').value] : [],
                    locations: document.getElementById('location-filter').value ? [document.getElementById('location-filter').value] : [],
                    storytellerTypes: document.getElementById('type-filter').value ? [document.getElementById('type-filter').value] : [],
                    limit: 50
                };

                currentStorytellerFilters = filters;

                const response = await fetch('/api/storytellers/filtered', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(filters)
                });

                const data = await response.json();
                
                document.getElementById('storyteller-count').textContent = data.count;
                
                if (data.data && data.data.length > 0) {
                    results.innerHTML = data.data.map(storyteller => `
                        <div class="result-card">
                            <div class="result-header">
                                <div>
                                    <div class="result-title">${storyteller.full_name || 'Unknown'}</div>
                                    <div class="result-meta">
                                        üìç ${storyteller.location || 'No location'}
                                        ${storyteller.community_affiliation ? ` ‚Ä¢ üè¢ ${storyteller.community_affiliation}` : ''}
                                    </div>
                                </div>
                                ${getQualityIndicator(storyteller)}
                            </div>
                            ${storyteller.bio ? `<p class="text-sm text-secondary">${storyteller.bio.substring(0, 150)}${storyteller.bio.length > 150 ? '...' : ''}</p>` : ''}
                            <div class="result-tags">
                                ${storyteller.storyteller_type ? `<span class="tag">${storyteller.storyteller_type}</span>` : ''}
                                ${storyteller.profile_image_url ? '<span class="tag">üì∏ Image</span>' : ''}
                                ${storyteller.signature_quotes && storyteller.signature_quotes.length > 0 ? '<span class="tag">üí¨ Quotes</span>' : ''}
                                ${storyteller.bio ? '<span class="tag">üìù Bio</span>' : ''}
                            </div>
                        </div>
                    `).join('');
                } else {
                    results.innerHTML = '<p class="text-secondary text-center">No storytellers found matching your criteria.</p>';
                }

            } catch (error) {
                console.error('Error filtering storytellers:', error);
                results.innerHTML = '<p class="text-error text-center">Error loading storytellers.</p>';
            } finally {
                loading.classList.remove('show');
            }
        }

        async function filterStories() {
            const loading = document.getElementById('story-loading');
            const results = document.getElementById('story-results');
            
            loading.classList.add('show');
            results.innerHTML = '';

            try {
                const filters = {
                    search: document.getElementById('story-search').value,
                    hasVideo: document.getElementById('has-video').checked ? true : null,
                    hasAudio: document.getElementById('has-audio').checked ? true : null,
                    hasImage: document.getElementById('has-image-story').checked ? true : null,
                    hasTranscript: document.getElementById('has-transcript').checked ? true : null,
                    status: document.getElementById('status-filter').value ? [document.getElementById('status-filter').value] : [],
                    mediums: document.getElementById('medium-filter').value ? [document.getElementById('medium-filter').value] : [],
                    limit: 50
                };

                currentStoryFilters = filters;

                const response = await fetch('/api/stories/filtered', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(filters)
                });

                const data = await response.json();
                
                document.getElementById('story-count').textContent = data.count;
                
                if (data.data && data.data.length > 0) {
                    results.innerHTML = data.data.map(story => `
                        <div class="result-card">
                            <div class="result-header">
                                <div>
                                    <div class="result-title">${story.title || 'Untitled Story'}</div>
                                    <div class="result-meta">
                                        ${story.storytellers ? `üë§ ${story.storytellers.full_name}` : 'Unknown storyteller'}
                                        ${story.medium ? ` ‚Ä¢ üì± ${story.medium}` : ''}
                                        ${story.date_occurred ? ` ‚Ä¢ üìÖ ${new Date(story.date_occurred).toLocaleDateString()}` : ''}
                                    </div>
                                </div>
                                <span class="tag">${story.status || 'Unknown'}</span>
                            </div>
                            ${story.story_copy ? `<p class="text-sm text-secondary">${story.story_copy.substring(0, 150)}${story.story_copy.length > 150 ? '...' : ''}</p>` : ''}
                            <div class="result-tags">
                                ${story.video_url ? '<span class="tag">üé• Video</span>' : ''}
                                ${story.audio_url ? '<span class="tag">üéµ Audio</span>' : ''}
                                ${story.image_url ? '<span class="tag">üì∏ Image</span>' : ''}
                                ${story.transcript ? '<span class="tag">üìù Transcript</span>' : ''}
                                ${story.primary_themes && story.primary_themes.length > 0 ? `<span class="tag">üè∑Ô∏è ${story.primary_themes.length} themes</span>` : ''}
                            </div>
                        </div>
                    `).join('');
                } else {
                    results.innerHTML = '<p class="text-secondary text-center">No stories found matching your criteria.</p>';
                }

            } catch (error) {
                console.error('Error filtering stories:', error);
                results.innerHTML = '<p class="text-error text-center">Error loading stories.</p>';
            } finally {
                loading.classList.remove('show');
            }
        }

        function getQualityIndicator(storyteller) {
            let score = 0;
            if (storyteller.bio) score += 25;
            if (storyteller.profile_image_url) score += 25;
            if (storyteller.signature_quotes && storyteller.signature_quotes.length > 0) score += 25;
            if (storyteller.community_affiliation) score += 25;

            if (score >= 75) {
                return '<span class="quality-indicator quality-excellent">‚úÖ Excellent</span>';
            } else if (score >= 50) {
                return '<span class="quality-indicator quality-good">‚ö†Ô∏è Good</span>';
            } else {
                return '<span class="quality-indicator quality-poor">‚ùå Needs Work</span>';
            }
        }

        async function loadQualityDashboard() {
            const dashboard = document.getElementById('quality-dashboard');
            
            try {
                const response = await fetch('/api/data-quality/report');
                const report = await response.json();
                
                dashboard.classList.remove('loading');
                dashboard.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-4); margin-bottom: var(--space-6);">
                        ${Object.entries(report.tables).map(([tableName, data]) => {
                            if (data.error) {
                                return `
                                    <div class="stats-card">
                                        <span class="stat-number">‚ùå</span>
                                        <span class="stat-label">${tableName}</span>
                                        <div class="text-xs text-error">${data.error}</div>
                                    </div>
                                `;
                            }
                            
                            return `
                                <div class="stats-card">
                                    <span class="stat-number">${data.totalRecords}</span>
                                    <span class="stat-label">${tableName}</span>
                                    <div class="quality-indicator ${getQualityClass(data.overallQualityScore)}" style="margin-top: var(--space-2);">
                                        ${data.overallQualityScore}% Quality
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-4);">
                        <div>
                            <h4>üìà Quality Recommendations</h4>
                            <div style="max-height: 200px; overflow-y: auto;">
                                ${Object.values(report.tables).flatMap(table => 
                                    table.recommendations || []
                                ).slice(0, 10).map(rec => 
                                    `<div class="text-sm" style="margin-bottom: var(--space-1);">${rec}</div>`
                                ).join('')}
                            </div>
                        </div>
                        
                        <div>
                            <h4>üîç Field Analysis</h4>
                            <div style="max-height: 200px; overflow-y: auto;">
                                ${Object.entries(report.tables.storytellers?.fieldAnalysis || {}).slice(0, 8).map(([field, analysis]) => 
                                    `<div class="text-sm" style="margin-bottom: var(--space-1);">
                                        <strong>${field}:</strong> ${analysis.completeness}% complete
                                    </div>`
                                ).join('')}
                            </div>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading quality dashboard:', error);
                dashboard.innerHTML = '<p class="text-error">Error loading quality analysis.</p>';
            }
        }

        function getQualityClass(score) {
            if (score >= 75) return 'quality-excellent';
            if (score >= 50) return 'quality-good';
            return 'quality-poor';
        }

        function clearFilters() {
            document.getElementById('storyteller-search').value = '';
            document.getElementById('has-bio').checked = false;
            document.getElementById('has-image').checked = false;
            document.getElementById('has-quotes').checked = false;
            document.getElementById('community-filter').value = '';
            document.getElementById('location-filter').value = '';
            document.getElementById('type-filter').value = '';
            filterStorytellers();
        }

        function clearStoryFilters() {
            document.getElementById('story-search').value = '';
            document.getElementById('has-video').checked = false;
            document.getElementById('has-audio').checked = false;
            document.getElementById('has-image-story').checked = false;
            document.getElementById('has-transcript').checked = false;
            document.getElementById('status-filter').value = '';
            document.getElementById('medium-filter').value = '';
            filterStories();
        }

        async function exportStorytellers(format) {
            try {
                const response = await fetch(`/api/storytellers/export/${format}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(currentStorytellerFilters)
                });

                if (format === 'json') {
                    const data = await response.json();
                    downloadJSON(data, 'storytellers.json');
                } else {
                    const csv = await response.text();
                    downloadCSV(csv, 'storytellers.csv');
                }
            } catch (error) {
                console.error('Error exporting storytellers:', error);
            }
        }

        async function exportStories(format) {
            try {
                const response = await fetch(`/api/stories/export/${format}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(currentStoryFilters)
                });

                if (format === 'json') {
                    const data = await response.json();
                    downloadJSON(data, 'stories.json');
                } else {
                    const csv = await response.text();
                    downloadCSV(csv, 'stories.csv');
                }
            } catch (error) {
                console.error('Error exporting stories:', error);
            }
        }

        function downloadJSON(data, filename) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        async function refreshQualityAnalysis() {
            document.getElementById('quality-dashboard').classList.add('loading');
            document.getElementById('quality-dashboard').innerHTML = 'Refreshing quality analysis...';
            await loadQualityDashboard();
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initDataTools);
    </script>
</body>
</html>