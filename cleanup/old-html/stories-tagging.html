<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stories & Project Tagging - ACT Placemat</title>
    <link rel="stylesheet" href="modern-styles.css">
    <style>
        .tagging-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-6);
            padding: var(--space-6);
            min-height: 100vh;
        }

        .stories-panel, .projects-panel {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            border: 1px solid var(--gray-200);
        }

        .story-card, .project-card {
            background: var(--background);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
            padding: var(--space-4);
            margin-bottom: var(--space-4);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .story-card:hover, .project-card:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-sm);
        }

        .story-card.selected, .project-card.selected {
            border-color: var(--primary);
            background: var(--primary-50);
        }

        .story-header, .project-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-2);
        }

        .story-title, .project-title {
            font-weight: var(--font-semibold);
            color: var(--text-primary);
            font-size: var(--text-base);
        }

        .story-meta, .project-meta {
            font-size: var(--text-sm);
            color: var(--text-secondary);
        }

        .story-summary, .project-description {
            font-size: var(--text-sm);
            color: var(--text-secondary);
            line-height: 1.5;
            margin-top: var(--space-2);
        }

        .tag-button {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            padding: var(--space-2) var(--space-4);
            font-size: var(--text-sm);
            cursor: pointer;
            transition: background-color var(--transition-fast);
        }

        .tag-button:hover {
            background: var(--primary-600);
        }

        .tag-button:disabled {
            background: var(--gray-300);
            cursor: not-allowed;
        }

        .search-box {
            width: 100%;
            padding: var(--space-3);
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-4);
            font-size: var(--text-sm);
        }

        .linked-items {
            background: var(--success-50);
            border: 1px solid var(--success-200);
            border-radius: var(--radius-md);
            padding: var(--space-3);
            margin-top: var(--space-4);
        }

        .linked-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-2);
            background: white;
            border-radius: var(--radius-sm);
            margin-bottom: var(--space-2);
        }

        .relevance-slider {
            width: 100px;
            margin: 0 var(--space-2);
        }

        .insights-panel {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            border: 1px solid var(--gray-200);
            grid-column: 1 / -1;
            margin-top: var(--space-6);
        }

        .quote-card {
            background: var(--background);
            border-left: 4px solid var(--primary);
            padding: var(--space-4);
            margin-bottom: var(--space-3);
            border-radius: var(--radius-md);
        }

        .quote-text {
            font-style: italic;
            color: var(--text-primary);
            margin-bottom: var(--space-2);
        }

        .quote-attribution {
            font-size: var(--text-sm);
            color: var(--text-secondary);
        }

        .theme-tag {
            display: inline-block;
            background: var(--primary-100);
            color: var(--primary-700);
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-full);
            font-size: var(--text-xs);
            margin-right: var(--space-2);
            margin-bottom: var(--space-1);
        }
    </style>
    <script src="modern-nav.js"></script>
</head>
<body>
    <div class="tagging-container">
        <!-- Stories Panel -->
        <div class="stories-panel">
            <h2>üìö Stories</h2>
            <input type="text" class="search-box" id="story-search" placeholder="Search stories...">
            <div id="stories-list">
                <!-- Stories will be loaded here -->
            </div>
        </div>

        <!-- Projects Panel -->
        <div class="projects-panel">
            <h2>üó∫Ô∏è Projects</h2>
            <input type="text" class="search-box" id="project-search" placeholder="Search projects...">
            <div id="projects-list">
                <!-- Projects will be loaded here -->
            </div>
            
            <!-- Tagging Controls -->
            <div id="tagging-controls" class="hidden" style="margin-top: var(--space-6); padding-top: var(--space-6); border-top: 1px solid var(--gray-200);">
                <h3>üîó Link Selected Story & Project</h3>
                <div style="margin-bottom: var(--space-4);">
                    <label>Relevance Score: <span id="relevance-value">5</span>/10</label>
                    <input type="range" class="relevance-slider" id="relevance-slider" min="1" max="10" value="5">
                </div>
                <textarea id="tag-reason" placeholder="Why are these linked? (optional)" style="width: 100%; height: 60px; margin-bottom: var(--space-4);"></textarea>
                <button class="tag-button" id="create-link-btn">Create Link</button>
            </div>
        </div>

        <!-- Project Insights Panel -->
        <div class="insights-panel hidden" id="insights-panel">
            <h2>üìä Project Story Insights</h2>
            <div id="insights-content">
                <!-- Insights will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        let allStories = [];
        let allProjects = [];
        let selectedStory = null;
        let selectedProject = null;

        async function initTaggingPage() {
            try {
                await Promise.all([
                    loadStories(),
                    loadProjects()
                ]);
                setupEventListeners();
            } catch (error) {
                console.error('Failed to initialize tagging page:', error);
            }
        }

        async function loadStories() {
            try {
                console.log('üìö Loading stories from Supabase...');
                const response = await fetch('/api/stories');
                const data = await response.json();
                
                allStories = data.stories || [];
                renderStories(allStories);
                console.log(`‚úÖ Loaded ${allStories.length} stories`);
            } catch (error) {
                console.error('Error loading stories:', error);
                document.getElementById('stories-list').innerHTML = '<p>Error loading stories</p>';
            }
        }

        async function loadProjects() {
            try {
                console.log('üó∫Ô∏è Loading projects from Notion...');
                const response = await fetch('/api/notion/real-projects');
                const data = await response.json();
                
                allProjects = data.projects || [];
                renderProjects(allProjects);
                console.log(`‚úÖ Loaded ${allProjects.length} projects`);
            } catch (error) {
                console.error('Error loading projects:', error);
                document.getElementById('projects-list').innerHTML = '<p>Error loading projects</p>';
            }
        }

        function renderStories(stories) {
            const container = document.getElementById('stories-list');
            container.innerHTML = stories.map(story => `
                <div class="story-card" onclick="selectStory('${story.id}')">
                    <div class="story-header">
                        <div class="story-title">${story.title || 'Untitled Story'}</div>
                        <div class="story-meta">${story.story_date || 'No date'}</div>
                    </div>
                    <div class="story-meta">
                        üë§ ${story.storyteller_name || 'Unknown'} 
                        ${story.storyteller_organisation ? `‚Ä¢ üè¢ ${story.storyteller_organisation}` : ''}
                    </div>
                    <div class="story-summary">${(story.summary || story.content || 'No summary available').substring(0, 150)}...</div>
                    ${story.themes ? `<div style="margin-top: var(--space-2);">${story.themes.map(theme => `<span class="theme-tag">${theme}</span>`).join('')}</div>` : ''}
                </div>
            `).join('');
        }

        function renderProjects(projects) {
            const container = document.getElementById('projects-list');
            container.innerHTML = projects.map(project => `
                <div class="project-card" onclick="selectProject('${project.id}')">
                    <div class="project-header">
                        <div class="project-title">${project.name}</div>
                        <div class="project-meta">${project.status || 'Unknown'}</div>
                    </div>
                    <div class="project-meta">
                        üìç ${project.location || project.area || 'Unknown location'}
                        ${project.funding ? `‚Ä¢ üí∞ ${project.funding}` : ''}
                    </div>
                    <div class="project-description">${(project.description || project.aiSummary || 'No description available').substring(0, 150)}...</div>
                </div>
            `).join('');
        }

        function selectStory(storyId) {
            selectedStory = allStories.find(s => s.id === storyId);
            
            // Update UI
            document.querySelectorAll('.story-card').forEach(card => card.classList.remove('selected'));
            event.target.closest('.story-card').classList.add('selected');
            
            updateTaggingControls();
            console.log('Selected story:', selectedStory?.title);
        }

        function selectProject(projectId) {
            selectedProject = allProjects.find(p => p.id === projectId);
            
            // Update UI
            document.querySelectorAll('.project-card').forEach(card => card.classList.remove('selected'));
            event.target.closest('.project-card').classList.add('selected');
            
            updateTaggingControls();
            loadProjectInsights(projectId);
            console.log('Selected project:', selectedProject?.name);
        }

        function updateTaggingControls() {
            const controls = document.getElementById('tagging-controls');
            if (selectedStory && selectedProject) {
                controls.classList.remove('hidden');
            } else {
                controls.classList.add('hidden');
            }
        }

        async function createLink() {
            if (!selectedStory || !selectedProject) {
                alert('Please select both a story and a project');
                return;
            }

            try {
                const relevanceScore = document.getElementById('relevance-slider').value;
                const reason = document.getElementById('tag-reason').value;

                const response = await fetch(`/api/stories/${selectedStory.id}/link-project`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        projectId: selectedProject.id,
                        relevanceScore: parseInt(relevanceScore),
                        reason: reason
                    })
                });

                if (response.ok) {
                    alert(`‚úÖ Linked "${selectedStory.title}" to "${selectedProject.name}"`);
                    // Clear selections
                    selectedStory = null;
                    selectedProject = null;
                    document.querySelectorAll('.story-card, .project-card').forEach(card => card.classList.remove('selected'));
                    updateTaggingControls();
                    
                    // Refresh insights if project was selected
                    if (selectedProject) {
                        loadProjectInsights(selectedProject.id);
                    }
                } else {
                    throw new Error('Failed to create link');
                }
            } catch (error) {
                console.error('Error creating link:', error);
                alert('‚ùå Failed to create link');
            }
        }

        async function loadProjectInsights(projectId) {
            try {
                const response = await fetch(`/api/projects/${projectId}/stories`);
                const data = await response.json();
                
                const panel = document.getElementById('insights-panel');
                const content = document.getElementById('insights-content');
                
                if (data.insights.totalStories > 0) {
                    content.innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-4); margin-bottom: var(--space-6);">
                            <div style="text-align: center;">
                                <div style="font-size: var(--text-2xl); font-weight: var(--font-bold); color: var(--primary);">${data.insights.totalStories}</div>
                                <div style="color: var(--text-secondary);">Stories</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: var(--text-2xl); font-weight: var(--font-bold); color: var(--primary);">${data.insights.storytellers.length}</div>
                                <div style="color: var(--text-secondary);">Storytellers</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: var(--text-2xl); font-weight: var(--font-bold); color: var(--primary);">${data.insights.quotes.length}</div>
                                <div style="color: var(--text-secondary);">Quotes</div>
                            </div>
                        </div>
                        
                        ${data.insights.quotes.length > 0 ? `
                            <h3>üí¨ Key Quotes</h3>
                            ${data.insights.quotes.slice(0, 3).map(quote => `
                                <div class="quote-card">
                                    <div class="quote-text">"${quote.text}"</div>
                                    <div class="quote-attribution">‚Äî ${quote.speaker}${quote.organisation ? `, ${quote.organisation}` : ''}</div>
                                </div>
                            `).join('')}
                        ` : ''}
                        
                        ${data.insights.themes.length > 0 ? `
                            <h3>üè∑Ô∏è Common Themes</h3>
                            <div>${data.insights.themes.map(theme => `<span class="theme-tag">${theme.theme} (${theme.count})</span>`).join('')}</div>
                        ` : ''}
                    `;
                    panel.classList.remove('hidden');
                } else {
                    content.innerHTML = '<p>No stories linked to this project yet.</p>';
                    panel.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error loading project insights:', error);
            }
        }

        function setupEventListeners() {
            // Search functionality
            document.getElementById('story-search').addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase();
                const filtered = allStories.filter(story => 
                    (story.title || '').toLowerCase().includes(query) ||
                    (story.summary || '').toLowerCase().includes(query) ||
                    (story.storyteller_name || '').toLowerCase().includes(query)
                );
                renderStories(filtered);
            });

            document.getElementById('project-search').addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase();
                const filtered = allProjects.filter(project => 
                    (project.name || '').toLowerCase().includes(query) ||
                    (project.description || '').toLowerCase().includes(query) ||
                    (project.location || '').toLowerCase().includes(query)
                );
                renderProjects(filtered);
            });

            // Relevance slider
            document.getElementById('relevance-slider').addEventListener('input', (e) => {
                document.getElementById('relevance-value').textContent = e.target.value;
            });

            // Link button
            document.getElementById('create-link-btn').addEventListener('click', createLink);
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initTaggingPage);
    </script>
</body>
</html>