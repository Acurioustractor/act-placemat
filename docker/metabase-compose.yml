version: '3.8'

services:
  metabase:
    image: metabase/metabase:latest
    container_name: act-metabase
    environment:
      # Use H2 file database for Metabase app database (simplest setup)
      # We'll configure data connections separately through the API
      MB_DB_TYPE: h2
      MB_DB_FILE: /metabase-data/metabase.db
      
      # Metabase configuration
      MB_JETTY_HOST: 0.0.0.0
      MB_JETTY_PORT: 3000
      
      # Enable advanced features
      MB_ENABLE_EMBEDDING: true
      MB_EMBEDDING_SECRET_KEY: ${MB_EMBEDDING_SECRET_KEY:-change-this-secret-key}
      
      # Email configuration for sharing (optional)
      MB_EMAIL_SMTP_HOST: ${SMTP_HOST:-}
      MB_EMAIL_SMTP_PORT: ${SMTP_PORT:-587}
      MB_EMAIL_SMTP_USERNAME: ${SMTP_USER:-}
      MB_EMAIL_SMTP_PASSWORD: ${SMTP_PASS:-}
      MB_EMAIL_FROM_ADDRESS: ${ALERT_EMAIL:-}
      
      # Security
      MB_PASSWORD_COMPLEXITY: strong
      MB_PASSWORD_LENGTH: 8
      
      # Logging
      MB_LOG_LEVEL: INFO
      
      # Performance
      JAVA_OPTS: "-Xmx2g -XX:+UseG1GC"
      
    ports:
      - "${METABASE_PORT:-3001}:3000"
    
    volumes:
      # Persistent storage for Metabase application data
      - metabase-data:/metabase-data
      # Mount configuration files
      - ./metabase/config:/metabase/config:ro
      
    restart: unless-stopped
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    
    # Network configuration
    networks:
      - metabase-network
      
    # Resource limits
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1.0'
        reservations:
          memory: 1G
          cpus: '0.5'

  # Optional: PostgreSQL service for Metabase metadata (if not using existing Supabase)
  metabase-db:
    image: postgres:15-alpine
    container_name: act-metabase-db
    environment:
      POSTGRES_DB: metabase
      POSTGRES_USER: metabase
      POSTGRES_PASSWORD: ${METABASE_DB_PASS:-metabase_password}
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8"
    volumes:
      - metabase-postgres-data:/var/lib/postgresql/data
      # Custom initialization scripts
      - ./metabase/init:/docker-entrypoint-initdb.d:ro
    ports:
      - "${METABASE_DB_PORT:-5433}:5432"
    restart: unless-stopped
    networks:
      - metabase-network
    profiles:
      - standalone  # Only start if using standalone mode
    
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U metabase -d metabase"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Redis for caching (optional but recommended for performance)
  metabase-cache:
    image: redis:7-alpine
    container_name: act-metabase-cache
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - metabase-redis-data:/data
    ports:
      - "${METABASE_REDIS_PORT:-6380}:6379"
    restart: unless-stopped
    networks:
      - metabase-network
    profiles:
      - cache
    
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  metabase-data:
    driver: local
  metabase-postgres-data:
    driver: local
  metabase-redis-data:
    driver: local

networks:
  metabase-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/16