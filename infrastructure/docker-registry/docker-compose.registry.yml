# Docker Registry for ACT Placemat Intelligence Hub
# Australian-compliant artifact registry with secure storage and access control

version: '3.8'

services:
  # Docker Registry with Australian compliance
  registry:
    image: registry:2.8
    container_name: act-docker-registry
    restart: unless-stopped
    environment:
      - TZ=Australia/Sydney
      - REGISTRY_STORAGE_FILESYSTEM_ROOTDIRECTORY=/var/lib/registry
      - REGISTRY_AUTH=htpasswd
      - REGISTRY_AUTH_HTPASSWD_REALM=ACT-Placemat-Registry
      - REGISTRY_AUTH_HTPASSWD_PATH=/auth/htpasswd
      - REGISTRY_HTTP_TLS_CERTIFICATE=/certs/registry.crt
      - REGISTRY_HTTP_TLS_KEY=/certs/registry.key
      - REGISTRY_HTTP_ADDR=0.0.0.0:5000
      - REGISTRY_HTTP_HOST=https://registry.actplacemat.org.au:5000
      - REGISTRY_LOG_LEVEL=info
      - REGISTRY_LOG_FORMATTER=json
      # Australian compliance settings
      - REGISTRY_STORAGE_REDIRECT_DISABLE=true
      - REGISTRY_HEALTH_STORAGEDRIVER_ENABLED=true
      - REGISTRY_COMPATIBILITY_SCHEMA1_ENABLED=false
    ports:
      - "5000:5000"
    volumes:
      - registry-data:/var/lib/registry
      - ./certs:/certs:ro
      - ./auth:/auth:ro
      - ./config:/etc/docker/registry:ro
    networks:
      - registry-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "https://localhost:5000/v2/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.registry.rule=Host(`registry.actplacemat.org.au`)"
      - "traefik.http.routers.registry.tls=true"
      - "traefik.http.services.registry.loadbalancer.server.port=5000"
      - "data-residency=australia"
      - "compliance-framework=australian-privacy-act"
      - "service-type=artifact-registry"

  # Harbor - Enterprise-grade registry with UI and security scanning
  harbor-core:
    image: goharbor/harbor-core:v2.9.0
    container_name: act-harbor-core
    restart: unless-stopped
    environment:
      - TZ=Australia/Sydney
      - CORE_SECRET=${HARBOR_SECRET}
      - JOBSERVICE_SECRET=${HARBOR_SECRET}
      - EXT_ENDPOINT=https://harbor.actplacemat.org.au
      - DATABASE_TYPE=postgresql
      - DATABASE_HOST=postgres
      - DATABASE_PORT=5432
      - DATABASE_USERNAME=harbor
      - DATABASE_PASSWORD=${HARBOR_DB_PASSWORD}
      - DATABASE_DATABASE=harbor
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      # Australian compliance
      - LOG_LEVEL=info
      - CONFIG_PATH=/etc/core/app.conf
      - SYNC_REGISTRY=false
      - CHART_CACHE_DRIVER=redis
      - _REDIS_URL_CORE=redis://redis:6379/1?password=${REDIS_PASSWORD}
      - _REDIS_URL_REG=redis://redis:6379/2?password=${REDIS_PASSWORD}
      - PORTAL_URL=https://harbor.actplacemat.org.au
      - REGISTRY_URL=http://registry:5000
      - TOKEN_SERVICE_URL=http://harbor-core:8080/service/token
      - ADMIRAL_URL=
      - WITH_NOTARY=false
      - WITH_TRIVY=true
      - WITH_CHARTMUSEUM=false
    ports:
      - "8080:8080"
    volumes:
      - harbor-config:/etc/core
      - harbor-data:/data
      - ./harbor/config:/etc/core:ro
    depends_on:
      - postgres
      - redis
      - registry
    networks:
      - registry-network
      - database-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/v2.0/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    labels:
      - "data-residency=australia"
      - "compliance-framework=australian-privacy-act"
      - "service-type=harbor-core"

  # Harbor Job Service for background tasks
  harbor-jobservice:
    image: goharbor/harbor-jobservice:v2.9.0
    container_name: act-harbor-jobservice
    restart: unless-stopped
    environment:
      - TZ=Australia/Sydney
      - CORE_SECRET=${HARBOR_SECRET}
      - JOBSERVICE_SECRET=${HARBOR_SECRET}
      - CORE_URL=http://harbor-core:8080
      - REGISTRY_URL=http://registry:5000
      - _REDIS_URL_REG=redis://redis:6379/2?password=${REDIS_PASSWORD}
      - LOG_LEVEL=info
      # Australian compliance job configurations
      - JOBSERVICE_WEBHOOK_JOB_MAX_RETRY=3
      - JOBSERVICE_WEBHOOK_JOB_HTTP_CLIENT_TIMEOUT=30
    volumes:
      - harbor-jobservice:/var/log/jobs
      - ./harbor/jobservice:/etc/jobservice:ro
    depends_on:
      - harbor-core
      - redis
    networks:
      - registry-network
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    labels:
      - "data-residency=australia"
      - "service-type=harbor-jobservice"

  # Harbor Registry Proxy
  harbor-registryctl:
    image: goharbor/harbor-registryctl:v2.9.0
    container_name: act-harbor-registryctl
    restart: unless-stopped
    environment:
      - TZ=Australia/Sydney
      - CORE_SECRET=${HARBOR_SECRET}
      - JOBSERVICE_SECRET=${HARBOR_SECRET}
      - LOG_LEVEL=info
    volumes:
      - registry-data:/storage:ro
      - ./harbor/registryctl:/etc/registryctl:ro
    depends_on:
      - harbor-core
    networks:
      - registry-network
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    labels:
      - "data-residency=australia"
      - "service-type=harbor-registryctl"

  # Trivy Scanner for vulnerability scanning
  trivy:
    image: aquasec/trivy:latest
    container_name: act-trivy-scanner
    restart: unless-stopped
    environment:
      - TZ=Australia/Sydney
      - TRIVY_LISTEN=0.0.0.0:8080
      - TRIVY_CACHE_DIR=/cache
      - TRIVY_DEBUG=false
      - TRIVY_TIMEOUT=5m
      # Australian compliance scanning
      - TRIVY_SEVERITY=UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL
      - TRIVY_SKIP_UPDATE=false
      - TRIVY_NO_PROGRESS=true
    ports:
      - "8082:8080"
    volumes:
      - trivy-cache:/cache
    networks:
      - registry-network
    command: ["server", "--cache-dir", "/cache", "--listen", "0.0.0.0:8080"]
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    labels:
      - "data-residency=australia"
      - "service-type=vulnerability-scanner"

  # Registry UI for management
  registry-ui:
    image: joxit/docker-registry-ui:latest
    container_name: act-registry-ui
    restart: unless-stopped
    environment:
      - TZ=Australia/Sydney
      - SINGLE_REGISTRY=true
      - REGISTRY_TITLE=ACT Placemat Intelligence Hub Registry
      - DELETE_IMAGES=true
      - SHOW_CONTENT_DIGEST=true
      - NGINX_PROXY_PASS_URL=http://registry:5000
      - SHOW_CATALOG_NB_TAGS=true
      - CATALOG_MIN_BRANCHES=1
      - CATALOG_MAX_BRANCHES=1
      - TAGLIST_PAGE_SIZE=100
      - REGISTRY_SECURED=true
      - CATALOG_ELEMENTS_LIMIT=1000
      # Australian branding
      - REGISTRY_URL=http://registry:5000
      - NGINX_PROXY_HEADER_Authorization=Basic ${REGISTRY_AUTH_TOKEN}
    ports:
      - "8081:80"
    depends_on:
      - registry
    networks:
      - registry-network
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    labels:
      - "data-residency=australia"
      - "service-type=registry-ui"

  # NGINX for registry proxy and load balancing
  registry-nginx:
    image: nginx:alpine
    container_name: act-registry-nginx
    restart: unless-stopped
    environment:
      - TZ=Australia/Sydney
    ports:
      - "443:443"
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./certs:/etc/nginx/ssl:ro
      - registry-nginx-cache:/var/cache/nginx
      - registry-nginx-logs:/var/log/nginx
    depends_on:
      - registry
      - harbor-core
      - registry-ui
    networks:
      - registry-network
      - web-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    labels:
      - "data-residency=australia"
      - "service-type=registry-proxy"

# Networks with Australian compliance
networks:
  # Registry internal network
  registry-network:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: act-registry-br
    ipam:
      config:
        - subnet: 172.21.1.0/24
          gateway: 172.21.1.1
    labels:
      - "purpose=registry-internal"
      - "security-zone=registry"
      - "data-residency=australia"

  # Web-facing network
  web-network:
    external: true
    name: act-placemat_web-network

  # Database network
  database-network:
    external: true
    name: act-placemat_database-network

# Persistent volumes with Australian data residency
volumes:
  # Registry storage
  registry-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/act-placemat/registry/data
    labels:
      - "data-residency=australia"
      - "backup-required=true"
      - "encryption-required=true"
      - "retention-period=indefinite"

  # Harbor data
  harbor-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/act-placemat/harbor/data
    labels:
      - "data-residency=australia"
      - "backup-required=true"
      - "encryption-required=true"

  harbor-config:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/act-placemat/harbor/config
    labels:
      - "data-residency=australia"
      - "backup-required=true"

  harbor-jobservice:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/act-placemat/harbor/jobservice
    labels:
      - "data-residency=australia"
      - "retention-period=90d"

  # Trivy cache
  trivy-cache:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/act-placemat/trivy/cache
    labels:
      - "data-residency=australia"
      - "temporary=true"

  # NGINX cache and logs
  registry-nginx-cache:
    driver: local
    labels:
      - "data-residency=australia"
      - "temporary=true"

  registry-nginx-logs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/act-placemat/logs/registry-nginx
    labels:
      - "data-residency=australia"
      - "retention-period=90d"