# Canary Deployment Monitoring Dashboard
# Provides real-time visibility into canary deployment health and cultural protocol compliance

apiVersion: v1
kind: ConfigMap
metadata:
  name: canary-dashboard-config
  namespace: monitoring
  labels:
    app: grafana
    dashboard: canary-deployment
data:
  canary-dashboard.json: |
    {
      "dashboard": {
        "id": null,
        "title": "ACT Placemat - Canary Deployment Monitor",
        "tags": ["act-placemat", "canary", "cultural-protocol"],
        "style": "dark",
        "timezone": "browser",
        "refresh": "10s",
        "time": {
          "from": "now-1h",
          "to": "now"
        },
        "panels": [
          {
            "id": 1,
            "title": "Canary Deployment Overview",
            "type": "stat",
            "gridPos": {"h": 4, "w": 24, "x": 0, "y": 0},
            "targets": [
              {
                "expr": "kube_deployment_status_replicas{deployment=\"act-placemat-canary\"}",
                "legendFormat": "Canary Replicas",
                "refId": "A"
              },
              {
                "expr": "kube_deployment_status_replicas{deployment=\"act-placemat-stable\"}",
                "legendFormat": "Stable Replicas",
                "refId": "B"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "color": {"mode": "palette-classic"},
                "mappings": [],
                "thresholds": {
                  "steps": [
                    {"color": "green", "value": null},
                    {"color": "red", "value": 0}
                  ]
                }
              }
            }
          },
          {
            "id": 2,
            "title": "Traffic Split Distribution",
            "type": "piechart",
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 4},
            "targets": [
              {
                "expr": "sum(rate(nginx_ingress_controller_requests{service=\"act-placemat-canary\"}[2m]))",
                "legendFormat": "Canary Traffic",
                "refId": "A"
              },
              {
                "expr": "sum(rate(nginx_ingress_controller_requests{service=\"act-placemat-stable\"}[2m]))",
                "legendFormat": "Stable Traffic",
                "refId": "B"
              }
            ],
            "options": {
              "pieType": "pie",
              "legend": {"displayMode": "table"}
            }
          },
          {
            "id": 3,
            "title": "Cultural Protocol Compliance Score",
            "type": "gauge",
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 4},
            "targets": [
              {
                "expr": "(sum(rate(cultural_protocol_events_total{service=\"act-placemat\",status=\"approved\"}[5m])) / sum(rate(cultural_protocol_events_total{service=\"act-placemat\"}[5m]))) * 100",
                "legendFormat": "Compliance %",
                "refId": "A"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "min": 0,
                "max": 100,
                "thresholds": {
                  "steps": [
                    {"color": "red", "value": 0},
                    {"color": "yellow", "value": 85},
                    {"color": "green", "value": 95}
                  ]
                },
                "unit": "percent"
              }
            },
            "options": {
              "showThresholdLabels": true,
              "showThresholdMarkers": true
            }
          },
          {
            "id": 4,
            "title": "HTTP Request Success Rate",
            "type": "timeseries",
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 12},
            "targets": [
              {
                "expr": "sum(rate(http_requests_total{job=\"act-placemat\",service=\"act-placemat-canary\",code=~\"2..\"}[2m])) / sum(rate(http_requests_total{job=\"act-placemat\",service=\"act-placemat-canary\"}[2m])) * 100",
                "legendFormat": "Canary Success Rate",
                "refId": "A"
              },
              {
                "expr": "sum(rate(http_requests_total{job=\"act-placemat\",service=\"act-placemat-stable\",code=~\"2..\"}[2m])) / sum(rate(http_requests_total{job=\"act-placemat\",service=\"act-placemat-stable\"}[2m])) * 100",
                "legendFormat": "Stable Success Rate",
                "refId": "B"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "min": 90,
                "max": 100,
                "unit": "percent",
                "thresholds": {
                  "steps": [
                    {"color": "red", "value": 0},
                    {"color": "yellow", "value": 95},
                    {"color": "green", "value": 99}
                  ]
                }
              }
            }
          },
          {
            "id": 5,
            "title": "Response Time Comparison (95th Percentile)",
            "type": "timeseries",
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 12},
            "targets": [
              {
                "expr": "histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket{service=\"act-placemat-canary\"}[2m])) by (le)) * 1000",
                "legendFormat": "Canary P95 Response Time",
                "refId": "A"
              },
              {
                "expr": "histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket{service=\"act-placemat-stable\"}[2m])) by (le)) * 1000",
                "legendFormat": "Stable P95 Response Time",
                "refId": "B"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "ms",
                "thresholds": {
                  "steps": [
                    {"color": "green", "value": 0},
                    {"color": "yellow", "value": 500},
                    {"color": "red", "value": 1000}
                  ]
                }
              }
            }
          },
          {
            "id": 6,
            "title": "Elder Consultation Metrics",
            "type": "timeseries",
            "gridPos": {"h": 8, "w": 8, "x": 0, "y": 20},
            "targets": [
              {
                "expr": "sum(rate(elder_consultation_total{status=\"approved\"}[5m]))",
                "legendFormat": "Approved Consultations/min",
                "refId": "A"
              },
              {
                "expr": "sum(rate(elder_consultation_total{status=\"pending\"}[5m]))",
                "legendFormat": "Pending Consultations/min",
                "refId": "B"
              },
              {
                "expr": "sum(rate(elder_consultation_total{status=\"rejected\"}[5m]))",
                "legendFormat": "Rejected Consultations/min",
                "refId": "C"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "reqps"
              }
            }
          },
          {
            "id": 7,
            "title": "Cultural Protocol Violations",
            "type": "stat",
            "gridPos": {"h": 8, "w": 8, "x": 8, "y": 20},
            "targets": [
              {
                "expr": "sum(increase(cultural_protocol_violations_total[10m]))",
                "legendFormat": "Violations (10m)",
                "refId": "A"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "color": {"mode": "thresholds"},
                "thresholds": {
                  "steps": [
                    {"color": "green", "value": 0},
                    {"color": "yellow", "value": 1},
                    {"color": "red", "value": 3}
                  ]
                }
              }
            }
          },
          {
            "id": 8,
            "title": "Deployment Rollout Progress",
            "type": "bargauge",
            "gridPos": {"h": 8, "w": 8, "x": 16, "y": 20},
            "targets": [
              {
                "expr": "argo_rollouts_info{name=\"act-placemat-canary\"}",
                "legendFormat": "{{phase}}",
                "refId": "A"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "min": 0,
                "max": 100,
                "unit": "percent"
              }
            },
            "options": {
              "orientation": "horizontal"
            }
          },
          {
            "id": 9,
            "title": "Community Engagement During Canary",
            "type": "timeseries",
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 28},
            "targets": [
              {
                "expr": "sum(rate(community_interactions_total[5m]))",
                "legendFormat": "Community Interactions/min",
                "refId": "A"
              },
              {
                "expr": "sum(rate(story_creation_total[5m]))",
                "legendFormat": "Stories Created/min",
                "refId": "B"
              },
              {
                "expr": "sum(rate(opportunity_applications_total[5m]))",
                "legendFormat": "Applications Submitted/min",
                "refId": "C"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "reqps"
              }
            }
          },
          {
            "id": 10,
            "title": "Resource Utilization Comparison",
            "type": "timeseries",
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 28},
            "targets": [
              {
                "expr": "sum(rate(container_cpu_usage_seconds_total{pod=~\"act-placemat-canary-.*\"}[2m])) * 100",
                "legendFormat": "Canary CPU Usage %",
                "refId": "A"
              },
              {
                "expr": "sum(rate(container_cpu_usage_seconds_total{pod=~\"act-placemat-stable-.*\"}[2m])) * 100",
                "legendFormat": "Stable CPU Usage %",
                "refId": "B"
              },
              {
                "expr": "sum(container_memory_working_set_bytes{pod=~\"act-placemat-canary-.*\"}) / 1024 / 1024",
                "legendFormat": "Canary Memory (MB)",
                "refId": "C"
              },
              {
                "expr": "sum(container_memory_working_set_bytes{pod=~\"act-placemat-stable-.*\"}) / 1024 / 1024",
                "legendFormat": "Stable Memory (MB)",
                "refId": "D"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "short"
              }
            }
          }
        ],
        "templating": {
          "list": [
            {
              "name": "namespace",
              "type": "query",
              "query": "label_values(kube_deployment_info, namespace)",
              "current": {"text": "act-placemat-production", "value": "act-placemat-production"}
            },
            {
              "name": "deployment",
              "type": "query",
              "query": "label_values(kube_deployment_info{namespace=\"$namespace\"}, deployment)",
              "current": {"text": "All", "value": "$__all"}
            }
          ]
        },
        "annotations": {
          "list": [
            {
              "name": "Rollout Events",
              "datasource": "Prometheus",
              "expr": "changes(argo_rollouts_info{name=\"act-placemat-canary\"}[1m])",
              "textFormat": "Rollout phase changed to {{phase}}",
              "iconColor": "blue"
            },
            {
              "name": "Cultural Protocol Violations",
              "datasource": "Prometheus", 
              "expr": "increase(cultural_protocol_violations_total[1m]) > 0",
              "textFormat": "Cultural protocol violation detected",
              "iconColor": "red"
            }
          ]
        }
      }
    }

---
# Prometheus Rules for Canary Deployment Alerting
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: canary-deployment-alerts
  namespace: monitoring
  labels:
    app: prometheus
    component: rules
spec:
  groups:
  - name: canary-deployment
    interval: 30s
    rules:
    - alert: CanaryDeploymentHighErrorRate
      expr: |
        (
          sum(rate(http_requests_total{service="act-placemat-canary",code=~"5.."}[2m])) /
          sum(rate(http_requests_total{service="act-placemat-canary"}[2m]))
        ) > 0.01
      for: 2m
      labels:
        severity: critical
        component: canary-deployment
      annotations:
        summary: "Canary deployment has high error rate"
        description: "Canary deployment error rate is {{ $value | humanizePercentage }} for more than 2 minutes"
    
    - alert: CanaryDeploymentCulturalViolation
      expr: |
        increase(cultural_protocol_violations_total{service="act-placemat-canary"}[5m]) > 0
      for: 0s
      labels:
        severity: critical
        component: cultural-protocol
      annotations:
        summary: "Cultural protocol violation in canary deployment"
        description: "{{ $value }} cultural protocol violations detected in canary deployment"
    
    - alert: CanaryDeploymentLowCulturalCompliance
      expr: |
        (
          sum(rate(cultural_protocol_events_total{service="act-placemat-canary",status="approved"}[5m])) /
          sum(rate(cultural_protocol_events_total{service="act-placemat-canary"}[5m]))
        ) < 0.90
      for: 5m
      labels:
        severity: warning
        component: cultural-protocol
      annotations:
        summary: "Low cultural compliance in canary deployment"
        description: "Cultural compliance rate is {{ $value | humanizePercentage }} in canary deployment"
    
    - alert: CanaryDeploymentHighResponseTime
      expr: |
        histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket{service="act-placemat-canary"}[2m])) by (le)) > 1.0
      for: 3m
      labels:
        severity: warning
        component: performance
      annotations:
        summary: "High response time in canary deployment"
        description: "95th percentile response time is {{ $value }}s in canary deployment"
    
    - alert: CanaryDeploymentElderApprovalMissing
      expr: |
        argo_rollouts_info{name="act-placemat-canary",phase="Paused"} == 1 and
        on() kube_deployment_metadata_resource_version{deployment="act-placemat-canary"} 
        unless on() kube_deployment_metadata_annotation{deployment="act-placemat-canary",annotation="cultural.act.place/elder-approved",value="true"}
      for: 10m
      labels:
        severity: warning
        component: elder-approval
      annotations:
        summary: "Elder approval missing for canary deployment"
        description: "Canary deployment requires Elder Council approval to proceed"

---
# Alert Manager Configuration for Canary Deployment
apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-canary-config
  namespace: monitoring
data:
  alertmanager.yml: |
    global:
      resolve_timeout: 5m
    
    route:
      group_by: ['alertname', 'component']
      group_wait: 10s
      group_interval: 10s
      repeat_interval: 1h
      receiver: 'default'
      routes:
      - match:
          component: cultural-protocol
        receiver: 'cultural-advisory-team'
        group_wait: 0s
        repeat_interval: 5m
      - match:
          component: elder-approval
        receiver: 'elder-council'
        group_wait: 0s
        repeat_interval: 30m
      - match:
          severity: critical
        receiver: 'emergency-response'
        group_wait: 0s
    
    receivers:
    - name: 'default'
      webhook_configs:
      - url: 'http://act-placemat-webhook:8080/alerts'
        send_resolved: true
    
    - name: 'cultural-advisory-team'
      slack_configs:
      - api_url: '{{ .SlackWebhookURL }}'
        channel: '#cultural-protocol-alerts'
        title: 'Cultural Protocol Alert - {{ .GroupLabels.alertname }}'
        text: '{{ range .Alerts }}{{ .Annotations.description }}{{ end }}'
        color: 'danger'
      webhook_configs:
      - url: 'http://cultural-protocol-service:8080/alerts'
        send_resolved: true
    
    - name: 'elder-council'
      email_configs:
      - to: 'elder-council@act.place'
        from: 'system-alerts@act.place'
        subject: 'Elder Approval Required - Canary Deployment'
        body: |
          The canary deployment for ACT Placemat requires Elder Council approval to proceed.
          
          Please review the deployment at: https://act.place/admin/elder-council/approvals
          
          {{ range .Alerts }}
          {{ .Annotations.description }}
          {{ end }}
    
    - name: 'emergency-response'
      pagerduty_configs:
      - routing_key: '{{ .PagerDutyIntegrationKey }}'
        description: 'Critical Alert: {{ .GroupLabels.alertname }}'
      slack_configs:
      - api_url: '{{ .SlackWebhookURL }}'
        channel: '#emergency-response'
        title: 'CRITICAL: {{ .GroupLabels.alertname }}'
        text: '{{ range .Alerts }}{{ .Annotations.description }}{{ end }}'
        color: 'danger'