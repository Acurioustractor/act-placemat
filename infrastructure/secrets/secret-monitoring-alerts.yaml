# Secret Access Monitoring and Alerts for ACT Placemat Intelligence Hub
# Comprehensive monitoring for secret access patterns and security events

---
# Secret Access Monitoring Configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: secret-monitoring-config
  namespace: act-placemat
  labels:
    component: secret-monitoring
    data-residency: australia
  annotations:
    description: "Configuration for secret access monitoring and alerting"
    compliance.framework: "australian-privacy-act"
data:
  monitoring_config: |
    # Monitoring targets
    monitoring_targets:
      secret_access_patterns:
        - "secret_manager_access_total"
        - "secret_manager_access_duration_seconds"
        - "secret_manager_access_failures_total"
        - "workload_identity_token_requests_total"
        - "workload_identity_token_failures_total"
        - "kubernetes_secret_access_total"
        - "external_secret_sync_total"
        - "external_secret_sync_failures_total"
      
      security_events:
        - "unauthorized_secret_access_attempts_total"
        - "secret_rotation_events_total"
        - "secret_lifecycle_violations_total"
        - "compliance_violations_total"
        - "suspicious_access_patterns_total"
      
      operational_metrics:
        - "secret_age_days"
        - "secret_rotation_overdue_total"
        - "secret_health_check_failures_total"
        - "secret_backup_status"

  # Alert thresholds
  alert_thresholds: |
    critical_alerts:
      unauthorized_access: "1/5m"
      secret_access_failure_rate: "10/5m"
      compliance_violations: "1/1h"
      secret_rotation_overdue: "1/1d"
      
    warning_alerts:
      high_access_rate: "100/5m"
      unusual_access_pattern: "50/1h" 
      secret_near_expiry: "7d"
      backup_failures: "3/1h"
      
    info_alerts:
      secret_rotated: "1/event"
      new_secret_created: "1/event"
      lifecycle_stage_change: "1/event"

  # Australian compliance monitoring
  compliance_monitoring: |
    privacy_act_requirements:
      audit_logging: "comprehensive"
      data_residency_enforcement: "strict"
      access_pattern_analysis: "enabled"
      retention_compliance: "7_years"
      
    security_controls:
      multi_factor_detection: "enabled"
      privilege_escalation_detection: "enabled"
      anomaly_detection: "enabled"
      threat_intelligence: "enabled"
      
    reporting:
      daily_access_summary: "enabled"
      weekly_compliance_report: "enabled"
      monthly_security_assessment: "enabled"
      quarterly_audit_report: "enabled"

---
# Secret Access Monitoring Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: secret-access-monitor
  namespace: act-placemat
  labels:
    component: secret-monitoring
    data-residency: australia
  annotations:
    description: "Secret access monitoring and alerting service"
    compliance.framework: "australian-privacy-act"
spec:
  replicas: 2
  selector:
    matchLabels:
      component: secret-access-monitor
      data-residency: australia
  template:
    metadata:
      labels:
        component: secret-access-monitor
        data-residency: australia
      annotations:
        compliance.framework: "australian-privacy-act"
        data.classification: "restricted"
        audit.required: "true"
    spec:
      serviceAccountName: secret-monitoring-service
      securityContext:
        runAsNonRoot: true
        runAsUser: 1001
        fsGroup: 1001
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: "kubernetes.io/zone"
                operator: In
                values:
                - "australia-southeast1-a"
                - "australia-southeast1-b"
                - "australia-southeast1-c"
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchLabels:
                  component: secret-access-monitor
              topologyKey: kubernetes.io/hostname
      containers:
      - name: access-monitor
        image: registry.actplacemat.org.au:5000/act-placemat/secret-access-monitor:latest
        imagePullPolicy: Always
        env:
        - name: TZ
          value: "Australia/Sydney"
        - name: DATA_RESIDENCY
          value: "australia"
        - name: COMPLIANCE_FRAMEWORK
          value: "australian-privacy-act"
        - name: PROJECT_ID
          value: "act-placemat-intelligence-hub"
        - name: REGION
          value: "australia-southeast1"
        - name: MONITORING_INTERVAL
          value: "30s"
        - name: ALERT_WEBHOOK_URL
          valueFrom:
            secretKeyRef:
              name: monitoring-credentials
              key: alert-webhook-url
        ports:
        - name: metrics
          containerPort: 8080
          protocol: TCP
        - name: health
          containerPort: 8081
          protocol: TCP
        livenessProbe:
          httpGet:
            path: /health
            port: health
          initialDelaySeconds: 30
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /ready
            port: health
          initialDelaySeconds: 5
          periodSeconds: 10
        resources:
          limits:
            cpu: 500m
            memory: 1Gi
          requests:
            cpu: 200m
            memory: 512Mi
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          runAsNonRoot: true
          runAsUser: 1001
          capabilities:
            drop:
            - ALL
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: config
          mountPath: /etc/monitoring-config
          readOnly: true
        - name: gcp-credentials
          mountPath: /var/secrets/google
          readOnly: true
      volumes:
      - name: tmp
        emptyDir: {}
      - name: config
        configMap:
          name: secret-monitoring-config
      - name: gcp-credentials
        secret:
          secretName: secret-monitoring-service-gcp-credentials
      imagePullSecrets:
      - name: registry-credentials
      nodeSelector:
        data-residency: australia

---
# Secret Monitoring Service Account
apiVersion: v1
kind: ServiceAccount
metadata:
  name: secret-monitoring-service
  namespace: act-placemat
  labels:
    component: secret-monitoring
    data-residency: australia
  annotations:
    description: "Service account for secret access monitoring"
    compliance.framework: "australian-privacy-act"
    iam.gke.io/gcp-service-account: "secret-monitoring-service@act-placemat-intelligence-hub.iam.gserviceaccount.com"
    data.classification: "restricted"
    audit.required: "true"
automountServiceAccountToken: true

---
# Secret Monitoring RBAC Role
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: secret-monitoring-service
  labels:
    component: secret-monitoring
    data-residency: australia
  annotations:
    description: "Role for secret access monitoring operations"
    compliance.framework: "australian-privacy-act"
rules:
# Read access for monitoring
- apiGroups: [""]
  resources: ["events", "pods", "services", "secrets", "configmaps"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["apps"]
  resources: ["deployments", "replicasets", "daemonsets", "statefulsets"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["external-secrets.io"]
  resources: ["externalsecrets", "secretstores"]
  verbs: ["get", "list", "watch"]
# Event creation for monitoring alerts
- apiGroups: [""]
  resources: ["events"]
  verbs: ["create", "patch"]
# ConfigMap creation for reports
- apiGroups: [""]
  resources: ["configmaps"]
  verbs: ["create", "update", "patch"]
  resourceNames: ["monitoring-report-*", "alert-log-*", "security-event-*"]

---
# Secret Monitoring ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: secret-monitoring-service-binding
  labels:
    component: secret-monitoring
    data-residency: australia
  annotations:
    description: "Binds secret-monitoring-service to monitoring role"
    compliance.framework: "australian-privacy-act"
subjects:
- kind: ServiceAccount
  name: secret-monitoring-service
  namespace: act-placemat
roleRef:
  kind: ClusterRole
  name: secret-monitoring-service
  apiGroup: rbac.authorization.k8s.io

---
# Secret Monitoring Service
apiVersion: v1
kind: Service
metadata:
  name: secret-access-monitor-metrics
  namespace: act-placemat
  labels:
    component: secret-monitoring
    data-residency: australia
  annotations:
    description: "Metrics service for secret access monitoring"
    compliance.framework: "australian-privacy-act"
spec:
  selector:
    component: secret-access-monitor
    data-residency: australia
  ports:
  - name: metrics
    port: 8080
    targetPort: metrics
    protocol: TCP
  - name: health
    port: 8081
    targetPort: health
    protocol: TCP
  type: ClusterIP

---
# Secret Monitoring ServiceMonitor
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: secret-access-monitoring
  namespace: act-placemat
  labels:
    component: secret-monitoring
    data-residency: australia
  annotations:
    description: "Monitoring for secret access patterns"
    compliance.framework: "australian-privacy-act"
spec:
  selector:
    matchLabels:
      component: secret-monitoring
  endpoints:
  - port: metrics
    interval: 30s
    path: /metrics
    honorLabels: true
    relabelings:
    - sourceLabels: [__meta_kubernetes_pod_label_data_residency]
      targetLabel: data_residency
    - sourceLabels: [__meta_kubernetes_pod_annotation_compliance_framework]
      targetLabel: compliance_framework

---
# Secret Access Alert Rules
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: secret-access-alerts
  namespace: act-placemat
  labels:
    component: secret-monitoring
    data-residency: australia
  annotations:
    description: "Alert rules for secret access monitoring"
    compliance.framework: "australian-privacy-act"
spec:
  groups:
  - name: secret-access-security
    rules:
    - alert: UnauthorizedSecretAccess
      expr: increase(unauthorized_secret_access_attempts_total[5m]) > 0
      for: 0m
      labels:
        severity: critical
        component: secret-monitoring
        data_residency: australia
        compliance_violation: "true"
      annotations:
        summary: "Unauthorized secret access detected"
        description: "{{ $value }} unauthorized secret access attempts in the last 5 minutes"
        remediation: "Investigate access logs and revoke compromised credentials"
        
    - alert: SecretAccessFailureSpike
      expr: rate(secret_manager_access_failures_total[5m]) > 0.1
      for: 2m
      labels:
        severity: warning
        component: secret-monitoring
        data_residency: australia
      annotations:
        summary: "High secret access failure rate"
        description: "Secret access failure rate is {{ $value }} failures per second"
        
    - alert: SuspiciousAccessPattern
      expr: increase(suspicious_access_patterns_total[1h]) > 0
      for: 0m
      labels:
        severity: warning
        component: secret-monitoring
        data_residency: australia
      annotations:
        summary: "Suspicious secret access pattern detected"
        description: "{{ $value }} suspicious access patterns detected in the last hour"
        
    - alert: ComplianceViolationDetected
      expr: increase(compliance_violations_total[1h]) > 0
      for: 0m
      labels:
        severity: critical
        component: secret-monitoring
        data_residency: australia
        compliance_violation: "true"
      annotations:
        summary: "Australian compliance violation in secret access"
        description: "{{ $value }} compliance violations detected in secret access patterns"

  - name: secret-lifecycle-alerts
    rules:
    - alert: SecretRotationOverdue
      expr: secret_age_days > 90
      for: 1h
      labels:
        severity: warning
        component: secret-monitoring
        data_residency: australia
      annotations:
        summary: "Secret rotation overdue"
        description: "Secret {{ $labels.secret_name }} is {{ $value }} days old and overdue for rotation"
        
    - alert: SecretRotationFailed
      expr: increase(secret_rotation_failures_total[1h]) > 0
      for: 0m
      labels:
        severity: critical
        component: secret-monitoring
        data_residency: australia
      annotations:
        summary: "Secret rotation failed"
        description: "{{ $value }} secret rotation failures in the last hour"
        
    - alert: SecretHealthCheckFailed
      expr: increase(secret_health_check_failures_total[15m]) > 0
      for: 0m
      labels:
        severity: warning
        component: secret-monitoring
        data_residency: australia
      annotations:
        summary: "Secret health check failed"
        description: "{{ $value }} secret health check failures in the last 15 minutes"

  - name: workload-identity-alerts
    rules:
    - alert: WorkloadIdentityAuthFailure
      expr: increase(workload_identity_token_failures_total[5m]) > 5
      for: 1m
      labels:
        severity: warning
        component: secret-monitoring
        data_residency: australia
      annotations:
        summary: "High Workload Identity authentication failures"
        description: "{{ $value }} WIF authentication failures in the last 5 minutes"
        
    - alert: UnusualTokenRequestRate
      expr: rate(workload_identity_token_requests_total[5m]) > 2
      for: 10m
      labels:
        severity: info
        component: secret-monitoring
        data_residency: australia
      annotations:
        summary: "Unusual Workload Identity token request rate"
        description: "WIF token request rate is {{ $value }} requests per second"

  - name: secret-monitoring-health
    rules:
    - alert: SecretMonitoringDown
      expr: up{job="secret-access-monitor-metrics"} == 0
      for: 5m
      labels:
        severity: critical
        component: secret-monitoring
        data_residency: australia
      annotations:
        summary: "Secret access monitoring is down"
        description: "Secret access monitoring service has been down for more than 5 minutes"
        
    - alert: ExternalSecretSyncFailure
      expr: increase(external_secret_sync_failures_total[30m]) > 0
      for: 0m
      labels:
        severity: warning
        component: secret-monitoring
        data_residency: australia
      annotations:
        summary: "External secret sync failure"
        description: "{{ $value }} external secret sync failures in the last 30 minutes"

---
# Secret Access Anomaly Detection CronJob
apiVersion: batch/v1
kind: CronJob
metadata:
  name: secret-access-anomaly-detection
  namespace: act-placemat
  labels:
    component: secret-monitoring
    operation: anomaly-detection
    data-residency: australia
  annotations:
    description: "Analyzes secret access patterns for anomalies"
    compliance.framework: "australian-privacy-act"
spec:
  schedule: "*/30 * * * *"  # Every 30 minutes
  timeZone: "Australia/Sydney"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 24
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            component: secret-anomaly-detection
            data-residency: australia
        spec:
          serviceAccountName: secret-monitoring-service
          restartPolicy: OnFailure
          securityContext:
            runAsNonRoot: true
            runAsUser: 1001
            fsGroup: 1001
          containers:
          - name: anomaly-detector
            image: registry.actplacemat.org.au:5000/act-placemat/secret-anomaly-detector:latest
            imagePullPolicy: Always
            env:
            - name: TZ
              value: "Australia/Sydney"
            - name: DATA_RESIDENCY
              value: "australia"
            - name: COMPLIANCE_FRAMEWORK
              value: "australian-privacy-act"
            - name: PROJECT_ID
              value: "act-placemat-intelligence-hub"
            - name: ANALYSIS_WINDOW
              value: "30m"
            command:
            - /bin/sh
            - -c
            - |
              echo "Starting secret access anomaly detection at $(date)"
              
              # Get current metrics
              CURRENT_TIME=$(date +%s)
              WINDOW_START=$((CURRENT_TIME - 1800))  # 30 minutes ago
              
              # Analyze access patterns
              echo "Analyzing secret access patterns from $(date -d @$WINDOW_START) to $(date -d @$CURRENT_TIME)"
              
              # Query Prometheus for access metrics
              ACCESS_RATE=$(curl -s "http://prometheus:9090/api/v1/query?query=rate(secret_manager_access_total[30m])" | jq -r '.data.result[0].value[1]' 2>/dev/null || echo "0")
              FAILURE_RATE=$(curl -s "http://prometheus:9090/api/v1/query?query=rate(secret_manager_access_failures_total[30m])" | jq -r '.data.result[0].value[1]' 2>/dev/null || echo "0")
              
              echo "Current access rate: $ACCESS_RATE/sec"
              echo "Current failure rate: $FAILURE_RATE/sec"
              
              # Anomaly detection logic
              ANOMALIES_DETECTED=0
              ANOMALY_DETAILS=""
              
              # Check for high access rate anomaly
              if (( $(echo "$ACCESS_RATE > 1.0" | bc -l) )); then
                ANOMALIES_DETECTED=$((ANOMALIES_DETECTED + 1))
                ANOMALY_DETAILS="$ANOMALY_DETAILS High access rate detected: $ACCESS_RATE/sec. "
                
                # Create anomaly event
                kubectl create event secret-access-anomaly-high-rate-$(date +%s) \
                  --message="High secret access rate detected: $ACCESS_RATE/sec (threshold: 1.0/sec)" \
                  --reason="SecretAccessAnomalyDetected" \
                  --type="Warning" \
                  --source="secret-anomaly-detection" \
                  --namespace=act-placemat
              fi
              
              # Check for high failure rate anomaly
              if (( $(echo "$FAILURE_RATE > 0.1" | bc -l) )); then
                ANOMALIES_DETECTED=$((ANOMALIES_DETECTED + 1))
                ANOMALY_DETAILS="$ANOMALY_DETAILS High failure rate detected: $FAILURE_RATE/sec. "
                
                # Create anomaly event
                kubectl create event secret-access-anomaly-high-failures-$(date +%s) \
                  --message="High secret access failure rate detected: $FAILURE_RATE/sec (threshold: 0.1/sec)" \
                  --reason="SecretAccessAnomalyDetected" \
                  --type="Warning" \
                  --source="secret-anomaly-detection" \
                  --namespace=act-placemat
              fi
              
              # Check for unusual access patterns (example: weekend activity)
              HOUR=$(date +%H)
              DAY_OF_WEEK=$(date +%u)  # 1=Monday, 7=Sunday
              
              if [[ $DAY_OF_WEEK -ge 6 ]] && [[ $HOUR -ge 22 || $HOUR -le 6 ]] && (( $(echo "$ACCESS_RATE > 0.1" | bc -l) )); then
                ANOMALIES_DETECTED=$((ANOMALIES_DETECTED + 1))
                ANOMALY_DETAILS="$ANOMALY_DETAILS Unusual weekend/night activity detected. "
                
                # Create anomaly event
                kubectl create event secret-access-anomaly-unusual-timing-$(date +%s) \
                  --message="Unusual secret access timing detected: weekend/night activity with rate $ACCESS_RATE/sec" \
                  --reason="SecretAccessAnomalyDetected" \
                  --type="Warning" \
                  --source="secret-anomaly-detection" \
                  --namespace=act-placemat
              fi
              
              # Generate anomaly report
              cat > /tmp/anomaly-report.json << EOF
              {
                "analysis_time": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
                "analysis_window": "30m",
                "compliance_framework": "Australian Privacy Act 1988",
                "data_residency": "australia",
                "metrics": {
                  "access_rate_per_second": $ACCESS_RATE,
                  "failure_rate_per_second": $FAILURE_RATE,
                  "anomalies_detected": $ANOMALIES_DETECTED
                },
                "anomalies": {
                  "details": "$ANOMALY_DETAILS",
                  "severity": "$([ $ANOMALIES_DETECTED -gt 2 ] && echo "high" || [ $ANOMALIES_DETECTED -gt 0 ] && echo "medium" || echo "low")"
                },
                "next_analysis": "$(date -d '+30 minutes' -u +%Y-%m-%dT%H:%M:%SZ)"
              }
              EOF
              
              # Store anomaly report
              kubectl create configmap secret-anomaly-report-$(date +%Y%m%d-%H%M) \
                --from-file=report.json=/tmp/anomaly-report.json \
                --from-literal="analysis_type=anomaly_detection" \
                --from-literal="compliance_framework=australian-privacy-act" \
                --from-literal="data_residency=australia" \
                --from-literal="anomalies_detected=$ANOMALIES_DETECTED" \
                -n act-placemat --dry-run=client -o yaml | kubectl apply -f -
              
              echo "Anomaly detection completed at $(date)"
              echo "Anomalies detected: $ANOMALIES_DETECTED"
              if [[ $ANOMALIES_DETECTED -gt 0 ]]; then
                echo "Details: $ANOMALY_DETAILS"
              fi
            resources:
              limits:
                cpu: 200m
                memory: 512Mi
              requests:
                cpu: 100m
                memory: 256Mi
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              runAsNonRoot: true
              runAsUser: 1001
              capabilities:
                drop:
                - ALL
            volumeMounts:
            - name: tmp
              mountPath: /tmp
          volumes:
          - name: tmp
            emptyDir: {}
          imagePullSecrets:
          - name: registry-credentials
          nodeSelector:
            data-residency: australia

---
# Secret Monitoring Dashboard ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: secret-monitoring-dashboard
  namespace: act-placemat
  labels:
    component: secret-monitoring
    data-residency: australia
  annotations:
    description: "Grafana dashboard for secret access monitoring"
    compliance.framework: "australian-privacy-act"
data:
  dashboard.json: |
    {
      "dashboard": {
        "title": "ACT Placemat Secret Access Monitoring - Australian Compliance",
        "tags": ["secrets", "security", "compliance", "australian-privacy-act"],
        "timezone": "Australia/Sydney",
        "panels": [
          {
            "title": "Secret Access Rate",
            "type": "stat",
            "targets": [
              {
                "expr": "sum(rate(secret_manager_access_total[5m]))",
                "legendFormat": "Access Rate/sec"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "color": {
                  "mode": "thresholds"
                },
                "thresholds": {
                  "steps": [
                    {"color": "green", "value": null},
                    {"color": "yellow", "value": 1.0},
                    {"color": "red", "value": 2.0}
                  ]
                }
              }
            }
          },
          {
            "title": "Secret Access Failures",
            "type": "graph",
            "targets": [
              {
                "expr": "increase(secret_manager_access_failures_total[1h])",
                "legendFormat": "Access Failures/hour"
              }
            ]
          },
          {
            "title": "Workload Identity Token Requests",
            "type": "graph",
            "targets": [
              {
                "expr": "sum by (service_account) (rate(workload_identity_token_requests_total[5m]))",
                "legendFormat": "{{service_account}}"
              }
            ]
          },
          {
            "title": "Secret Rotation Status",
            "type": "table",
            "targets": [
              {
                "expr": "secret_age_days",
                "legendFormat": "{{secret_name}} ({{secret_category}})"
              }
            ]
          },
          {
            "title": "Compliance Violations",
            "type": "stat",
            "targets": [
              {
                "expr": "sum(compliance_violations_total)",
                "legendFormat": "Total Violations"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "color": {
                  "mode": "thresholds"
                },
                "thresholds": {
                  "steps": [
                    {"color": "green", "value": 0},
                    {"color": "red", "value": 1}
                  ]
                }
              }
            }
          },
          {
            "title": "Anomaly Detection",
            "type": "graph",
            "targets": [
              {
                "expr": "increase(suspicious_access_patterns_total[1h])",
                "legendFormat": "Suspicious Patterns/hour"
              }
            ]
          }
        ],
        "time": {
          "from": "now-1h",
          "to": "now"
        },
        "refresh": "30s"
      }
    }