# Secret Manager Configuration for ACT Placemat Intelligence Hub
# Australian-compliant secret storage with automated rotation and lifecycle management

---
# Secret Manager Configuration ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: secret-manager-config
  namespace: act-placemat
  labels:
    component: secret-management
    data-residency: australia
  annotations:
    description: "Secret Manager configuration for Australian compliance"
    compliance.framework: "australian-privacy-act"
data:
  # Google Secret Manager configuration
  secret_manager_config: |
    project_id: "act-placemat-intelligence-hub"
    region: "australia-southeast1"
    data_residency: "australia"
    
    # Secret categories and policies
    secret_categories:
      api_keys:
        rotation_period: "90d"
        access_policy: "least_privilege"
        encryption: "cmek"
        audit_logging: "comprehensive"
        
      database_credentials:
        rotation_period: "30d"
        access_policy: "service_specific"
        encryption: "cmek"
        audit_logging: "comprehensive"
        
      encryption_keys:
        rotation_period: "30d"
        access_policy: "key_custodian_only"
        encryption: "cmek"
        audit_logging: "comprehensive"
        
      ci_cd_tokens:
        rotation_period: "60d"
        access_policy: "github_actions_only"
        encryption: "cmek"
        audit_logging: "comprehensive"
        
      agent_credentials:
        rotation_period: "90d"
        access_policy: "agent_specific"
        encryption: "cmek"
        audit_logging: "comprehensive"

  # Secret naming convention
  secret_naming: |
    # Naming convention: {category}-{environment}-{service}-{purpose}
    # Examples:
    # - apikey-prod-financial-intelligence-asic
    # - dbcred-prod-langgraph-state-postgres
    # - enckey-prod-cmek-financial-data
    # - cicd-prod-github-actions-registry-push
    # - agentcred-prod-research-analyst-notion

  # Access policies
  access_policies: |
    # Least privilege access for different service accounts
    api_keys_access:
      - service_account: "financial-intelligence-agent@act-placemat-intelligence-hub.iam.gserviceaccount.com"
        secrets: ["apikey-prod-financial-*"]
        
      - service_account: "research-analyst-agent@act-placemat-intelligence-hub.iam.gserviceaccount.com"
        secrets: ["apikey-prod-research-*"]
        
      - service_account: "compliance-officer-agent@act-placemat-intelligence-hub.iam.gserviceaccount.com"
        secrets: ["apikey-prod-compliance-*"]
        
      - service_account: "community-coordinator-agent@act-placemat-intelligence-hub.iam.gserviceaccount.com"
        secrets: ["apikey-prod-community-*"]

    database_access:
      - service_account: "langgraph-orchestrator@act-placemat-intelligence-hub.iam.gserviceaccount.com"
        secrets: ["dbcred-prod-langgraph-*", "dbcred-prod-postgres-*"]
        
      - service_account: "backup-recovery@act-placemat-intelligence-hub.iam.gserviceaccount.com"
        secrets: ["dbcred-prod-backup-*"]

    encryption_key_access:
      - service_account: "cmek-key-manager@act-placemat-intelligence-hub.iam.gserviceaccount.com"
        secrets: ["enckey-prod-cmek-*"]
        
      - service_account: "key-rotation-service@act-placemat-intelligence-hub.iam.gserviceaccount.com"
        secrets: ["enckey-prod-rotation-*"]

  # Australian compliance requirements
  australian_compliance: |
    # Privacy Act 1988 requirements
    data_sovereignty:
      storage_location: "australia-southeast1"
      backup_location: "australia-southeast2"
      no_cross_border_transfer: true
      
    encryption_requirements:
      encryption_at_rest: "CMEK"
      encryption_in_transit: "TLS_1_3"
      key_management: "customer_managed"
      
    audit_requirements:
      access_logging: "comprehensive"
      retention_period: "7_years"
      real_time_monitoring: true
      
    compliance_validation:
      regular_audits: "weekly"
      penetration_testing: "quarterly"
      vulnerability_scanning: "continuous"

---
# Secret Manager Service Account
apiVersion: v1
kind: ServiceAccount
metadata:
  name: secret-manager-operator
  namespace: act-placemat
  labels:
    component: secret-management
    role: operator
    data-residency: australia
  annotations:
    description: "Service account for Secret Manager operations"
    compliance.framework: "australian-privacy-act"
    iam.gke.io/gcp-service-account: "secret-manager-operator@act-placemat-intelligence-hub.iam.gserviceaccount.com"
    data.classification: "restricted"
    audit.required: "true"
automountServiceAccountToken: true

---
# Secret Manager RBAC Role
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: secret-manager-operator
  namespace: act-placemat
  labels:
    component: secret-management
    data-residency: australia
  annotations:
    description: "Role for Secret Manager operations"
    compliance.framework: "australian-privacy-act"
rules:
# Secret management operations
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get", "list", "watch", "create", "update", "patch"]
  resourceNames: ["secret-manager-*", "external-secret-*"]
# ConfigMap access for configuration
- apiGroups: [""]
  resources: ["configmaps"]
  verbs: ["get", "list", "watch"]
  resourceNames: ["secret-manager-config", "secret-rotation-schedule"]
# Event logging
- apiGroups: [""]
  resources: ["events"]
  verbs: ["create", "patch"]
# External Secret Operator integration
- apiGroups: ["external-secrets.io"]
  resources: ["externalsecrets", "secretstores", "clustersecretstores"]
  verbs: ["get", "list", "watch", "create", "update", "patch"]

---
# Secret Manager Role Binding
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: secret-manager-operator-binding
  namespace: act-placemat
  labels:
    component: secret-management
    data-residency: australia
  annotations:
    description: "Binds secret-manager-operator to secret management role"
    compliance.framework: "australian-privacy-act"
subjects:
- kind: ServiceAccount
  name: secret-manager-operator
  namespace: act-placemat
roleRef:
  kind: Role
  name: secret-manager-operator
  apiGroup: rbac.authorization.k8s.io

---
# Secret Store Configuration for External Secrets Operator
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: google-secret-manager
  namespace: act-placemat
  labels:
    component: secret-management
    data-residency: australia
  annotations:
    description: "Secret store configuration for Google Secret Manager"
    compliance.framework: "australian-privacy-act"
spec:
  provider:
    gcpsm:
      projectId: "act-placemat-intelligence-hub"
      auth:
        workloadIdentity:
          clusterLocation: australia-southeast1
          clusterName: act-placemat-intelligence-hub
          serviceAccountRef:
            name: secret-manager-operator

---
# External Secret for API Keys
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: agent-api-keys
  namespace: act-placemat
  labels:
    component: secret-management
    secret-category: api-keys
    data-residency: australia
  annotations:
    description: "External secret for agent API keys"
    compliance.framework: "australian-privacy-act"
    data.classification: "confidential"
    rotation.period: "90d"
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: google-secret-manager
    kind: SecretStore
  target:
    name: agent-api-keys
    creationPolicy: Owner
    template:
      type: Opaque
      metadata:
        labels:
          data-residency: australia
          compliance.framework: australian-privacy-act
          secret-category: api-keys
        annotations:
          last-rotated: "{{ .lastRotated }}"
          next-rotation: "{{ .nextRotation }}"
  data:
  - secretKey: openai-api-key
    remoteRef:
      key: apikey-prod-openai-primary
  - secretKey: anthropic-api-key
    remoteRef:
      key: apikey-prod-anthropic-primary
  - secretKey: perplexity-api-key
    remoteRef:
      key: apikey-prod-perplexity-research
  - secretKey: asic-api-key
    remoteRef:
      key: apikey-prod-financial-intelligence-asic
  - secretKey: abn-lookup-key
    remoteRef:
      key: apikey-prod-financial-intelligence-abn
  - secretKey: xero-credentials
    remoteRef:
      key: apikey-prod-financial-intelligence-xero
  - secretKey: notion-token
    remoteRef:
      key: apikey-prod-research-analyst-notion

---
# External Secret for Database Credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: database-credentials
  namespace: act-placemat
  labels:
    component: secret-management
    secret-category: database
    data-residency: australia
  annotations:
    description: "External secret for database credentials"
    compliance.framework: "australian-privacy-act"
    data.classification: "confidential"
    rotation.period: "30d"
spec:
  refreshInterval: 30m
  secretStoreRef:
    name: google-secret-manager
    kind: SecretStore
  target:
    name: database-credentials
    creationPolicy: Owner
    template:
      type: Opaque
      metadata:
        labels:
          data-residency: australia
          compliance.framework: australian-privacy-act
          secret-category: database
        annotations:
          last-rotated: "{{ .lastRotated }}"
          next-rotation: "{{ .nextRotation }}"
  data:
  - secretKey: postgres-username
    remoteRef:
      key: dbcred-prod-postgres-username
  - secretKey: postgres-password
    remoteRef:
      key: dbcred-prod-postgres-password
  - secretKey: redis-password
    remoteRef:
      key: dbcred-prod-redis-password
  - secretKey: langgraph-state-db-password
    remoteRef:
      key: dbcred-prod-langgraph-state-password
  - secretKey: langgraph-checkpoint-db-password
    remoteRef:
      key: dbcred-prod-langgraph-checkpoint-password

---
# External Secret for Encryption Keys
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: encryption-keys
  namespace: act-placemat
  labels:
    component: secret-management
    secret-category: encryption
    data-residency: australia
  annotations:
    description: "External secret for encryption keys"
    compliance.framework: "australian-privacy-act"
    data.classification: "restricted"
    rotation.period: "30d"
spec:
  refreshInterval: 15m
  secretStoreRef:
    name: google-secret-manager
    kind: SecretStore
  target:
    name: encryption-keys
    creationPolicy: Owner
    template:
      type: Opaque
      metadata:
        labels:
          data-residency: australia
          compliance.framework: australian-privacy-act
          secret-category: encryption
        annotations:
          last-rotated: "{{ .lastRotated }}"
          next-rotation: "{{ .nextRotation }}"
  data:
  - secretKey: langgraph-state-encryption-key
    remoteRef:
      key: enckey-prod-langgraph-state
  - secretKey: langgraph-checkpoint-encryption-key
    remoteRef:
      key: enckey-prod-langgraph-checkpoint
  - secretKey: agent-communication-key
    remoteRef:
      key: enckey-prod-agent-communication
  - secretKey: financial-data-encryption-key
    remoteRef:
      key: enckey-prod-financial-data
  - secretKey: compliance-audit-encryption-key
    remoteRef:
      key: enckey-prod-compliance-audit
  - secretKey: backup-encryption-key
    remoteRef:
      key: enckey-prod-backup-archive

---
# External Secret for Registry Credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: registry-credentials
  namespace: act-placemat
  labels:
    component: secret-management
    secret-category: registry
    data-residency: australia
  annotations:
    description: "External secret for container registry credentials"
    compliance.framework: "australian-privacy-act"
    data.classification: "confidential"
    rotation.period: "60d"
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: google-secret-manager
    kind: SecretStore
  target:
    name: registry-credentials
    creationPolicy: Owner
    template:
      type: kubernetes.io/dockerconfigjson
      metadata:
        labels:
          data-residency: australia
          compliance.framework: australian-privacy-act
          secret-category: registry
        annotations:
          last-rotated: "{{ .lastRotated }}"
          next-rotation: "{{ .nextRotation }}"
      data:
        .dockerconfigjson: |
          {
            "auths": {
              "registry.actplacemat.org.au:5000": {
                "username": "{{ .registry_username }}",
                "password": "{{ .registry_password }}",
                "auth": "{{ .registry_auth }}"
              },
              "harbor.actplacemat.org.au": {
                "username": "{{ .harbor_username }}",
                "password": "{{ .harbor_password }}",
                "auth": "{{ .harbor_auth }}"
              }
            }
          }
  dataFrom:
  - extract:
      key: registry-credentials-prod

---
# Secret Rotation CronJob
apiVersion: batch/v1
kind: CronJob
metadata:
  name: secret-rotation-monitor
  namespace: act-placemat
  labels:
    component: secret-management
    operation: rotation-monitor
    data-residency: australia
  annotations:
    description: "Monitors and triggers secret rotation as needed"
    compliance.framework: "australian-privacy-act"
spec:
  schedule: "0 3 * * *"  # Daily at 3 AM AEDT
  timeZone: "Australia/Sydney"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 7
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            component: secret-rotation-monitor
            data-residency: australia
        spec:
          serviceAccountName: secret-manager-operator
          restartPolicy: OnFailure
          securityContext:
            runAsNonRoot: true
            runAsUser: 1001
            fsGroup: 1001
          containers:
          - name: rotation-monitor
            image: registry.actplacemat.org.au:5000/act-placemat/secret-rotation-monitor:latest
            imagePullPolicy: Always
            env:
            - name: TZ
              value: "Australia/Sydney"
            - name: DATA_RESIDENCY
              value: "australia"
            - name: COMPLIANCE_FRAMEWORK
              value: "australian-privacy-act"
            - name: PROJECT_ID
              value: "act-placemat-intelligence-hub"
            - name: REGION
              value: "australia-southeast1"
            command:
            - /bin/sh
            - -c
            - |
              echo "Starting secret rotation monitoring at $(date)"
              
              # Function to check secret age
              check_secret_age() {
                local secret_name=$1
                local rotation_period_days=$2
                
                # Get secret last rotation time
                LAST_ROTATION=$(gcloud secrets versions list $secret_name --limit=1 --format="value(createTime)" --project=act-placemat-intelligence-hub 2>/dev/null || echo "")
                
                if [ -z "$LAST_ROTATION" ]; then
                  echo "Warning: Could not get last rotation time for $secret_name"
                  return 1
                fi
                
                # Calculate age in days
                CURRENT_TIME=$(date +%s)
                ROTATION_TIME=$(date -d "$LAST_ROTATION" +%s)
                AGE_SECONDS=$((CURRENT_TIME - ROTATION_TIME))
                AGE_DAYS=$((AGE_SECONDS / 86400))
                
                echo "Secret $secret_name is $AGE_DAYS days old (rotation period: $rotation_period_days days)"
                
                if [ $AGE_DAYS -gt $rotation_period_days ]; then
                  echo "Secret $secret_name requires rotation"
                  
                  # Create rotation event
                  kubectl create event secret-rotation-required-$secret_name-$(date +%s) \
                    --message="Secret $secret_name is $AGE_DAYS days old and requires rotation (period: $rotation_period_days days)" \
                    --reason="SecretRotationRequired" \
                    --type="Warning" \
                    --source="secret-rotation-monitor" \
                    --namespace=act-placemat
                    
                  return 0
                else
                  echo "Secret $secret_name rotation not required"
                  return 1
                fi
              }
              
              # Check API key secrets (90-day rotation)
              ROTATION_REQUIRED=0
              
              echo "Checking API key secrets..."
              for secret in apikey-prod-openai-primary apikey-prod-anthropic-primary apikey-prod-perplexity-research; do
                if check_secret_age $secret 90; then
                  ROTATION_REQUIRED=1
                fi
              done
              
              echo "Checking database credential secrets..."
              for secret in dbcred-prod-postgres-password dbcred-prod-redis-password; do
                if check_secret_age $secret 30; then
                  ROTATION_REQUIRED=1
                fi
              done
              
              echo "Checking encryption key secrets..."
              for secret in enckey-prod-langgraph-state enckey-prod-langgraph-checkpoint; do
                if check_secret_age $secret 30; then
                  ROTATION_REQUIRED=1
                fi
              done
              
              echo "Checking registry credential secrets..."
              for secret in registry-credentials-prod; do
                if check_secret_age $secret 60; then
                  ROTATION_REQUIRED=1
                fi
              done
              
              # Generate rotation report
              cat > /tmp/rotation-report.json << EOF
              {
                "monitoring_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
                "timezone": "Australia/Sydney",
                "compliance_framework": "Australian Privacy Act 1988",
                "data_residency": "australia",
                "rotation_required": $ROTATION_REQUIRED,
                "secrets_checked": [
                  "apikey-prod-openai-primary",
                  "apikey-prod-anthropic-primary", 
                  "apikey-prod-perplexity-research",
                  "dbcred-prod-postgres-password",
                  "dbcred-prod-redis-password",
                  "enckey-prod-langgraph-state",
                  "enckey-prod-langgraph-checkpoint",
                  "registry-credentials-prod"
                ],
                "next_check": "$(date -d '+1 day' -u +%Y-%m-%dT%H:%M:%SZ)"
              }
              EOF
              
              # Store rotation monitoring report
              kubectl create configmap secret-rotation-report-$(date +%Y%m%d) \
                --from-file=report.json=/tmp/rotation-report.json \
                --from-literal="monitoring_type=secret_rotation" \
                --from-literal="compliance_framework=australian-privacy-act" \
                --from-literal="data_residency=australia" \
                -n act-placemat --dry-run=client -o yaml | kubectl apply -f -
              
              echo "Secret rotation monitoring completed at $(date)"
            resources:
              limits:
                cpu: 200m
                memory: 512Mi
              requests:
                cpu: 100m
                memory: 256Mi
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              runAsNonRoot: true
              runAsUser: 1001
              capabilities:
                drop:
                - ALL
            volumeMounts:
            - name: tmp
              mountPath: /tmp
            - name: gcp-credentials
              mountPath: /var/secrets/google
              readOnly: true
          volumes:
          - name: tmp
            emptyDir: {}
          - name: gcp-credentials
            secret:
              secretName: secret-manager-operator-gcp-credentials
          imagePullSecrets:
          - name: registry-credentials
          nodeSelector:
            data-residency: australia