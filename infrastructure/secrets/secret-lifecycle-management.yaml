# Secret Lifecycle Management for ACT Placemat Intelligence Hub
# Automated rotation, versioning, and lifecycle management with Australian compliance

---
# Secret Lifecycle Configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: secret-lifecycle-config
  namespace: act-placemat
  labels:
    component: secret-lifecycle
    data-residency: australia
  annotations:
    description: "Secret lifecycle management configuration"
    compliance.framework: "australian-privacy-act"
data:
  lifecycle_policies: |
    # Rotation policies by secret category
    rotation_policies:
      api_keys:
        rotation_interval: "90d"
        grace_period: "24h"
        notification_period: "7d"
        backup_versions: 3
        
      database_credentials:
        rotation_interval: "30d"
        grace_period: "1h"
        notification_period: "3d"
        backup_versions: 5
        
      encryption_keys:
        rotation_interval: "30d"
        grace_period: "30m"
        notification_period: "7d"
        backup_versions: 5
        
      certificates:
        rotation_interval: "365d"
        grace_period: "30d"
        notification_period: "30d"
        backup_versions: 3
        
      registry_credentials:
        rotation_interval: "60d"
        grace_period: "2h"
        notification_period: "7d"
        backup_versions: 3

  # Lifecycle stages
  lifecycle_stages: |
    stages:
      - name: "active"
        description: "Secret is currently in use"
        max_duration: "as_per_rotation_policy"
        
      - name: "grace_period"
        description: "Secret marked for rotation but still valid"
        max_duration: "as_per_grace_period"
        
      - name: "deprecated"
        description: "Secret should not be used for new operations"
        max_duration: "30d"
        
      - name: "revoked"
        description: "Secret is no longer valid"
        max_duration: "0d"
        
      - name: "archived"
        description: "Secret stored for compliance/audit purposes"
        max_duration: "7y"  # Australian Privacy Act requirement

  # Rotation triggers
  rotation_triggers: |
    triggers:
      - type: "scheduled"
        description: "Time-based rotation"
        
      - type: "compromise_suspected"
        description: "Security incident or suspected compromise"
        priority: "immediate"
        
      - type: "policy_change"
        description: "Security policy update requires rotation"
        
      - type: "manual"
        description: "Manually triggered rotation"
        
      - type: "failed_validation"
        description: "Secret failed validation checks"
        priority: "urgent"

  # Australian compliance requirements
  compliance_requirements: |
    privacy_act_1988:
      data_retention: "7_years"
      audit_trail: "comprehensive"
      access_logging: "all_operations"
      encryption_at_rest: "required"
      data_residency: "australia_only"
      
    security_controls:
      multi_factor_authentication: "required_for_manual_operations"
      least_privilege_access: "enforced"
      separation_of_duties: "rotation_approval_required"
      audit_alerts: "real_time"

---
# Secret Lifecycle Manager Service Account
apiVersion: v1
kind: ServiceAccount
metadata:
  name: secret-lifecycle-manager
  namespace: act-placemat
  labels:
    component: secret-lifecycle
    role: manager
    data-residency: australia
  annotations:
    description: "Service account for secret lifecycle management"
    compliance.framework: "australian-privacy-act"
    iam.gke.io/gcp-service-account: "secret-lifecycle-manager@act-placemat-intelligence-hub.iam.gserviceaccount.com"
    data.classification: "restricted"
    audit.required: "true"
automountServiceAccountToken: true

---
# Secret Lifecycle Manager RBAC Role
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: secret-lifecycle-manager
  namespace: act-placemat
  labels:
    component: secret-lifecycle
    data-residency: australia
  annotations:
    description: "Role for secret lifecycle management operations"
    compliance.framework: "australian-privacy-act"
rules:
# Secret management operations
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: ["external-secrets.io"]
  resources: ["externalsecrets", "secretstores"]
  verbs: ["get", "list", "watch", "create", "update", "patch"]
# Configuration and lifecycle state
- apiGroups: [""]
  resources: ["configmaps"]
  verbs: ["get", "list", "watch", "create", "update", "patch"]
  resourceNames: ["secret-lifecycle-*", "rotation-schedule-*", "lifecycle-state-*"]
# Event logging for lifecycle operations
- apiGroups: [""]
  resources: ["events"]
  verbs: ["create", "patch"]
# Job management for rotation operations
- apiGroups: ["batch"]
  resources: ["jobs", "cronjobs"]
  verbs: ["get", "list", "watch", "create", "update", "patch"]

---
# Secret Lifecycle Manager Role Binding
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: secret-lifecycle-manager-binding
  namespace: act-placemat
  labels:
    component: secret-lifecycle
    data-residency: australia
  annotations:
    description: "Binds secret-lifecycle-manager to lifecycle management role"
    compliance.framework: "australian-privacy-act"
subjects:
- kind: ServiceAccount
  name: secret-lifecycle-manager
  namespace: act-placemat
roleRef:
  kind: Role
  name: secret-lifecycle-manager
  apiGroup: rbac.authorization.k8s.io

---
# Secret Rotation Orchestrator CronJob
apiVersion: batch/v1
kind: CronJob
metadata:
  name: secret-rotation-orchestrator
  namespace: act-placemat
  labels:
    component: secret-lifecycle
    operation: rotation-orchestrator
    data-residency: australia
  annotations:
    description: "Orchestrates secret rotation based on lifecycle policies"
    compliance.framework: "australian-privacy-act"
spec:
  schedule: "0 1 * * *"  # Daily at 1 AM AEDT
  timeZone: "Australia/Sydney"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 7
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            component: secret-rotation-orchestrator
            data-residency: australia
        spec:
          serviceAccountName: secret-lifecycle-manager
          restartPolicy: OnFailure
          securityContext:
            runAsNonRoot: true
            runAsUser: 1001
            fsGroup: 1001
          containers:
          - name: rotation-orchestrator
            image: registry.actplacemat.org.au:5000/act-placemat/secret-lifecycle-manager:latest
            imagePullPolicy: Always
            env:
            - name: TZ
              value: "Australia/Sydney"
            - name: DATA_RESIDENCY
              value: "australia"
            - name: COMPLIANCE_FRAMEWORK
              value: "australian-privacy-act"
            - name: PROJECT_ID
              value: "act-placemat-intelligence-hub"
            - name: REGION
              value: "australia-southeast1"
            - name: OPERATION
              value: "rotation_orchestrator"
            command:
            - /bin/sh
            - -c
            - |
              echo "Starting secret rotation orchestration at $(date)"
              
              # Function to check if secret needs rotation
              check_rotation_needed() {
                local secret_name=$1
                local rotation_interval_days=$2
                local grace_period_hours=$3
                
                echo "Checking rotation for secret: $secret_name"
                
                # Get secret metadata from Secret Manager
                SECRET_INFO=$(gcloud secrets describe $secret_name --project=act-placemat-intelligence-hub --format=json 2>/dev/null || echo "{}")
                
                if [ "$SECRET_INFO" = "{}" ]; then
                  echo "Warning: Secret $secret_name not found in Secret Manager"
                  return 1
                fi
                
                # Get latest version creation time
                LATEST_VERSION=$(gcloud secrets versions list $secret_name --limit=1 --format="value(name,createTime)" --project=act-placemat-intelligence-hub 2>/dev/null)
                
                if [ -z "$LATEST_VERSION" ]; then
                  echo "Warning: No versions found for secret $secret_name"
                  return 1
                fi
                
                VERSION_TIME=$(echo "$LATEST_VERSION" | cut -d' ' -f2-)
                CURRENT_TIME=$(date +%s)
                VERSION_TIME_EPOCH=$(date -d "$VERSION_TIME" +%s)
                AGE_SECONDS=$((CURRENT_TIME - VERSION_TIME_EPOCH))
                AGE_DAYS=$((AGE_SECONDS / 86400))
                
                echo "Secret $secret_name age: $AGE_DAYS days (rotation interval: $rotation_interval_days days)"
                
                # Check if rotation is needed
                if [ $AGE_DAYS -ge $rotation_interval_days ]; then
                  echo "✨ Rotation required for $secret_name"
                  
                  # Create rotation job
                  kubectl create job secret-rotation-$secret_name-$(date +%s) \
                    --from=cronjob/secret-rotation-template \
                    --namespace=act-placemat || true
                  
                  # Log rotation trigger event
                  kubectl create event secret-rotation-triggered-$secret_name-$(date +%s) \
                    --message="Secret $secret_name rotation triggered (age: $AGE_DAYS days, limit: $rotation_interval_days days)" \
                    --reason="SecretRotationTriggered" \
                    --type="Normal" \
                    --source="secret-rotation-orchestrator" \
                    --namespace=act-placemat
                    
                  return 0
                else
                  echo "✅ No rotation needed for $secret_name"
                  return 1
                fi
              }
              
              # Function to check secret health
              check_secret_health() {
                local secret_name=$1
                
                echo "Health check for secret: $secret_name"
                
                # Check if secret exists and is accessible
                if gcloud secrets versions access latest --secret="$secret_name" --project=act-placemat-intelligence-hub > /dev/null 2>&1; then
                  echo "✅ Secret $secret_name is healthy"
                  return 0
                else
                  echo "❌ Secret $secret_name health check failed"
                  
                  # Create health check failure event
                  kubectl create event secret-health-check-failed-$secret_name-$(date +%s) \
                    --message="Secret $secret_name failed health check" \
                    --reason="SecretHealthCheckFailed" \
                    --type="Warning" \
                    --source="secret-rotation-orchestrator" \
                    --namespace=act-placemat
                    
                  return 1
                fi
              }
              
              # Initialize rotation tracking
              ROTATIONS_TRIGGERED=0
              HEALTH_FAILURES=0
              
              echo "=== API Keys Rotation Check ==="
              # Check API key secrets (90-day rotation)
              for secret in apikey-prod-openai-primary apikey-prod-anthropic-primary apikey-prod-perplexity-research apikey-prod-financial-intelligence-asic apikey-prod-financial-intelligence-abn apikey-prod-research-analyst-notion; do
                if check_rotation_needed $secret 90 24; then
                  ROTATIONS_TRIGGERED=$((ROTATIONS_TRIGGERED + 1))
                fi
                if ! check_secret_health $secret; then
                  HEALTH_FAILURES=$((HEALTH_FAILURES + 1))
                fi
              done
              
              echo "=== Database Credentials Rotation Check ==="
              # Check database credential secrets (30-day rotation)
              for secret in dbcred-prod-postgres-password dbcred-prod-redis-password dbcred-prod-langgraph-state-password dbcred-prod-langgraph-checkpoint-password; do
                if check_rotation_needed $secret 30 1; then
                  ROTATIONS_TRIGGERED=$((ROTATIONS_TRIGGERED + 1))
                fi
                if ! check_secret_health $secret; then
                  HEALTH_FAILURES=$((HEALTH_FAILURES + 1))
                fi
              done
              
              echo "=== Encryption Keys Rotation Check ==="
              # Check encryption key secrets (30-day rotation)
              for secret in enckey-prod-langgraph-state enckey-prod-langgraph-checkpoint enckey-prod-agent-communication enckey-prod-financial-data enckey-prod-compliance-audit enckey-prod-backup-archive; do
                if check_rotation_needed $secret 30 0.5; then
                  ROTATIONS_TRIGGERED=$((ROTATIONS_TRIGGERED + 1))
                fi
                if ! check_secret_health $secret; then
                  HEALTH_FAILURES=$((HEALTH_FAILURES + 1))
                fi
              done
              
              echo "=== Registry Credentials Rotation Check ==="
              # Check registry credential secrets (60-day rotation)
              for secret in registry-credentials-prod; do
                if check_rotation_needed $secret 60 2; then
                  ROTATIONS_TRIGGERED=$((ROTATIONS_TRIGGERED + 1))
                fi
                if ! check_secret_health $secret; then
                  HEALTH_FAILURES=$((HEALTH_FAILURES + 1))
                fi
              done
              
              # Generate orchestration report
              cat > /tmp/orchestration-report.json << EOF
              {
                "orchestration_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
                "operation": "rotation_orchestration",
                "compliance_framework": "Australian Privacy Act 1988",
                "data_residency": "australia",
                "summary": {
                  "rotations_triggered": $ROTATIONS_TRIGGERED,
                  "health_check_failures": $HEALTH_FAILURES,
                  "secrets_checked": [
                    "apikey-prod-openai-primary",
                    "apikey-prod-anthropic-primary", 
                    "apikey-prod-perplexity-research",
                    "apikey-prod-financial-intelligence-asic",
                    "apikey-prod-financial-intelligence-abn",
                    "apikey-prod-research-analyst-notion",
                    "dbcred-prod-postgres-password",
                    "dbcred-prod-redis-password",
                    "dbcred-prod-langgraph-state-password",
                    "dbcred-prod-langgraph-checkpoint-password",
                    "enckey-prod-langgraph-state",
                    "enckey-prod-langgraph-checkpoint",
                    "enckey-prod-agent-communication",
                    "enckey-prod-financial-data",
                    "enckey-prod-compliance-audit",
                    "enckey-prod-backup-archive",
                    "registry-credentials-prod"
                  ]
                },
                "next_orchestration": "$(date -d '+1 day' -u +%Y-%m-%dT%H:%M:%SZ)"
              }
              EOF
              
              # Store orchestration report
              kubectl create configmap secret-orchestration-report-$(date +%Y%m%d) \
                --from-file=report.json=/tmp/orchestration-report.json \
                --from-literal="operation=rotation_orchestration" \
                --from-literal="compliance_framework=australian-privacy-act" \
                --from-literal="data_residency=australia" \
                --from-literal="rotations_triggered=$ROTATIONS_TRIGGERED" \
                --from-literal="health_failures=$HEALTH_FAILURES" \
                -n act-placemat --dry-run=client -o yaml | kubectl apply -f -
              
              echo "Secret rotation orchestration completed at $(date)"
              echo "Rotations triggered: $ROTATIONS_TRIGGERED"
              echo "Health check failures: $HEALTH_FAILURES"
            resources:
              limits:
                cpu: 300m
                memory: 512Mi
              requests:
                cpu: 150m
                memory: 256Mi
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              runAsNonRoot: true
              runAsUser: 1001
              capabilities:
                drop:
                - ALL
            volumeMounts:
            - name: tmp
              mountPath: /tmp
            - name: gcp-credentials
              mountPath: /var/secrets/google
              readOnly: true
          volumes:
          - name: tmp
            emptyDir: {}
          - name: gcp-credentials
            secret:
              secretName: secret-lifecycle-manager-gcp-credentials
          imagePullSecrets:
          - name: registry-credentials
          nodeSelector:
            data-residency: australia

---
# Secret Rotation Job Template
apiVersion: batch/v1
kind: CronJob
metadata:
  name: secret-rotation-template
  namespace: act-placemat
  labels:
    component: secret-lifecycle
    operation: rotation-template
    data-residency: australia
  annotations:
    description: "Template for individual secret rotation jobs"
    compliance.framework: "australian-privacy-act"
spec:
  schedule: "0 0 1 1 *"  # Never runs automatically - only manually triggered
  suspend: true
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            component: secret-rotation
            data-residency: australia
        spec:
          serviceAccountName: secret-lifecycle-manager
          restartPolicy: Never
          securityContext:
            runAsNonRoot: true
            runAsUser: 1001
            fsGroup: 1001
          containers:
          - name: secret-rotator
            image: registry.actplacemat.org.au:5000/act-placemat/secret-lifecycle-manager:latest
            imagePullPolicy: Always
            env:
            - name: TZ
              value: "Australia/Sydney"
            - name: DATA_RESIDENCY
              value: "australia"
            - name: COMPLIANCE_FRAMEWORK
              value: "australian-privacy-act"
            - name: PROJECT_ID
              value: "act-placemat-intelligence-hub"
            - name: REGION
              value: "australia-southeast1"
            - name: OPERATION
              value: "secret_rotation"
            - name: SECRET_NAME
              value: "REPLACE_WITH_SECRET_NAME"  # Will be set by orchestrator
            command:
            - /bin/sh
            - -c
            - |
              echo "Starting secret rotation for $SECRET_NAME at $(date)"
              
              if [ -z "$SECRET_NAME" ] || [ "$SECRET_NAME" = "REPLACE_WITH_SECRET_NAME" ]; then
                echo "Error: SECRET_NAME not provided"
                exit 1
              fi
              
              # Determine secret category and rotation strategy
              case "$SECRET_NAME" in
                apikey-*)
                  CATEGORY="api_key"
                  GRACE_PERIOD="24h"
                  ;;
                dbcred-*)
                  CATEGORY="database_credential"
                  GRACE_PERIOD="1h"
                  ;;
                enckey-*)
                  CATEGORY="encryption_key"
                  GRACE_PERIOD="30m"
                  ;;
                registry-*)
                  CATEGORY="registry_credential"
                  GRACE_PERIOD="2h"
                  ;;
                *)
                  CATEGORY="unknown"
                  GRACE_PERIOD="1h"
                  ;;
              esac
              
              echo "Rotating $CATEGORY: $SECRET_NAME with grace period: $GRACE_PERIOD"
              
              # Step 1: Generate new secret value
              echo "Step 1: Generating new secret value..."
              
              case "$CATEGORY" in
                api_key)
                  # For API keys, this would typically involve calling the provider's API
                  # For demo purposes, we'll generate a placeholder
                  NEW_SECRET_VALUE="sk-new-$(openssl rand -hex 32)"
                  ;;
                database_credential)
                  # Generate new database password
                  NEW_SECRET_VALUE=$(openssl rand -base64 32 | tr -d "=+/" | cut -c1-25)
                  ;;
                encryption_key)
                  # Generate new encryption key
                  NEW_SECRET_VALUE=$(openssl rand -base64 32)
                  ;;
                registry_credential)
                  # For registry credentials, this would involve calling the registry API
                  NEW_SECRET_VALUE="new-$(openssl rand -hex 16)"
                  ;;
                *)
                  NEW_SECRET_VALUE=$(openssl rand -base64 32)
                  ;;
              esac
              
              # Step 2: Create backup of current secret
              echo "Step 2: Creating backup of current secret..."
              
              CURRENT_SECRET=$(gcloud secrets versions access latest --secret="$SECRET_NAME" --project=act-placemat-intelligence-hub 2>/dev/null || echo "")
              
              if [ -n "$CURRENT_SECRET" ]; then
                # Create backup secret
                BACKUP_SECRET_NAME="$SECRET_NAME-backup-$(date +%Y%m%d-%H%M%S)"
                echo -n "$CURRENT_SECRET" | gcloud secrets create "$BACKUP_SECRET_NAME" \
                  --data-file=- \
                  --locations=australia-southeast1 \
                  --labels="data-residency=australia,compliance-framework=australian-privacy-act,backup-for=$SECRET_NAME,rotation-date=$(date +%Y%m%d)"
                  
                echo "✅ Backup created: $BACKUP_SECRET_NAME"
              else
                echo "Warning: Could not retrieve current secret for backup"
              fi
              
              # Step 3: Create new secret version
              echo "Step 3: Creating new secret version..."
              
              echo -n "$NEW_SECRET_VALUE" | gcloud secrets versions add "$SECRET_NAME" \
                --data-file=- \
                --project=act-placemat-intelligence-hub
                
              echo "✅ New version created for $SECRET_NAME"
              
              # Step 4: Update Kubernetes external secret to refresh
              echo "Step 4: Triggering Kubernetes secret refresh..."
              
              # Trigger external secret refresh by adding annotation
              kubectl annotate externalsecret agent-api-keys force-sync=$(date +%s) -n act-placemat --overwrite 2>/dev/null || true
              kubectl annotate externalsecret database-credentials force-sync=$(date +%s) -n act-placemat --overwrite 2>/dev/null || true
              kubectl annotate externalsecret encryption-keys force-sync=$(date +%s) -n act-placemat --overwrite 2>/dev/null || true
              kubectl annotate externalsecret registry-credentials force-sync=$(date +%s) -n act-placemat --overwrite 2>/dev/null || true
              
              # Step 5: Wait for grace period before marking old version as deprecated
              echo "Step 5: Waiting for grace period ($GRACE_PERIOD)..."
              
              # Convert grace period to seconds for sleep
              case "$GRACE_PERIOD" in
                *h) SLEEP_SECONDS=$((${GRACE_PERIOD%h} * 3600)) ;;
                *m) SLEEP_SECONDS=$((${GRACE_PERIOD%m} * 60)) ;;
                *s) SLEEP_SECONDS=${GRACE_PERIOD%s} ;;
                *) SLEEP_SECONDS=3600 ;;
              esac
              
              # For demo purposes, limit to max 5 minutes
              if [ $SLEEP_SECONDS -gt 300 ]; then
                SLEEP_SECONDS=300
              fi
              
              sleep $SLEEP_SECONDS
              
              # Step 6: Log rotation completion
              echo "Step 6: Logging rotation completion..."
              
              # Create rotation completion event
              kubectl create event secret-rotation-completed-$SECRET_NAME-$(date +%s) \
                --message="Secret $SECRET_NAME rotation completed successfully (category: $CATEGORY)" \
                --reason="SecretRotationCompleted" \
                --type="Normal" \
                --source="secret-rotation-job" \
                --namespace=act-placemat
              
              # Log to Google Cloud Logging
              gcloud logging write secret-rotation-audit \
                '{"action":"secret_rotated","secret_name":"'$SECRET_NAME'","category":"'$CATEGORY'","rotation_date":"$(date -u +%Y-%m-%dT%H:%M:%SZ)","backup_created":"'$BACKUP_SECRET_NAME'","compliance_framework":"australian-privacy-act","data_residency":"australia"}' \
                --severity=INFO
              
              echo "✅ Secret rotation completed successfully for $SECRET_NAME at $(date)"
            resources:
              limits:
                cpu: 200m
                memory: 512Mi
              requests:
                cpu: 100m
                memory: 256Mi
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              runAsNonRoot: true
              runAsUser: 1001
              capabilities:
                drop:
                - ALL
            volumeMounts:
            - name: tmp
              mountPath: /tmp
            - name: gcp-credentials
              mountPath: /var/secrets/google
              readOnly: true
          volumes:
          - name: tmp
            emptyDir: {}
          - name: gcp-credentials
            secret:
              secretName: secret-lifecycle-manager-gcp-credentials
          imagePullSecrets:
          - name: registry-credentials
          nodeSelector:
            data-residency: australia

---
# Secret Lifecycle State Tracker
apiVersion: v1
kind: ConfigMap
metadata:
  name: secret-lifecycle-state
  namespace: act-placemat
  labels:
    component: secret-lifecycle
    data-residency: australia
  annotations:
    description: "Tracks lifecycle state of all managed secrets"
    compliance.framework: "australian-privacy-act"
data:
  lifecycle_state: |
    # Current lifecycle state of managed secrets
    secrets:
      apikey-prod-openai-primary:
        stage: "active"
        last_rotation: "2024-08-15T00:00:00Z"
        next_rotation: "2024-11-13T00:00:00Z"
        category: "api_key"
        
      apikey-prod-anthropic-primary:
        stage: "active"
        last_rotation: "2024-08-15T00:00:00Z"
        next_rotation: "2024-11-13T00:00:00Z"
        category: "api_key"
        
      dbcred-prod-postgres-password:
        stage: "active"
        last_rotation: "2024-08-15T00:00:00Z"
        next_rotation: "2024-09-14T00:00:00Z"
        category: "database_credential"
        
      enckey-prod-langgraph-state:
        stage: "active"
        last_rotation: "2024-08-15T00:00:00Z"
        next_rotation: "2024-09-14T00:00:00Z"
        category: "encryption_key"

  audit_trail: |
    # Audit trail for secret lifecycle operations
    operations:
      - timestamp: "2024-08-15T00:00:00Z"
        operation: "secret_created"
        secret: "apikey-prod-openai-primary"
        operator: "secret-lifecycle-manager"
        compliance_verified: true
        
      - timestamp: "2024-08-15T00:00:00Z"
        operation: "lifecycle_state_initialized"
        secrets_count: 17
        operator: "secret-lifecycle-manager"
        compliance_verified: true