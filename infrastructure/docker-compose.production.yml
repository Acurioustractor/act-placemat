# ACT Community Platform - Production Cloud-Native Architecture
# Auto-scaling infrastructure that maintains performance and community experience
# 
# Philosophy: "Scale with grace, keep the human touch"
# Embodies: Community-First Scaling, Performance Excellence, Human Connection
# 
# Revolutionary Features:
# - Community-aware auto-scaling that preserves intimacy
# - Geographic distribution for global community support
# - Resource isolation per community while enabling collaboration
# - Performance monitoring with community experience focus
# - Disaster recovery with community data sovereignty
# - Multi-region deployment with data residency compliance

version: '3.8'

networks:
  act_production:
    external: true
  act_communities:
    driver: overlay
    attachable: true
  act_secure:
    driver: overlay
    internal: true

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  community_assets:
    driver: local
  story_media:
    driver: local

services:
  # ========================================
  # LOAD BALANCER & REVERSE PROXY
  # ========================================
  
  traefik:
    image: traefik:v3.0
    command:
      - --api.dashboard=true
      - --providers.docker=true
      - --providers.docker.swarmMode=true
      - --providers.docker.exposedbydefault=false
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
      - --certificatesresolvers.letsencrypt.acme.tlschallenge=true
      - --certificatesresolvers.letsencrypt.acme.email=platform@act.place
      - --certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json
      - --metrics.prometheus=true
      - --accesslog=true
      - --log.level=INFO
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080" # Dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik_letsencrypt:/letsencrypt
    networks:
      - act_production
    deploy:
      replicas: 2
      placement:
        constraints:
          - node.role == manager
      labels:
        - traefik.enable=true
        - traefik.http.routers.traefik.rule=Host(`traefik.act.place`)
        - traefik.http.routers.traefik.entrypoints=websecure
        - traefik.http.routers.traefik.tls.certresolver=letsencrypt
        - traefik.http.services.traefik.loadbalancer.server.port=8080

  # ========================================
  # APPLICATION SERVICES - AUTO SCALING
  # ========================================
  
  frontend:
    image: act-placemat/frontend:latest
    environment:
      - NODE_ENV=production
      - REACT_APP_API_URL=https://api.act.place
      - REACT_APP_COMMUNITY_CDN=https://cdn.act.place
      - REACT_APP_SENTRY_DSN=${FRONTEND_SENTRY_DSN}
    networks:
      - act_production
      - act_communities
    deploy:
      replicas: 3
      update_config:
        parallelism: 1
        delay: 30s
        failure_action: rollback
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'
      labels:
        - traefik.enable=true
        - traefik.http.routers.frontend.rule=Host(`act.place`) || Host(`www.act.place`)
        - traefik.http.routers.frontend.entrypoints=websecure
        - traefik.http.routers.frontend.tls.certresolver=letsencrypt
        - traefik.http.services.frontend.loadbalancer.server.port=3000
        - traefik.http.routers.frontend.middlewares=gzip-compress,security-headers
        - traefik.http.middlewares.gzip-compress.compress=true
        - traefik.http.middlewares.security-headers.headers.customrequestheaders.X-Community-Platform=ACT-Placemat

  backend:
    image: act-placemat/backend:latest
    environment:
      - NODE_ENV=production
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - JWT_SECRET=${JWT_SECRET}
      - NOTION_API_KEY=${NOTION_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - PERPLEXITY_API_KEY=${PERPLEXITY_API_KEY}
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_REGION=${AWS_REGION}
      - COMMUNITY_SCALING_MODE=auto
      - MAX_COMMUNITIES_PER_INSTANCE=50
      - ENABLE_MULTI_TENANT_ISOLATION=true
      - SENTRY_DSN=${BACKEND_SENTRY_DSN}
    networks:
      - act_production
      - act_communities
      - act_secure
    deploy:
      replicas: 4
      update_config:
        parallelism: 2
        delay: 30s
        failure_action: rollback
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 3
      resources:
        limits:
          memory: 1G
          cpus: '1'
        reservations:
          memory: 512M
          cpus: '0.5'
      labels:
        - traefik.enable=true
        - traefik.http.routers.backend.rule=Host(`api.act.place`)
        - traefik.http.routers.backend.entrypoints=websecure
        - traefik.http.routers.backend.tls.certresolver=letsencrypt
        - traefik.http.services.backend.loadbalancer.server.port=3001
        - traefik.http.routers.backend.middlewares=api-auth,rate-limit
        - traefik.http.middlewares.api-auth.forwardauth.address=http://auth-service:3002/verify

  # ========================================
  # COMMUNITY-AWARE SCALING SERVICES
  # ========================================
  
  community-scaling-manager:
    image: act-placemat/community-scaling:latest
    environment:
      - NODE_ENV=production
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - DOCKER_HOST=unix:///var/run/docker.sock
      - SCALING_STRATEGY=community_aware
      - MIN_REPLICAS_PER_SERVICE=2
      - MAX_REPLICAS_PER_SERVICE=20
      - COMMUNITY_INTIMACY_THRESHOLD=150 # Max members before considering scaling
      - PERFORMANCE_MONITORING_INTERVAL=30s
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - act_production
      - act_secure
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      restart_policy:
        condition: on-failure
        delay: 30s
        max_attempts: 3
      resources:
        limits:
          memory: 512M
          cpus: '0.5'

  performance-monitor:
    image: act-placemat/performance-monitor:latest
    environment:
      - NODE_ENV=production
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - PROMETHEUS_URL=http://prometheus:9090
      - COMMUNITY_EXPERIENCE_THRESHOLD=2000 # 2 second response time max
      - STORY_LOAD_TIME_THRESHOLD=1000 # 1 second for story loading
      - NOTIFICATION_WEBHOOK=${SLACK_WEBHOOK_URL}
    networks:
      - act_production
      - act_communities
      - act_secure
    deploy:
      replicas: 2
      restart_policy:
        condition: on-failure
        delay: 15s
        max_attempts: 3

  # ========================================
  # DATA LAYER - HIGH AVAILABILITY
  # ========================================
  
  postgres-primary:
    image: postgres:15-alpine
    environment:
      - POSTGRES_DB=act_placemat_production
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_REPLICATION_USER=${POSTGRES_REPLICATION_USER}
      - POSTGRES_REPLICATION_PASSWORD=${POSTGRES_REPLICATION_PASSWORD}
      - PGUSER=${POSTGRES_USER}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./database/multi-tenant-row-level-security.sql:/docker-entrypoint-initdb.d/01-multi-tenant-rls.sql
      - ./database/production-optimizations.sql:/docker-entrypoint-initdb.d/02-production-optimizations.sql
    networks:
      - act_secure
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.labels.database == primary
      restart_policy:
        condition: on-failure
        delay: 30s
        max_attempts: 3
      resources:
        limits:
          memory: 4G
          cpus: '2'
        reservations:
          memory: 2G
          cpus: '1'
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d act_placemat_production"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  postgres-replica:
    image: postgres:15-alpine
    environment:
      - PGUSER=postgres
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - PGPASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_MASTER_SERVICE=postgres-primary
    command: |
      bash -c "
      pg_basebackup -h postgres-primary -D /var/lib/postgresql/data -U ${POSTGRES_REPLICATION_USER} -v -P -W
      echo 'standby_mode = on' >> /var/lib/postgresql/data/recovery.conf
      echo 'primary_conninfo = ''host=postgres-primary port=5432 user=${POSTGRES_REPLICATION_USER}''' >> /var/lib/postgresql/data/recovery.conf
      postgres
      "
    volumes:
      - postgres_replica_data:/var/lib/postgresql/data
    networks:
      - act_secure
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.labels.database == replica
      restart_policy:
        condition: on-failure
        delay: 30s
        max_attempts: 3

  redis-cluster:
    image: redis:7-alpine
    command: redis-server --cluster-enabled yes --cluster-config-file nodes.conf --cluster-node-timeout 5000 --appendonly yes --maxmemory 1gb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    networks:
      - act_secure
    deploy:
      replicas: 3
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 3
      resources:
        limits:
          memory: 1G
          cpus: '0.5'
        reservations:
          memory: 512M
          cpus: '0.25'

  # ========================================
  # MONITORING & OBSERVABILITY
  # ========================================
  
  prometheus:
    image: prom/prometheus:latest
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=30d'
      - '--web.enable-lifecycle'
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    networks:
      - act_production
      - act_secure
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.labels.monitoring == true
      resources:
        limits:
          memory: 2G
          cpus: '1'

  grafana:
    image: grafana/grafana-oss:latest
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_DOMAIN=monitoring.act.place
      - GF_SERVER_ROOT_URL=https://monitoring.act.place
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards
      - ./monitoring/grafana/datasources:/etc/grafana/provisioning/datasources
    networks:
      - act_production
      - act_secure
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.labels.monitoring == true
      labels:
        - traefik.enable=true
        - traefik.http.routers.grafana.rule=Host(`monitoring.act.place`)
        - traefik.http.routers.grafana.entrypoints=websecure
        - traefik.http.routers.grafana.tls.certresolver=letsencrypt
        - traefik.http.services.grafana.loadbalancer.server.port=3000

  # ========================================
  # COMMUNITY EXPERIENCE SERVICES
  # ========================================
  
  story-processor:
    image: act-placemat/story-processor:latest
    environment:
      - NODE_ENV=production
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - AI_PROCESSING_QUEUE=story_analysis
      - CULTURAL_PROTOCOL_VALIDATION=enabled
      - CONSENT_VERIFICATION_REQUIRED=true
    networks:
      - act_communities
      - act_secure
    deploy:
      replicas: 3
      restart_policy:
        condition: on-failure
        delay: 15s
        max_attempts: 3
      resources:
        limits:
          memory: 1G
          cpus: '1'

  community-insights-engine:
    image: act-placemat/community-insights:latest
    environment:
      - NODE_ENV=production
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - PERPLEXITY_API_KEY=${PERPLEXITY_API_KEY}
      - PRIVACY_PROTECTION_LEVEL=maximum
      - COMMUNITY_BENEFIT_THRESHOLD=0.40
    networks:
      - act_communities
      - act_secure
    deploy:
      replicas: 2
      restart_policy:
        condition: on-failure
        delay: 30s
        max_attempts: 3
      resources:
        limits:
          memory: 2G
          cpus: '1.5'

  benefit-sharing-processor:
    image: act-placemat/benefit-sharing:latest
    environment:
      - NODE_ENV=production
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - PAYMENT_PROCESSOR_API_KEY=${STRIPE_API_KEY}
      - MINIMUM_COMMUNITY_SHARE=0.40
      - PAYMENT_SCHEDULE=monthly
      - TRANSPARENCY_REPORTING=enabled
    networks:
      - act_communities
      - act_secure
    deploy:
      replicas: 2
      restart_policy:
        condition: on-failure
        delay: 30s
        max_attempts: 3
      resources:
        limits:
          memory: 512M
          cpus: '0.5'

  # ========================================
  # SECURITY & COMPLIANCE
  # ========================================
  
  security-scanner:
    image: act-placemat/security-scanner:latest
    environment:
      - NODE_ENV=production
      - SCAN_INTERVAL=1h
      - VULNERABILITY_THRESHOLD=medium
      - COMPLIANCE_FRAMEWORKS=GDPR,PIPEDA,Indigenous_Data_Sovereignty
      - NOTIFICATION_WEBHOOK=${SECURITY_WEBHOOK_URL}
    networks:
      - act_secure
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 60s
        max_attempts: 3

  backup-manager:
    image: act-placemat/backup-manager:latest
    environment:
      - NODE_ENV=production
      - DATABASE_URL=${DATABASE_URL}
      - AWS_ACCESS_KEY_ID=${BACKUP_AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${BACKUP_AWS_SECRET_ACCESS_KEY}
      - S3_BACKUP_BUCKET=${S3_BACKUP_BUCKET}
      - BACKUP_SCHEDULE=0 2 * * * # Daily at 2 AM
      - RETENTION_DAYS=90
      - COMMUNITY_DATA_SOVEREIGNTY=enforced
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - act_secure
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.labels.backup == true
      restart_policy:
        condition: on-failure
        delay: 300s
        max_attempts: 2

# ========================================
# VOLUMES FOR PERSISTENT DATA
# ========================================

volumes:
  traefik_letsencrypt:
    driver: local
  postgres_replica_data:
    driver: local
  prometheus_data:
    driver: local
  grafana_data:
    driver: local