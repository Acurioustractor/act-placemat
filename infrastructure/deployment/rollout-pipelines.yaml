# ACT Placemat Gradual Rollout Configuration and Deployment Pipelines
# GitOps-based deployment with cultural sensitivity integration

---
# ========================================
# ARGO ROLLOUTS CONFIGURATION
# ========================================

apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: act-placemat-gradual-rollout
  namespace: act-production
  labels:
    app: act-placemat
    deployment-strategy: gradual-rollout
spec:
  replicas: 6
  strategy:
    canary:
      # Cultural sensitivity integration
      canaryService: act-placemat-canary
      stableService: act-placemat-stable
      
      # Gradual rollout stages with cultural considerations
      steps:
      # Stage 1: Cultural Advisors Only (1%)
      - setWeight: 1
        pause:
          duration: "24h"  # Allow cultural feedback collection
      - analysis:
          templates:
          - templateName: cultural-compliance-analysis
          - templateName: elder-consultation-availability-check
          args:
          - name: canary-hash
            valueFrom:
              podTemplateHashValue: Latest
          - name: stable-hash
            valueFrom:
              podTemplateHashValue: Stable
              
      # Stage 2: Community Leaders (5%)
      - setWeight: 5
        pause:
          duration: "48h"  # Extended pause for community feedback
      - analysis:
          templates:
          - templateName: community-satisfaction-analysis
          - templateName: cultural-protocol-compliance-check
          args:
          - name: stage
            value: "community_leaders"
            
      # Stage 3: Early Adopters (15%)
      - setWeight: 15
        pause:
          duration: "72h"  # Allow broader community testing
      - analysis:
          templates:
          - templateName: cultural-impact-assessment
          - templateName: performance-analysis
          args:
          - name: stage
            value: "early_adopters"
            
      # Stage 4: General Community (30%)
      - setWeight: 30
        pause:
          duration: "72h"
      - analysis:
          templates:
          - templateName: full-cultural-compliance-audit
          - templateName: community-trust-analysis
          args:
          - name: stage
            value: "general_community"
            
      # Stage 5: Majority Rollout (50%)
      - setWeight: 50
        pause:
          duration: "96h"  # Longer pause before majority rollout
      - analysis:
          templates:
          - templateName: comprehensive-cultural-assessment
          - templateName: elder-satisfaction-check
          args:
          - name: stage
            value: "majority_rollout"
            
      # Stage 6: Nearly Complete (75%)
      - setWeight: 75
        pause:
          duration: "48h"
      - analysis:
          templates:
          - templateName: pre-completion-cultural-audit
          args:
          - name: stage
            value: "near_completion"
            
      # Stage 7: Full Rollout (100%)
      - setWeight: 100
        pause: {}  # Manual promotion required for full rollout

      # Traffic routing configuration
      trafficRouting:
        nginx:
          stableIngress: act-placemat-stable
          annotationPrefix: nginx.ingress.kubernetes.io
          additionalIngressAnnotations:
            canary-by-header: X-ACT-Placemat-Canary
            canary-by-header-value: "cultural-priority"
            
      # Analysis configuration
      analysis:
        templates:
        - templateName: success-rate
        - templateName: response-time-p95
        - templateName: cultural-compliance-metrics
        args:
        - name: service-name
          value: act-placemat-canary.act-production.svc.cluster.local
          
      # Automated rollback triggers
      abortScaleDownDelaySeconds: 30
      scaleDownDelaySeconds: 30

  # Pod template specification
  selector:
    matchLabels:
      app: act-placemat
  template:
    metadata:
      labels:
        app: act-placemat
      annotations:
        cultural-sensitivity: "enabled"
        elder-consultation: "available"
    spec:
      containers:
      - name: act-placemat-app
        image: act-placemat/app:latest
        ports:
        - containerPort: 8080
          name: http
        env:
        - name: FEATURE_FLAGS_ENABLED
          value: "true"
        - name: CULTURAL_PROTOCOLS_ENFORCED
          value: "true"
        - name: GRADUAL_ROLLOUT_MODE
          value: "true"
        - name: ELDER_CONSULTATION_ENDPOINT
          valueFrom:
            configMapKeyRef:
              name: cultural-services-config
              key: elder-consultation-url
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"

---
# ========================================
# CULTURAL COMPLIANCE ANALYSIS TEMPLATES
# ========================================

apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: cultural-compliance-analysis
  namespace: act-production
spec:
  args:
  - name: canary-hash
  - name: stable-hash
  metrics:
  - name: cultural-protocol-violations
    interval: 30s
    successCondition: result == 0
    failureLimit: 1
    provider:
      prometheus:
        address: http://prometheus-server:9090
        query: |
          sum(rate(cultural_protocol_violations_total{deployment="{{args.canary-hash}}"}[5m]))
          
  - name: elder-consultation-response-time
    interval: 60s
    successCondition: result < 2000  # 2 seconds max
    failureLimit: 3
    provider:
      prometheus:
        address: http://prometheus-server:9090
        query: |
          histogram_quantile(0.95, 
            sum(rate(elder_consultation_request_duration_seconds_bucket{deployment="{{args.canary-hash}}"}[5m])) by (le)
          ) * 1000
          
  - name: cultural-data-access-success-rate
    interval: 60s
    successCondition: result >= 0.99  # 99% success rate required
    failureLimit: 2
    provider:
      prometheus:
        address: http://prometheus-server:9090
        query: |
          sum(rate(cultural_data_access_success_total{deployment="{{args.canary-hash}}"}[5m])) /
          sum(rate(cultural_data_access_total{deployment="{{args.canary-hash}}"}[5m]))

---
apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: community-satisfaction-analysis
  namespace: act-production
spec:
  args:
  - name: stage
  metrics:
  - name: community-satisfaction-score
    interval: 300s  # Check every 5 minutes
    successCondition: result >= 7.0  # Minimum 7/10 satisfaction
    failureLimit: 2
    provider:
      web:
        url: http://community-feedback-service:8080/satisfaction/current
        headers:
        - key: Authorization
          value: "Bearer {{workflow.parameters.auth-token}}"
        - key: X-Stage
          value: "{{args.stage}}"
        jsonPath: "{$.average_satisfaction_score}"
        
  - name: cultural-community-satisfaction
    interval: 300s
    successCondition: result >= 8.0  # Higher threshold for cultural community
    failureLimit: 1  # Lower tolerance for cultural community dissatisfaction
    provider:
      web:
        url: http://community-feedback-service:8080/satisfaction/cultural-community
        headers:
        - key: Authorization
          value: "Bearer {{workflow.parameters.auth-token}}"
        jsonPath: "{$.cultural_community_satisfaction}"
        
  - name: elder-council-concerns
    interval: 600s  # Check every 10 minutes
    successCondition: result == 0  # Zero Elder concerns allowed
    failureLimit: 1
    provider:
      web:
        url: http://elder-consultation-service:8080/concerns/active-count
        headers:
        - key: Authorization
          value: "Bearer {{workflow.parameters.elder-token}}"
        jsonPath: "{$.active_concerns_count}"

---
apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: cultural-impact-assessment
  namespace: act-production
spec:
  args:
  - name: stage
  metrics:
  - name: sacred-data-access-violations
    interval: 60s
    successCondition: result == 0  # Absolute zero tolerance
    failureLimit: 1
    provider:
      prometheus:
        address: http://prometheus-server:9090
        query: |
          sum(rate(sacred_data_access_violations_total[5m]))
          
  - name: traditional-protocol-compliance
    interval: 120s
    successCondition: result >= 0.99  # 99% compliance required
    provider:
      prometheus:
        address: http://prometheus-server:9090
        query: |
          sum(rate(traditional_protocol_compliant_total[5m])) /
          sum(rate(traditional_protocol_checks_total[5m]))
          
  - name: community-trust-index
    interval: 900s  # Check every 15 minutes
    successCondition: result >= 0.85  # 85% trust index minimum
    failureLimit: 2
    provider:
      web:
        url: http://cultural-metrics-service:8080/trust-index
        headers:
        - key: X-Stage
          value: "{{args.stage}}"
        jsonPath: "{$.community_trust_index}"

---
apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: comprehensive-cultural-assessment
  namespace: act-production
spec:
  args:
  - name: stage
  metrics:
  - name: overall-cultural-health-score
    interval: 300s
    successCondition: result >= 8.5  # High bar for comprehensive assessment
    failureLimit: 1
    provider:
      web:
        url: http://cultural-health-service:8080/comprehensive-score
        headers:
        - key: Authorization
          value: "Bearer {{workflow.parameters.cultural-token}}"
        - key: X-Assessment-Stage
          value: "{{args.stage}}"
        jsonPath: "{$.overall_cultural_health_score}"
        
  - name: elder-council-satisfaction
    interval: 600s
    successCondition: result >= 8.0  # Elder Council satisfaction threshold
    provider:
      web:
        url: http://elder-consultation-service:8080/satisfaction-score
        headers:
        - key: Authorization
          value: "Bearer {{workflow.parameters.elder-token}}"
        jsonPath: "{$.elder_satisfaction_score}"
        
  - name: cultural-data-integrity-score
    interval: 180s
    successCondition: result >= 0.99  # 99% data integrity required
    provider:
      prometheus:
        address: http://prometheus-server:9090
        query: |
          sum(rate(cultural_data_integrity_checks_passed_total[10m])) /
          sum(rate(cultural_data_integrity_checks_total[10m]))

---
# ========================================
# DEPLOYMENT PIPELINE CONFIGURATION
# ========================================

apiVersion: v1
kind: ConfigMap
metadata:
  name: rollout-pipeline-config
  namespace: act-production
data:
  pipeline.yaml: |
    # ACT Placemat Gradual Rollout Pipeline Configuration
    
    rollout_strategy:
      name: "cultural_sensitive_gradual"
      description: "Gradual rollout with cultural protocol integration"
      
    stages:
      cultural_pre_flight:
        name: "Cultural Pre-Flight Checks"
        duration: "manual"  # Requires manual approval
        required_approvals:
          - elder_council: conditional  # Required for sacred/sensitive features
          - cultural_advisors: required
          - community_leaders: recommended
        checks:
          - cultural_impact_assessment
          - traditional_protocol_review
          - sacred_content_analysis
          - community_consultation_summary
          
      canary:
        name: "Cultural Advisors Canary"
        traffic_percentage: 1
        duration: "24h"
        target_users:
          - cultural_advisors
          - beta_testers_cultural
          - elder_council_members
        success_criteria:
          - zero_cultural_violations: required
          - elder_consultation_availability: ">99%"
          - cultural_advisor_satisfaction: ">8.0"
        monitoring:
          - cultural_compliance_dashboard
          - elder_consultation_metrics
          - sacred_data_access_audit
          
      early_adopters:
        name: "Community Leaders Early Access"
        traffic_percentage: 5
        duration: "48h"
        target_users:
          - community_leaders
          - early_adopters_opted_in
          - traditional_owner_representatives
        success_criteria:
          - community_satisfaction: ">7.5"
          - cultural_protocol_compliance: ">99%"
          - traditional_protocol_adherence: ">95%"
        rollback_triggers:
          - cultural_violation_detected
          - elder_council_concern_raised
          - community_trust_degradation
          
      progressive_rollout:
        name: "Progressive Community Rollout" 
        stages:
          - percentage: 15
            duration: "72h"
            target: "engaged_community_members"
          - percentage: 30
            duration: "72h" 
            target: "general_community"
          - percentage: 50
            duration: "96h"
            target: "broader_community"
          - percentage: 75
            duration: "48h"
            target: "majority_users"
        success_criteria:
          - overall_satisfaction: ">7.0"
          - cultural_community_satisfaction: ">8.0"
          - elder_council_satisfaction: ">8.5"
          - system_performance: ">95%"
          
      full_rollout:
        name: "Complete Rollout"
        traffic_percentage: 100
        requires_manual_approval: true
        approvers:
          - cultural_advisors
          - technical_team_lead
          - elder_council_liaison
        final_checks:
          - comprehensive_cultural_audit
          - community_trust_verification
          - long_term_impact_assessment
    
    cultural_safeguards:
      automatic_rollback_triggers:
        - cultural_protocol_violation
        - sacred_data_access_anomaly
        - elder_council_emergency_stop
        - community_trust_critical_decline
        
      monitoring_requirements:
        - cultural_compliance_continuous
        - elder_consultation_availability
        - community_feedback_active_collection
        - traditional_protocol_adherence
        
      approval_workflows:
        elder_council_approval:
          required_for: ["sacred", "sensitive"]
          timeout: "7_days"
          escalation: "cultural_advisors"
          
        cultural_advisor_review:
          required_for: ["all"]
          timeout: "48_hours"
          escalation: "technical_team"
          
        community_consultation:
          required_for: ["sensitive", "high_impact"]
          duration: "72_hours"
          feedback_threshold: "minimum_10_responses"

---
# ========================================
# GITHUB ACTIONS WORKFLOW
# ========================================

apiVersion: v1
kind: ConfigMap
metadata:
  name: github-actions-workflow
  namespace: act-production
data:
  gradual-rollout.yml: |
    name: ACT Placemat Gradual Rollout
    
    on:
      push:
        branches: [main]
        paths: ['apps/**', 'packages/**']
      workflow_dispatch:
        inputs:
          rollout_speed:
            description: 'Rollout Speed'
            required: true
            default: 'standard'
            type: choice
            options:
            - conservative
            - standard
            - accelerated
          cultural_classification:
            description: 'Cultural Classification'
            required: true
            default: 'general'
            type: choice
            options:
            - sacred
            - sensitive
            - general
          skip_cultural_checks:
            description: 'Skip Cultural Pre-Flight (Emergency Only)'
            required: false
            default: false
            type: boolean
    
    env:
      KUBE_CONFIG: ${{ secrets.KUBE_CONFIG }}
      CULTURAL_ADVISOR_TOKEN: ${{ secrets.CULTURAL_ADVISOR_TOKEN }}
      ELDER_CONSULTATION_TOKEN: ${{ secrets.ELDER_CONSULTATION_TOKEN }}
    
    jobs:
      cultural-pre-flight:
        name: Cultural Pre-Flight Checks
        runs-on: ubuntu-latest
        if: ${{ !inputs.skip_cultural_checks }}
        outputs:
          cultural-approval: ${{ steps.cultural-check.outputs.approved }}
          elder-approval-required: ${{ steps.cultural-check.outputs.elder_required }}
        
        steps:
        - name: Checkout code
          uses: actions/checkout@v4
          
        - name: Cultural Impact Assessment
          id: cultural-check
          run: |
            # Perform automated cultural impact assessment
            cultural_score=$(./scripts/assess-cultural-impact.sh)
            echo "Cultural impact score: $cultural_score"
            
            if [ "$cultural_score" -ge 7 ]; then
              echo "elder_required=true" >> $GITHUB_OUTPUT
            else
              echo "elder_required=false" >> $GITHUB_OUTPUT
            fi
            
            # Check for cultural keywords in changes
            if git diff HEAD~1 --name-only | grep -E "(cultural|sacred|elder|traditional)" > /dev/null; then
              echo "Cultural content detected in changes"
              echo "elder_required=true" >> $GITHUB_OUTPUT
            fi
            
        - name: Request Elder Approval
          if: steps.cultural-check.outputs.elder_required == 'true'
          run: |
            curl -X POST "$ELDER_CONSULTATION_ENDPOINT/approval-requests" \
              -H "Authorization: Bearer $ELDER_CONSULTATION_TOKEN" \
              -H "Content-Type: application/json" \
              -d '{
                "type": "deployment_approval",
                "classification": "${{ inputs.cultural_classification }}",
                "changes_summary": "${{ github.event.head_commit.message }}",
                "cultural_impact_score": "'$cultural_score'",
                "deployment_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
              }'
              
        - name: Wait for Cultural Approvals
          run: |
            echo "Waiting for cultural approvals..."
            # Wait for approvals with timeout
            timeout 7200 ./scripts/wait-for-approvals.sh  # 2 hours max
    
      build-and-test:
        name: Build and Test
        runs-on: ubuntu-latest
        needs: [cultural-pre-flight]
        if: always() && (needs.cultural-pre-flight.result == 'success' || inputs.skip_cultural_checks)
        
        steps:
        - name: Checkout code
          uses: actions/checkout@v4
          
        - name: Setup Node.js
          uses: actions/setup-node@v4
          with:
            node-version: '18'
            cache: 'npm'
            
        - name: Install dependencies
          run: npm ci
          
        - name: Run tests
          run: npm run test:ci
          
        - name: Run cultural compliance tests
          run: npm run test:cultural-compliance
          
        - name: Build application
          run: npm run build
          
        - name: Build Docker image
          run: |
            docker build -t act-placemat/app:${{ github.sha }} .
            docker tag act-placemat/app:${{ github.sha }} act-placemat/app:latest
            
        - name: Push to registry
          run: |
            echo ${{ secrets.DOCKER_TOKEN }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
            docker push act-placemat/app:${{ github.sha }}
            docker push act-placemat/app:latest
    
      deploy-canary:
        name: Deploy Canary (Cultural Advisors)
        runs-on: ubuntu-latest
        needs: [build-and-test, cultural-pre-flight]
        if: success()
        environment: 
          name: canary
          url: https://canary.act-placemat.org
          
        steps:
        - name: Setup kubectl
          uses: azure/setup-kubectl@v3
          
        - name: Configure kubeconfig
          run: |
            echo "$KUBE_CONFIG" | base64 -d > kubeconfig
            export KUBECONFIG=kubeconfig
            
        - name: Update canary deployment
          run: |
            kubectl patch rollout act-placemat-gradual-rollout -n act-production -p \
              '{"spec":{"template":{"spec":{"containers":[{"name":"act-placemat-app","image":"act-placemat/app:${{ github.sha }}"}]}}}}'
              
        - name: Start canary rollout
          run: |
            kubectl argo rollouts set image act-placemat-gradual-rollout -n act-production \
              act-placemat-app=act-placemat/app:${{ github.sha }}
              
        - name: Wait for canary analysis
          run: |
            kubectl argo rollouts wait act-placemat-gradual-rollout -n act-production \
              --for=condition=Progressing --timeout=3600s
              
        - name: Cultural Feedback Collection
          run: |
            # Trigger cultural feedback collection for canary stage
            curl -X POST "$CULTURAL_FEEDBACK_ENDPOINT/collection/start" \
              -H "Authorization: Bearer $CULTURAL_ADVISOR_TOKEN" \
              -d '{"stage": "canary", "deployment": "${{ github.sha }}"}'
    
      progressive-rollout:
        name: Progressive Rollout
        runs-on: ubuntu-latest
        needs: [deploy-canary]
        if: success()
        environment:
          name: production
          url: https://act-placemat.org
          
        strategy:
          matrix:
            stage: [5, 15, 30, 50, 75]
            
        steps:
        - name: Setup kubectl
          uses: azure/setup-kubectl@v3
          
        - name: Configure kubeconfig  
          run: |
            echo "$KUBE_CONFIG" | base64 -d > kubeconfig
            export KUBECONFIG=kubeconfig
            
        - name: Promote to ${{ matrix.stage }}%
          run: |
            kubectl argo rollouts promote act-placemat-gradual-rollout -n act-production
            
        - name: Wait for stage analysis
          run: |
            kubectl argo rollouts wait act-placemat-gradual-rollout -n act-production \
              --for=condition=Progressing --timeout=7200s
              
        - name: Cultural Compliance Check
          run: |
            # Check cultural compliance at this stage
            compliance_score=$(curl -s "$CULTURAL_METRICS_ENDPOINT/compliance-score" \
              -H "Authorization: Bearer $CULTURAL_ADVISOR_TOKEN" | jq -r '.score')
              
            if [ $(echo "$compliance_score < 8.0" | bc -l) -eq 1 ]; then
              echo "Cultural compliance below threshold: $compliance_score"
              kubectl argo rollouts abort act-placemat-gradual-rollout -n act-production
              exit 1
            fi
    
      full-rollout:
        name: Complete Rollout
        runs-on: ubuntu-latest
        needs: [progressive-rollout]
        if: success()
        environment:
          name: production-full
          url: https://act-placemat.org
          
        steps:
        - name: Final Cultural Approval Check
          run: |
            # Verify all cultural approvals are still valid
            ./scripts/verify-final-cultural-approvals.sh
            
        - name: Complete rollout to 100%
          run: |
            kubectl argo rollouts promote act-placemat-gradual-rollout -n act-production --full
            
        - name: Final verification
          run: |
            kubectl argo rollouts wait act-placemat-gradual-rollout -n act-production \
              --for=condition=Healthy --timeout=1800s
              
        - name: Cultural Impact Documentation
          run: |
            # Document the cultural impact of this deployment
            curl -X POST "$CULTURAL_DOCUMENTATION_ENDPOINT/deployment-impact" \
              -H "Authorization: Bearer $CULTURAL_ADVISOR_TOKEN" \
              -d '{
                "deployment_id": "${{ github.sha }}",
                "rollout_completed": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'",
                "cultural_feedback_summary": "Generated automatically"
              }'
              
        - name: Notify stakeholders
          run: |
            # Notify completion to all stakeholders
            curl -X POST "$NOTIFICATION_ENDPOINT/deployment-complete" \
              -d '{
                "deployment_id": "${{ github.sha }}",
                "cultural_compliance": "verified",
                "rollout_strategy": "gradual_cultural_sensitive"
              }'