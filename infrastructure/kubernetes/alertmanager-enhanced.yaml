# ACT Placemat Enhanced Alertmanager Configuration
# Multi-channel alerting with intelligent routing and escalation

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: alertmanager-enhanced
  namespace: monitoring
  labels:
    app: alertmanager
    version: enhanced
spec:
  replicas: 3
  selector:
    matchLabels:
      app: alertmanager
      version: enhanced
  template:
    metadata:
      labels:
        app: alertmanager
        version: enhanced
    spec:
      serviceAccountName: alertmanager
      containers:
      - name: alertmanager
        image: prom/alertmanager:v0.26.0
        ports:
        - containerPort: 9093
          name: web
        - containerPort: 9094
          name: cluster
        args:
          - '--config.file=/etc/alertmanager/alertmanager.yml'
          - '--storage.path=/alertmanager'
          - '--web.listen-address=0.0.0.0:9093'
          - '--web.external-url=https://monitoring.actplacemat.org.au/alertmanager'
          - '--cluster.listen-address=0.0.0.0:9094'
          - '--cluster.peer=alertmanager-0.alertmanager:9094'
          - '--cluster.peer=alertmanager-1.alertmanager:9094'
          - '--cluster.peer=alertmanager-2.alertmanager:9094'
          - '--log.level=info'
        volumeMounts:
        - name: alertmanager-config
          mountPath: /etc/alertmanager
        - name: alertmanager-storage
          mountPath: /alertmanager
        - name: alertmanager-templates
          mountPath: /etc/alertmanager/templates
        resources:
          requests:
            memory: "256Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "200m"
        livenessProbe:
          httpGet:
            path: /-/healthy
            port: 9093
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /-/ready
            port: 9093
          initialDelaySeconds: 10
          periodSeconds: 5
      volumes:
      - name: alertmanager-config
        configMap:
          name: alertmanager-enhanced-config
      - name: alertmanager-storage
        persistentVolumeClaim:
          claimName: alertmanager-storage
      - name: alertmanager-templates
        configMap:
          name: alertmanager-templates
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app
                  operator: In
                  values:
                  - alertmanager
              topologyKey: kubernetes.io/hostname

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-enhanced-config
  namespace: monitoring
data:
  alertmanager.yml: |
    global:
      # SMTP configuration for email alerts
      smtp_smarthost: 'smtp.gmail.com:587'
      smtp_from: 'alerts@actplacemat.org.au'
      smtp_auth_username: 'alerts@actplacemat.org.au'
      smtp_auth_password_file: '/etc/alertmanager/secrets/smtp_password'
      smtp_require_tls: true
      
      # Slack API URL (can be overridden per receiver)
      slack_api_url_file: '/etc/alertmanager/secrets/slack_webhook'
      
      # PagerDuty integration key
      pagerduty_url: 'https://events.pagerduty.com/v2/enqueue'
      
      # HTTP configuration for webhooks
      http_config:
        tls_config:
          insecure_skip_verify: false

    # Template files
    templates:
      - '/etc/alertmanager/templates/*.tmpl'

    # Alert routing configuration
    route:
      group_by: ['alertname', 'cluster', 'service']
      group_wait: 10s
      group_interval: 5m
      repeat_interval: 12h
      receiver: 'default-receiver'
      
      # Route tree for different alert types
      routes:
      
      # Critical infrastructure alerts - immediate escalation
      - match:
          severity: critical
        receiver: 'critical-alerts'
        group_wait: 0s
        repeat_interval: 5m
        routes:
        - match:
            component: infrastructure
          receiver: 'infrastructure-critical'
        - match:
            component: security
          receiver: 'security-critical'
        - match:
            component: cultural
          receiver: 'cultural-critical'
      
      # Cultural and compliance alerts - specialized routing
      - match:
          team: cultural-advisors
        receiver: 'cultural-team'
        group_wait: 5s
        repeat_interval: 30m
        routes:
        - match:
            alertname: CulturalProtocolViolation
          receiver: 'cultural-emergency'
          group_wait: 0s
          repeat_interval: 10m
        - match:
            alertname: DataSovereigntyBreach
          receiver: 'legal-emergency'
          group_wait: 0s
          repeat_interval: 5m
      
      # Security alerts - immediate attention
      - match:
          team: security
        receiver: 'security-team'
        group_wait: 30s
        repeat_interval: 15m
        routes:
        - match_re:
            alertname: '(SuspiciousLoginActivity|UnauthorizedCulturalContentAccess)'
          receiver: 'security-immediate'
          group_wait: 0s
          repeat_interval: 5m
      
      # Performance and availability alerts
      - match:
          component: backend
        receiver: 'development-team'
        group_wait: 2m
        repeat_interval: 1h
      
      - match:
          component: frontend
        receiver: 'frontend-team'
        group_wait: 2m
        repeat_interval: 1h
      
      # Community management alerts
      - match:
          team: community-management
        receiver: 'community-team'
        group_wait: 5m
        repeat_interval: 2h
      
      # AI and insights alerts
      - match:
          team: ai-team
        receiver: 'ai-team'
        group_wait: 5m
        repeat_interval: 1h
      
      # Financial and benefit sharing alerts
      - match:
          team: finance
        receiver: 'finance-team'
        group_wait: 2m
        repeat_interval: 30m
      
      # Monitoring system alerts
      - match:
          component: monitoring
        receiver: 'platform-team'
        group_wait: 5m
        repeat_interval: 1h
      
      # Warning alerts - less urgent
      - match:
          severity: warning
        receiver: 'warning-alerts'
        group_wait: 5m
        repeat_interval: 4h

    # Inhibition rules to suppress redundant alerts
    inhibit_rules:
    - source_match:
        severity: 'critical'
      target_match:
        severity: 'warning'
      equal: ['alertname', 'cluster', 'service']
    
    - source_match:
        alertname: 'KubernetesNodeDown'
      target_match_re:
        alertname: 'KubernetesPod.*'
      equal: ['instance']

    # Alert receivers configuration
    receivers:
    
    # Default receiver
    - name: 'default-receiver'
      email_configs:
      - to: 'ops@actplacemat.org.au'
        subject: 'ACT Placemat Alert: {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
        body: |
          {{ template "email.default.html" . }}
        html: |
          {{ template "email.default.html" . }}
    
    # Critical alerts - multi-channel immediate notification
    - name: 'critical-alerts'
      email_configs:
      - to: 'ops@actplacemat.org.au, cto@actplacemat.org.au'
        subject: 'üö® CRITICAL: {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
        body: |
          {{ template "email.critical.html" . }}
        html: |
          {{ template "email.critical.html" . }}
      slack_configs:
      - channel: '#critical-alerts'
        username: 'AlertManager'
        icon_emoji: ':fire:'
        title: 'üö® CRITICAL ALERT'
        text: |
          {{ template "slack.critical" . }}
        actions:
        - type: button
          text: 'View in Grafana'
          url: 'https://monitoring.actplacemat.org.au/grafana'
        - type: button
          text: 'Acknowledge'
          url: 'https://monitoring.actplacemat.org.au/alertmanager'
      pagerduty_configs:
      - routing_key_file: '/etc/alertmanager/secrets/pagerduty_key'
        description: '{{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
        severity: 'critical'
        class: 'act-placemat'
        component: '{{ range .Alerts }}{{ .Labels.component }}{{ end }}'
        group: '{{ range .Alerts }}{{ .Labels.team }}{{ end }}'
    
    # Infrastructure critical alerts
    - name: 'infrastructure-critical'
      email_configs:
      - to: 'infrastructure@actplacemat.org.au, ops@actplacemat.org.au'
        subject: 'üö® INFRASTRUCTURE CRITICAL: {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
        body: |
          {{ template "email.infrastructure.html" . }}
      slack_configs:
      - channel: '#infrastructure-alerts'
        username: 'AlertManager'
        icon_emoji: ':warning:'
        title: 'üö® Infrastructure Critical'
        text: |
          {{ template "slack.infrastructure" . }}
      webhook_configs:
      - url: 'http://infrastructure-automation:8080/webhook/critical'
        http_config:
          basic_auth:
            username: 'alertmanager'
            password_file: '/etc/alertmanager/secrets/webhook_password'
    
    # Security critical alerts
    - name: 'security-critical'
      email_configs:
      - to: 'security@actplacemat.org.au, ciso@actplacemat.org.au'
        subject: 'üö® SECURITY INCIDENT: {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
        body: |
          {{ template "email.security.html" . }}
      slack_configs:
      - channel: '#security-incidents'
        username: 'SecurityAlert'
        icon_emoji: ':shield:'
        title: 'üö® Security Incident'
        text: |
          {{ template "slack.security" . }}
      pagerduty_configs:
      - routing_key_file: '/etc/alertmanager/secrets/pagerduty_security_key'
        description: '{{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
        severity: 'critical'
        class: 'security'
    
    # Cultural protocol alerts - immediate cultural advisor notification
    - name: 'cultural-critical'
      email_configs:
      - to: 'cultural-advisors@actplacemat.org.au, elders@actplacemat.org.au'
        subject: 'üö® CULTURAL PROTOCOL ALERT: {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
        body: |
          {{ template "email.cultural.html" . }}
      slack_configs:
      - channel: '#cultural-protocols'
        username: 'CulturalAlert'
        icon_emoji: ':earth_australia:'
        title: 'üö® Cultural Protocol Alert'
        text: |
          {{ template "slack.cultural" . }}
    
    # Cultural emergency - protocol violations
    - name: 'cultural-emergency'
      email_configs:
      - to: 'cultural-advisors@actplacemat.org.au, ceo@actplacemat.org.au'
        subject: 'üö® CULTURAL PROTOCOL VIOLATION: {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
        body: |
          {{ template "email.cultural_emergency.html" . }}
      slack_configs:
      - channel: '#cultural-emergency'
        username: 'CulturalEmergency'
        icon_emoji: ':rotating_light:'
        title: 'üö® Cultural Protocol Violation'
        text: |
          {{ template "slack.cultural_emergency" . }}
      # SMS notification for immediate attention
      webhook_configs:
      - url: 'https://api.twilio.com/2010-04-01/Accounts/YOUR_ACCOUNT_SID/Messages.json'
        http_config:
          basic_auth:
            username: 'YOUR_ACCOUNT_SID'
            password_file: '/etc/alertmanager/secrets/twilio_token'
    
    # Legal emergency - data sovereignty breaches
    - name: 'legal-emergency'
      email_configs:
      - to: 'legal@actplacemat.org.au, privacy-officer@actplacemat.org.au, ceo@actplacemat.org.au'
        subject: 'üö® DATA SOVEREIGNTY BREACH: {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
        body: |
          {{ template "email.legal_emergency.html" . }}
      slack_configs:
      - channel: '#legal-alerts'
        username: 'LegalAlert'
        icon_emoji: ':scales:'
        title: 'üö® Data Sovereignty Breach'
        text: |
          {{ template "slack.legal" . }}
    
    # Security team alerts
    - name: 'security-team'
      email_configs:
      - to: 'security@actplacemat.org.au'
        subject: 'Security Alert: {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
        body: |
          {{ template "email.security.html" . }}
      slack_configs:
      - channel: '#security-alerts'
        username: 'SecurityAlert'
        icon_emoji: ':lock:'
        title: 'Security Alert'
        text: |
          {{ template "slack.security" . }}
    
    # Security immediate alerts
    - name: 'security-immediate'
      email_configs:
      - to: 'security@actplacemat.org.au, ops@actplacemat.org.au'
        subject: '‚ö†Ô∏è IMMEDIATE: {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
        body: |
          {{ template "email.security.html" . }}
      slack_configs:
      - channel: '#security-immediate'
        username: 'SecurityImmediate'
        icon_emoji: ':rotating_light:'
        title: '‚ö†Ô∏è Immediate Security Alert'
        text: |
          {{ template "slack.security_immediate" . }}
    
    # Development team alerts
    - name: 'development-team'
      email_configs:
      - to: 'dev-team@actplacemat.org.au'
        subject: 'Development Alert: {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
        body: |
          {{ template "email.development.html" . }}
      slack_configs:
      - channel: '#dev-alerts'
        username: 'DevAlert'
        icon_emoji: ':computer:'
        title: 'Development Alert'
        text: |
          {{ template "slack.development" . }}
    
    # Frontend team alerts
    - name: 'frontend-team'
      email_configs:
      - to: 'frontend-team@actplacemat.org.au'
        subject: 'Frontend Alert: {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
        body: |
          {{ template "email.frontend.html" . }}
      slack_configs:
      - channel: '#frontend-alerts'
        username: 'FrontendAlert'
        icon_emoji: ':art:'
        title: 'Frontend Alert'
        text: |
          {{ template "slack.frontend" . }}
    
    # Community team alerts
    - name: 'community-team'
      email_configs:
      - to: 'community-managers@actplacemat.org.au'
        subject: 'Community Alert: {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
        body: |
          {{ template "email.community.html" . }}
      slack_configs:
      - channel: '#community-alerts'
        username: 'CommunityAlert'
        icon_emoji: ':people_holding_hands:'
        title: 'Community Alert'
        text: |
          {{ template "slack.community" . }}
    
    # Cultural team alerts
    - name: 'cultural-team'
      email_configs:
      - to: 'cultural-advisors@actplacemat.org.au'
        subject: 'Cultural Alert: {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
        body: |
          {{ template "email.cultural.html" . }}
      slack_configs:
      - channel: '#cultural-alerts'
        username: 'CulturalAlert'
        icon_emoji: ':earth_australia:'
        title: 'Cultural Alert'
        text: |
          {{ template "slack.cultural" . }}
    
    # AI team alerts
    - name: 'ai-team'
      email_configs:
      - to: 'ai-team@actplacemat.org.au'
        subject: 'AI System Alert: {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
        body: |
          {{ template "email.ai.html" . }}
      slack_configs:
      - channel: '#ai-alerts'
        username: 'AIAlert'
        icon_emoji: ':robot_face:'
        title: 'AI System Alert'
        text: |
          {{ template "slack.ai" . }}
    
    # Finance team alerts
    - name: 'finance-team'
      email_configs:
      - to: 'finance@actplacemat.org.au'
        subject: 'Finance Alert: {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
        body: |
          {{ template "email.finance.html" . }}
      slack_configs:
      - channel: '#finance-alerts'
        username: 'FinanceAlert'
        icon_emoji: ':moneybag:'
        title: 'Finance Alert'
        text: |
          {{ template "slack.finance" . }}
    
    # Platform team alerts
    - name: 'platform-team'
      email_configs:
      - to: 'platform@actplacemat.org.au'
        subject: 'Platform Alert: {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
        body: |
          {{ template "email.platform.html" . }}
      slack_configs:
      - channel: '#platform-alerts'
        username: 'PlatformAlert'
        icon_emoji: ':gear:'
        title: 'Platform Alert'
        text: |
          {{ template "slack.platform" . }}
    
    # Warning alerts - lower priority
    - name: 'warning-alerts'
      email_configs:
      - to: 'ops@actplacemat.org.au'
        subject: 'Warning: {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
        body: |
          {{ template "email.warning.html" . }}
      slack_configs:
      - channel: '#warning-alerts'
        username: 'WarningAlert'
        icon_emoji: ':warning:'
        title: 'Warning Alert'
        text: |
          {{ template "slack.warning" . }}

---
# Alertmanager secrets for notification credentials
apiVersion: v1
kind: Secret
metadata:
  name: alertmanager-secrets
  namespace: monitoring
type: Opaque
data:
  # Base64 encoded values (replace with actual values)
  smtp_password: bXlfc210cF9wYXNzd29yZA==  # my_smtp_password
  slack_webhook: aHR0cHM6Ly9ob29rcy5zbGFjay5jb20vc2VydmljZXMvVFhYWFgvWVlZWVkvWlpaWlo=  # slack webhook URL
  pagerduty_key: bXlfcGFnZXJkdXR5X2tleQ==  # my_pagerduty_key
  pagerduty_security_key: bXlfc2VjdXJpdHlfcGFnZXJkdXR5X2tleQ==  # my_security_pagerduty_key
  webhook_password: bXlfd2ViaG9va19wYXNzd29yZA==  # my_webhook_password
  twilio_token: bXlfdHdpbGlvX3Rva2Vu  # my_twilio_token

---
# Service for enhanced Alertmanager
apiVersion: v1
kind: Service
metadata:
  name: alertmanager-enhanced-service
  namespace: monitoring
  labels:
    app: alertmanager
    version: enhanced
spec:
  selector:
    app: alertmanager
    version: enhanced
  ports:
  - name: web
    port: 9093
    targetPort: 9093
  - name: cluster
    port: 9094
    targetPort: 9094
  type: ClusterIP

---
# Headless service for cluster communication
apiVersion: v1
kind: Service
metadata:
  name: alertmanager
  namespace: monitoring
  labels:
    app: alertmanager
spec:
  clusterIP: None
  selector:
    app: alertmanager
    version: enhanced
  ports:
  - name: web
    port: 9093
    targetPort: 9093
  - name: cluster
    port: 9094
    targetPort: 9094

---
# ServiceAccount for Alertmanager
apiVersion: v1
kind: ServiceAccount
metadata:
  name: alertmanager
  namespace: monitoring

---
# PersistentVolumeClaim for Alertmanager storage
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: alertmanager-storage
  namespace: monitoring
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
  storageClassName: gp3