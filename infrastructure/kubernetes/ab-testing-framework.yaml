# ACT Placemat A/B Testing Framework
# Comprehensive experimentation platform for community-focused feature testing

---
# ========================================
# A/B TESTING CORE SERVICE
# ========================================

apiVersion: apps/v1
kind: Deployment
metadata:
  name: ab-testing-service
  namespace: act-production
  labels:
    app: ab-testing-service
    component: experimentation
spec:
  replicas: 3
  selector:
    matchLabels:
      app: ab-testing-service
  template:
    metadata:
      labels:
        app: ab-testing-service
        component: experimentation
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8080"
        prometheus.io/path: "/metrics"
    spec:
      containers:
      - name: ab-testing-service
        image: node:18-alpine
        ports:
        - containerPort: 8080
          name: http
        - containerPort: 9090
          name: metrics
        env:
        - name: NODE_ENV
          value: "production"
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: database-secrets
              key: postgres-url
        - name: REDIS_URL
          valueFrom:
            secretKeyRef:
              name: redis-secrets
              key: redis-url
        - name: CULTURAL_ADVISOR_WEBHOOK
          valueFrom:
            secretKeyRef:
              name: cultural-secrets
              key: advisor-webhook-url
        volumeMounts:
        - name: ab-testing-config
          mountPath: /app/config
        - name: cultural-protocols
          mountPath: /app/cultural
        - name: ab-testing-source
          mountPath: /app
        command: ["node", "server.js"]
        resources:
          requests:
            memory: "256Mi"
            cpu: "200m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 5
      volumes:
      - name: ab-testing-config
        configMap:
          name: ab-testing-config
      - name: cultural-protocols
        configMap:
          name: cultural-protocols-config
      - name: ab-testing-source
        configMap:
          name: ab-testing-source-code

---
apiVersion: v1
kind: Service
metadata:
  name: ab-testing-service
  namespace: act-production
  labels:
    app: ab-testing-service
spec:
  selector:
    app: ab-testing-service
  ports:
  - name: http
    port: 8080
    targetPort: 8080
  - name: metrics
    port: 9090
    targetPort: 9090
  type: ClusterIP

---
# ========================================
# A/B TESTING CONFIGURATION
# ========================================

apiVersion: v1
kind: ConfigMap
metadata:
  name: ab-testing-config
  namespace: act-production
data:
  config.yaml: |
    # ACT Placemat A/B Testing Configuration
    
    server:
      port: 8080
      metrics_port: 9090
      environment: production
      
    database:
      pool_size: 20
      connection_timeout: 5000
      idle_timeout: 300000
      
    redis:
      pool_size: 10
      connection_timeout: 1000
      key_prefix: "act_ab_test:"
      ttl: 86400  # 24 hours
    
    # Cultural Considerations
    cultural_framework:
      enable_cultural_review: true
      require_elder_approval: true
      cultural_advisor_notification: true
      community_impact_assessment: true
      sacred_content_protection: true
    
    # Community-Aware Testing
    community_settings:
      min_community_size: 50  # Minimum community size for testing
      max_test_impact: 0.1    # Maximum 10% of community in any test
      cultural_content_approval: required
      elder_consultation_threshold: 0.05  # 5% of community triggers consultation
    
    # Experiment Configuration
    experiments:
      default_duration: 14  # days
      minimum_duration: 7   # days
      maximum_duration: 90  # days
      confidence_level: 0.95
      minimum_sample_size: 100
      maximum_variants: 5
    
    # Metrics Collection
    metrics:
      collection_interval: 60  # seconds
      batch_size: 1000
      retention_days: 365
      privacy_mode: strict
    
    # Feature Flags Integration
    feature_flags:
      provider: "internal"
      cache_ttl: 300  # seconds
      fallback_behavior: "control"
      gradual_rollout: true
    
    # Statistical Analysis
    statistics:
      significance_threshold: 0.05
      power_threshold: 0.8
      multiple_testing_correction: "bonferroni"
      bayesian_analysis: true
    
    # Cultural Impact Assessment
    cultural_impact:
      enable_assessment: true
      consultation_required_threshold: 0.1
      automatic_pause_threshold: 0.05
      elder_notification_threshold: 0.02
    
    # Privacy and Data Protection
    privacy:
      data_anonymization: true
      gdpr_compliance: true
      indigenous_data_sovereignty: true
      community_consent_tracking: true
      pii_protection: strict

---
# ========================================
# A/B TESTING SOURCE CODE
# ========================================

apiVersion: v1
kind: ConfigMap
metadata:
  name: ab-testing-source-code
  namespace: act-production
data:
  server.js: |
    const express = require('express');
    const { Pool } = require('pg');
    const Redis = require('ioredis');
    const yaml = require('js-yaml');
    const fs = require('fs');
    const crypto = require('crypto');
    const prometheus = require('prom-client');
    
    // Load configuration
    const config = yaml.load(fs.readFileSync('/app/config/config.yaml', 'utf8'));
    const culturalProtocols = yaml.load(fs.readFileSync('/app/cultural/protocols.yaml', 'utf8'));
    
    // Initialize Express app
    const app = express();
    app.use(express.json());
    
    // Initialize database and Redis connections
    const db = new Pool({ connectionString: process.env.DATABASE_URL });
    const redis = new Redis(process.env.REDIS_URL);
    
    // Prometheus metrics
    const experimentAssignments = new prometheus.Counter({
      name: 'ab_test_assignments_total',
      help: 'Total number of experiment assignments',
      labelNames: ['experiment_id', 'variant', 'user_segment']
    });
    
    const experimentConversions = new prometheus.Counter({
      name: 'ab_test_conversions_total',
      help: 'Total number of experiment conversions',
      labelNames: ['experiment_id', 'variant', 'conversion_type']
    });
    
    const culturalReviewRequests = new prometheus.Counter({
      name: 'cultural_review_requests_total',
      help: 'Total number of cultural review requests',
      labelNames: ['review_type', 'status']
    });
    
    // A/B Testing Core Class
    class ACTPlacematABTesting {
      constructor() {
        this.experiments = new Map();
        this.userAssignments = new Map();
        this.culturalAdvisor = new CulturalAdvisor();
      }
    
      async initializeDatabase() {
        // Create database schema for A/B testing
        await db.query(`
          CREATE TABLE IF NOT EXISTS experiments (
            id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
            name VARCHAR(255) NOT NULL,
            description TEXT,
            status VARCHAR(50) DEFAULT 'draft',
            start_date TIMESTAMP,
            end_date TIMESTAMP,
            variants JSONB NOT NULL,
            targeting_rules JSONB,
            cultural_approval_status VARCHAR(50) DEFAULT 'pending',
            elder_consultation_required BOOLEAN DEFAULT false,
            community_impact_level VARCHAR(50) DEFAULT 'low',
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
          );
        `);
    
        await db.query(`
          CREATE TABLE IF NOT EXISTS experiment_assignments (
            id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
            experiment_id UUID REFERENCES experiments(id),
            user_id VARCHAR(255) NOT NULL,
            variant VARCHAR(100) NOT NULL,
            community_id VARCHAR(255),
            cultural_context JSONB,
            assigned_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            UNIQUE(experiment_id, user_id)
          );
        `);
    
        await db.query(`
          CREATE TABLE IF NOT EXISTS experiment_events (
            id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
            experiment_id UUID REFERENCES experiments(id),
            user_id VARCHAR(255) NOT NULL,
            variant VARCHAR(100) NOT NULL,
            event_type VARCHAR(100) NOT NULL,
            event_data JSONB,
            community_context JSONB,
            cultural_sensitivity_level VARCHAR(50),
            timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
          );
        `);
    
        await db.query(`
          CREATE TABLE IF NOT EXISTS cultural_reviews (
            id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
            experiment_id UUID REFERENCES experiments(id),
            review_type VARCHAR(100) NOT NULL,
            reviewer_type VARCHAR(100) NOT NULL,
            status VARCHAR(50) DEFAULT 'pending',
            feedback TEXT,
            recommendations JSONB,
            reviewed_by VARCHAR(255),
            reviewed_at TIMESTAMP,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
          );
        `);
      }
    
      async createExperiment(experimentData) {
        // Validate experiment for cultural sensitivity
        const culturalReview = await this.culturalAdvisor.reviewExperiment(experimentData);
        
        if (culturalReview.requiresElderConsultation) {
          culturalReviewRequests.labels('experiment', 'elder_consultation').inc();
          return { 
            success: false, 
            message: 'Experiment requires Elder consultation before proceeding',
            reviewId: culturalReview.id 
          };
        }
    
        const experiment = await db.query(`
          INSERT INTO experiments (name, description, variants, targeting_rules, 
                                  cultural_approval_status, elder_consultation_required,
                                  community_impact_level)
          VALUES ($1, $2, $3, $4, $5, $6, $7)
          RETURNING *
        `, [
          experimentData.name,
          experimentData.description,
          JSON.stringify(experimentData.variants),
          JSON.stringify(experimentData.targeting || {}),
          culturalReview.approvalStatus,
          culturalReview.requiresElderConsultation,
          culturalReview.impactLevel
        ]);
    
        return { success: true, experiment: experiment.rows[0] };
      }
    
      async assignUserToExperiment(experimentId, userId, communityContext) {
        // Check if user already assigned
        const existingAssignment = await db.query(`
          SELECT * FROM experiment_assignments 
          WHERE experiment_id = $1 AND user_id = $2
        `, [experimentId, userId]);
    
        if (existingAssignment.rows.length > 0) {
          return existingAssignment.rows[0];
        }
    
        // Get experiment details
        const experimentResult = await db.query(`
          SELECT * FROM experiments WHERE id = $1 AND status = 'active'
        `, [experimentId]);
    
        if (experimentResult.rows.length === 0) {
          throw new Error('Experiment not found or not active');
        }
    
        const experiment = experimentResult.rows[0];
        
        // Check cultural sensitivity and community impact
        const culturalCheck = await this.culturalAdvisor.checkUserAssignment(
          experiment, userId, communityContext
        );
    
        if (!culturalCheck.approved) {
          throw new Error(culturalCheck.reason);
        }
    
        // Perform randomized assignment
        const variant = this.selectVariant(experiment.variants, userId);
    
        // Store assignment
        const assignment = await db.query(`
          INSERT INTO experiment_assignments (experiment_id, user_id, variant, 
                                            community_id, cultural_context)
          VALUES ($1, $2, $3, $4, $5)
          RETURNING *
        `, [
          experimentId,
          userId,
          variant,
          communityContext.communityId,
          JSON.stringify(communityContext)
        ]);
    
        // Cache assignment for quick lookup
        const cacheKey = `${config.redis.key_prefix}assignment:${experimentId}:${userId}`;
        await redis.setex(cacheKey, config.redis.ttl, JSON.stringify(assignment.rows[0]));
    
        // Record metrics
        experimentAssignments.labels(
          experimentId, 
          variant, 
          communityContext.userSegment || 'unknown'
        ).inc();
    
        return assignment.rows[0];
      }
    
      selectVariant(variants, userId) {
        // Consistent hash-based assignment
        const hash = crypto.createHash('sha256')
          .update(userId + process.env.AB_TESTING_SALT || 'act-placemat-salt')
          .digest('hex');
        
        const hashValue = parseInt(hash.substring(0, 8), 16);
        const totalWeight = variants.reduce((sum, v) => sum + (v.weight || 1), 0);
        const normalizedHash = (hashValue % 100) / 100;
        
        let cumulativeWeight = 0;
        for (const variant of variants) {
          cumulativeWeight += (variant.weight || 1) / totalWeight;
          if (normalizedHash <= cumulativeWeight) {
            return variant.name;
          }
        }
        
        return variants[0].name; // Fallback
      }
    
      async recordEvent(experimentId, userId, eventType, eventData, culturalContext) {
        // Validate cultural sensitivity of event
        const culturalCheck = await this.culturalAdvisor.checkEventSensitivity(
          eventType, eventData, culturalContext
        );
    
        const assignment = await db.query(`
          SELECT variant FROM experiment_assignments 
          WHERE experiment_id = $1 AND user_id = $2
        `, [experimentId, userId]);
    
        if (assignment.rows.length === 0) {
          throw new Error('User not assigned to experiment');
        }
    
        const variant = assignment.rows[0].variant;
    
        // Record event
        await db.query(`
          INSERT INTO experiment_events (experiment_id, user_id, variant, 
                                       event_type, event_data, community_context,
                                       cultural_sensitivity_level)
          VALUES ($1, $2, $3, $4, $5, $6, $7)
        `, [
          experimentId,
          userId,
          variant,
          eventType,
          JSON.stringify(eventData),
          JSON.stringify(culturalContext),
          culturalCheck.sensitivityLevel
        ]);
    
        // Record conversion metrics
        if (eventType === 'conversion') {
          experimentConversions.labels(
            experimentId, 
            variant, 
            eventData.conversionType || 'unknown'
          ).inc();
        }
    
        return { success: true };
      }
    
      async getExperimentResults(experimentId) {
        const results = await db.query(`
          SELECT 
            variant,
            COUNT(*) as assignments,
            COUNT(CASE WHEN ee.event_type = 'conversion' THEN 1 END) as conversions,
            AVG(CASE WHEN ee.event_type = 'engagement' THEN (ee.event_data->>'value')::numeric END) as avg_engagement
          FROM experiment_assignments ea
          LEFT JOIN experiment_events ee ON ea.experiment_id = ee.experiment_id 
                                         AND ea.user_id = ee.user_id
          WHERE ea.experiment_id = $1
          GROUP BY variant
        `, [experimentId]);
    
        // Calculate statistical significance
        const statisticalAnalysis = await this.calculateStatisticalSignificance(results.rows);
    
        return {
          results: results.rows,
          statistics: statisticalAnalysis,
          culturalCompliance: await this.getCulturalComplianceMetrics(experimentId)
        };
      }
    
      async calculateStatisticalSignificance(results) {
        // Implement statistical significance calculations
        // This is a simplified version - in production, use proper statistical libraries
        
        if (results.length < 2) {
          return { significant: false, reason: 'Insufficient variants' };
        }
    
        const control = results.find(r => r.variant === 'control') || results[0];
        const treatments = results.filter(r => r.variant !== 'control' && r !== control);
    
        const analyses = treatments.map(treatment => {
          const controlRate = control.conversions / control.assignments;
          const treatmentRate = treatment.conversions / treatment.assignments;
          
          // Simplified z-test calculation
          const pooledRate = (control.conversions + treatment.conversions) / 
                           (control.assignments + treatment.assignments);
          const se = Math.sqrt(pooledRate * (1 - pooledRate) * 
                              (1/control.assignments + 1/treatment.assignments));
          const zScore = Math.abs(treatmentRate - controlRate) / se;
          const pValue = 2 * (1 - this.normalCDF(Math.abs(zScore)));
    
          return {
            variant: treatment.variant,
            controlRate,
            treatmentRate,
            lift: ((treatmentRate - controlRate) / controlRate * 100).toFixed(2) + '%',
            pValue: pValue.toFixed(4),
            significant: pValue < config.statistics.significance_threshold,
            zScore: zScore.toFixed(2)
          };
        });
    
        return {
          control: control.variant,
          analyses,
          overallSignificant: analyses.some(a => a.significant)
        };
      }
    
      normalCDF(x) {
        // Approximation of normal cumulative distribution function
        return 0.5 * (1 + this.erf(x / Math.sqrt(2)));
      }
    
      erf(x) {
        // Error function approximation
        const a1 =  0.254829592;
        const a2 = -0.284496736;
        const a3 =  1.421413741;
        const a4 = -1.453152027;
        const a5 =  1.061405429;
        const p  =  0.3275911;
    
        const sign = x < 0 ? -1 : 1;
        x = Math.abs(x);
    
        const t = 1.0 / (1.0 + p * x);
        const y = 1.0 - (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-x * x);
    
        return sign * y;
      }
    
      async getCulturalComplianceMetrics(experimentId) {
        const compliance = await db.query(`
          SELECT 
            COUNT(*) as total_events,
            COUNT(CASE WHEN cultural_sensitivity_level = 'high' THEN 1 END) as high_sensitivity_events,
            COUNT(CASE WHEN cultural_sensitivity_level = 'sacred' THEN 1 END) as sacred_content_events
          FROM experiment_events
          WHERE experiment_id = $1
        `, [experimentId]);
    
        const reviews = await db.query(`
          SELECT status, COUNT(*) as count
          FROM cultural_reviews
          WHERE experiment_id = $1
          GROUP BY status
        `, [experimentId]);
    
        return {
          events: compliance.rows[0],
          reviews: reviews.rows,
          complianceRate: this.calculateComplianceRate(compliance.rows[0])
        };
      }
    
      calculateComplianceRate(events) {
        const totalEvents = parseInt(events.total_events);
        if (totalEvents === 0) return 100;
    
        const problematicEvents = parseInt(events.high_sensitivity_events) + 
                                parseInt(events.sacred_content_events);
        return ((totalEvents - problematicEvents) / totalEvents * 100).toFixed(2);
      }
    }
    
    // Cultural Advisor Integration
    class CulturalAdvisor {
      async reviewExperiment(experimentData) {
        // Assess cultural impact of experiment
        const impactLevel = this.assessCulturalImpact(experimentData);
        const requiresElderConsultation = impactLevel === 'high' || 
                                        this.involvesSacredContent(experimentData);
    
        return {
          approvalStatus: requiresElderConsultation ? 'pending' : 'approved',
          requiresElderConsultation,
          impactLevel,
          recommendations: this.generateRecommendations(experimentData, impactLevel)
        };
      }
    
      assessCulturalImpact(experimentData) {
        // Cultural keywords and patterns
        const culturalKeywords = [
          'indigenous', 'aboriginal', 'torres strait', 'traditional', 'sacred',
          'ceremony', 'elder', 'country', 'dreamtime', 'cultural protocol'
        ];
    
        const description = (experimentData.description || '').toLowerCase();
        const keywordMatches = culturalKeywords.filter(keyword => 
          description.includes(keyword)
        ).length;
    
        if (keywordMatches > 3) return 'high';
        if (keywordMatches > 1) return 'medium';
        return 'low';
      }
    
      involvesSacredContent(experimentData) {
        const sacredKeywords = ['sacred', 'ceremony', 'secret', 'restricted', 'men\'s business', 'women\'s business'];
        const description = (experimentData.description || '').toLowerCase();
        return sacredKeywords.some(keyword => description.includes(keyword));
      }
    
      async checkUserAssignment(experiment, userId, communityContext) {
        // Check if assignment would violate cultural protocols
        const communitySize = await this.getCommunitySize(communityContext.communityId);
        const currentTestParticipants = await this.getCurrentTestParticipants(
          experiment.id, 
          communityContext.communityId
        );
    
        const participationRate = currentTestParticipants / communitySize;
        
        if (participationRate > config.community_settings.max_test_impact) {
          return {
            approved: false,
            reason: `Community test participation rate (${(participationRate * 100).toFixed(1)}%) exceeds maximum allowed (${config.community_settings.max_test_impact * 100}%)`
          };
        }
    
        if (participationRate > config.community_settings.elder_consultation_threshold) {
          // Notify cultural advisors of high community impact
          await this.notifyCulturalAdvisors(experiment, communityContext, participationRate);
        }
    
        return { approved: true };
      }
    
      async checkEventSensitivity(eventType, eventData, culturalContext) {
        // Assess sensitivity of event being recorded
        const sensitivityLevel = this.assessEventSensitivity(eventType, eventData, culturalContext);
        
        if (sensitivityLevel === 'sacred') {
          // Log for cultural review
          culturalReviewRequests.labels('event', 'sacred_content').inc();
        }
    
        return { sensitivityLevel };
      }
    
      assessEventSensitivity(eventType, eventData, culturalContext) {
        // Cultural content indicators
        if (culturalContext.involvesCulturalContent) return 'high';
        if (culturalContext.communityType === 'indigenous') return 'medium';
        return 'low';
      }
    
      generateRecommendations(experimentData, impactLevel) {
        const recommendations = [];
    
        if (impactLevel === 'high') {
          recommendations.push('Consult with Elder Council before proceeding');
          recommendations.push('Limit community participation to 5%');
          recommendations.push('Provide cultural context training for experiment team');
        }
    
        if (impactLevel === 'medium') {
          recommendations.push('Notify Cultural Advisors of experiment progress');
          recommendations.push('Monitor for cultural sensitivity issues');
        }
    
        recommendations.push('Ensure all experiment materials respect cultural protocols');
        recommendations.push('Provide clear opt-out mechanisms for participants');
    
        return recommendations;
      }
    
      async getCommunitySize(communityId) {
        const result = await db.query(`
          SELECT member_count FROM communities WHERE id = $1
        `, [communityId]);
        
        return result.rows.length > 0 ? result.rows[0].member_count : 0;
      }
    
      async getCurrentTestParticipants(experimentId, communityId) {
        const result = await db.query(`
          SELECT COUNT(*) as count 
          FROM experiment_assignments 
          WHERE experiment_id = $1 AND community_id = $2
        `, [experimentId, communityId]);
        
        return parseInt(result.rows[0].count);
      }
    
      async notifyCulturalAdvisors(experiment, communityContext, participationRate) {
        // Send webhook notification to cultural advisors
        try {
          const response = await fetch(process.env.CULTURAL_ADVISOR_WEBHOOK, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              type: 'high_community_participation',
              experiment: experiment.name,
              community: communityContext.communityId,
              participationRate: (participationRate * 100).toFixed(1) + '%',
              timestamp: new Date().toISOString()
            })
          });
        } catch (error) {
          console.error('Failed to notify cultural advisors:', error);
        }
      }
    }
    
    // Initialize A/B Testing service
    const abTesting = new ACTPlacematABTesting();
    
    // API Routes
    app.post('/experiments', async (req, res) => {
      try {
        const result = await abTesting.createExperiment(req.body);
        res.json(result);
      } catch (error) {
        res.status(500).json({ error: error.message });
      }
    });
    
    app.post('/experiments/:id/assign', async (req, res) => {
      try {
        const { userId, communityContext } = req.body;
        const assignment = await abTesting.assignUserToExperiment(
          req.params.id, 
          userId, 
          communityContext
        );
        res.json(assignment);
      } catch (error) {
        res.status(500).json({ error: error.message });
      }
    });
    
    app.post('/experiments/:id/events', async (req, res) => {
      try {
        const { userId, eventType, eventData, culturalContext } = req.body;
        const result = await abTesting.recordEvent(
          req.params.id, 
          userId, 
          eventType, 
          eventData, 
          culturalContext
        );
        res.json(result);
      } catch (error) {
        res.status(500).json({ error: error.message });
      }
    });
    
    app.get('/experiments/:id/results', async (req, res) => {
      try {
        const results = await abTesting.getExperimentResults(req.params.id);
        res.json(results);
      } catch (error) {
        res.status(500).json({ error: error.message });
      }
    });
    
    app.get('/health', (req, res) => {
      res.json({ status: 'healthy', timestamp: new Date().toISOString() });
    });
    
    app.get('/ready', async (req, res) => {
      try {
        await db.query('SELECT 1');
        await redis.ping();
        res.json({ status: 'ready' });
      } catch (error) {
        res.status(503).json({ status: 'not ready', error: error.message });
      }
    });
    
    app.get('/metrics', (req, res) => {
      res.set('Content-Type', prometheus.register.contentType);
      res.end(prometheus.register.metrics());
    });
    
    // Initialize database and start server
    async function start() {
      try {
        await abTesting.initializeDatabase();
        const port = config.server.port;
        app.listen(port, () => {
          console.log(`ACT Placemat A/B Testing service running on port ${port}`);
        });
      } catch (error) {
        console.error('Failed to start A/B Testing service:', error);
        process.exit(1);
      }
    }
    
    start();

  package.json: |
    {
      "name": "act-placemat-ab-testing",
      "version": "1.0.0",
      "description": "A/B Testing Framework for ACT Placemat Community Platform",
      "main": "server.js",
      "dependencies": {
        "express": "^4.18.2",
        "pg": "^8.11.0",
        "ioredis": "^5.3.2",
        "js-yaml": "^4.1.0",
        "prom-client": "^14.2.0",
        "node-fetch": "^3.3.1"
      },
      "engines": {
        "node": ">=18.0.0"
      }
    }

---
# ========================================
# CULTURAL PROTOCOLS CONFIGURATION
# ========================================

apiVersion: v1
kind: ConfigMap
metadata:
  name: cultural-protocols-config
  namespace: act-production
data:
  protocols.yaml: |
    # Cultural Protocols for A/B Testing
    
    cultural_sensitivity_levels:
      low:
        description: "General platform features with minimal cultural impact"
        approval_required: false
        elder_consultation: false
        community_notification: false
        
      medium:
        description: "Features affecting community interaction or cultural content display"
        approval_required: true
        elder_consultation: false
        community_notification: true
        max_community_participation: 0.15  # 15%
        
      high:
        description: "Features directly involving cultural content or protocols"
        approval_required: true
        elder_consultation: true
        community_notification: true
        max_community_participation: 0.05  # 5%
        
      sacred:
        description: "Features involving sacred or restricted cultural content"
        approval_required: true
        elder_consultation: required
        community_notification: required
        max_community_participation: 0.02  # 2%
        immediate_pause_required: true
    
    cultural_keywords:
      high_sensitivity:
        - "indigenous knowledge"
        - "traditional practices" 
        - "cultural protocols"
        - "elder consultation"
        - "sacred sites"
        - "ceremony"
        - "traditional owner"
        - "cultural heritage"
        
      sacred_content:
        - "sacred"
        - "secret"
        - "restricted"
        - "men's business"
        - "women's business"
        - "initiation"
        - "ceremony"
        - "spiritual"
    
    community_protection_rules:
      min_community_size: 50
      max_simultaneous_tests: 3
      cooling_off_period: 30  # days between tests
      elder_approval_required_threshold: 0.05  # 5% community participation
      automatic_pause_threshold: 0.02  # 2% community participation
    
    notification_protocols:
      cultural_advisors:
        webhook_url: "${CULTURAL_ADVISOR_WEBHOOK}"
        notification_triggers:
          - high_sensitivity_experiment
          - community_participation_threshold
          - cultural_content_violation
          
      elder_council:
        notification_required:
          - sacred_content_detected
          - high_community_impact
          - cultural_protocol_violation
        consultation_timeline: 
          standard: 5  # business days
          urgent: 1    # business day
          
    data_sovereignty_compliance:
      indigenous_data_protection: true
      community_consent_tracking: true
      collective_data_rights: true
      benefit_sharing_required: true
      data_portability_support: true

---
# ========================================
# REDIS CACHE FOR A/B TESTING
# ========================================

apiVersion: apps/v1
kind: Deployment
metadata:
  name: ab-testing-redis
  namespace: act-production
  labels:
    app: ab-testing-redis
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ab-testing-redis
  template:
    metadata:
      labels:
        app: ab-testing-redis
    spec:
      containers:
      - name: redis
        image: redis:7-alpine
        ports:
        - containerPort: 6379
        command: ["redis-server"]
        args: ["--appendonly", "yes", "--maxmemory", "256mb", "--maxmemory-policy", "allkeys-lru"]
        volumeMounts:
        - name: redis-data
          mountPath: /data
        resources:
          requests:
            memory: "128Mi"
            cpu: "50m"
          limits:
            memory: "256Mi"
            cpu: "100m"
      volumes:
      - name: redis-data
        emptyDir: {}

---
apiVersion: v1
kind: Service
metadata:
  name: ab-testing-redis-service
  namespace: act-production
  labels:
    app: ab-testing-redis
spec:
  selector:
    app: ab-testing-redis
  ports:
  - port: 6379
    targetPort: 6379
  type: ClusterIP

---
# ========================================
# SECRETS FOR A/B TESTING
# ========================================

apiVersion: v1
kind: Secret
metadata:
  name: ab-testing-secrets
  namespace: act-production
type: Opaque
data:
  # Base64 encoded values (replace with actual values)
  postgres-url: cG9zdGdyZXNxbDovL3VzZXI6cGFzc3dvcmRAbG9jYWxob3N0OjU0MzIvYWN0X3BsYWNlbWF0  # postgresql://user:password@localhost:5432/act_placemat
  redis-url: cmVkaXM6Ly9hYi10ZXN0aW5nLXJlZGlzLXNlcnZpY2U6NjM3OQ==  # redis://ab-testing-redis-service:6379
  ab-testing-salt: YWN0LXBsYWNlbWF0LXNhbHQtMjAyNA==  # act-placemat-salt-2024

---
apiVersion: v1
kind: Secret
metadata:
  name: cultural-secrets
  namespace: act-production
type: Opaque
data:
  # Base64 encoded cultural advisor webhook URL
  advisor-webhook-url: aHR0cHM6Ly9hcGkuYWN0cGxhY2VtYXQub3JnLmF1L2N1bHR1cmFsLWFkdmlzb3JzL3dlYmhvb2s=  # https://api.actplacemat.org.au/cultural-advisors/webhook

---
# ========================================
# EXPERIMENT MANAGEMENT INTERFACE
# ========================================

apiVersion: apps/v1
kind: Deployment
metadata:
  name: experiment-management-ui
  namespace: act-production
  labels:
    app: experiment-management-ui
    component: experimentation
spec:
  replicas: 2
  selector:
    matchLabels:
      app: experiment-management-ui
  template:
    metadata:
      labels:
        app: experiment-management-ui
        component: experimentation
    spec:
      containers:
      - name: experiment-ui
        image: node:18-alpine
        ports:
        - containerPort: 3000
          name: http
        env:
        - name: NODE_ENV
          value: "production"
        - name: AB_TESTING_API_URL
          value: "http://ab-testing-service:8080"
        - name: NEXT_TELEMETRY_DISABLED
          value: "1"
        volumeMounts:
        - name: ui-config
          mountPath: /app/config
        - name: ui-source
          mountPath: /app
        command: ["npm", "start"]
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
      volumes:
      - name: ui-config
        configMap:
          name: experiment-ui-config
      - name: ui-source
        configMap:
          name: experiment-ui-source

---
apiVersion: v1
kind: Service
metadata:
  name: experiment-management-ui
  namespace: act-production
  labels:
    app: experiment-management-ui
spec:
  selector:
    app: experiment-management-ui
  ports:
  - name: http
    port: 3000
    targetPort: 3000
  type: ClusterIP

---
# ========================================
# EXPERIMENT MANAGEMENT UI CONFIG
# ========================================

apiVersion: v1
kind: ConfigMap
metadata:
  name: experiment-ui-config
  namespace: act-production
data:
  config.json: |
    {
      "app": {
        "name": "ACT Placemat A/B Testing Dashboard",
        "version": "1.0.0",
        "environment": "production"
      },
      "api": {
        "base_url": "http://ab-testing-service:8080",
        "timeout": 10000,
        "retry_attempts": 3
      },
      "features": {
        "cultural_review": true,
        "elder_consultation": true,
        "community_impact_monitoring": true,
        "real_time_analytics": true
      },
      "ui": {
        "theme": "act-community",
        "accessibility": "wcag-aa",
        "languages": ["en", "indigenous-languages"],
        "cultural_design_elements": true
      },
      "security": {
        "csrf_protection": true,
        "rate_limiting": true,
        "content_security_policy": true,
        "cultural_content_protection": true
      }
    }

---
# ========================================
# EXPERIMENT MANAGEMENT UI SOURCE
# ========================================

apiVersion: v1
kind: ConfigMap
metadata:
  name: experiment-ui-source
  namespace: act-production
data:
  package.json: |
    {
      "name": "act-placemat-ab-testing-ui",
      "version": "1.0.0",
      "description": "A/B Testing Management Interface for ACT Placemat",
      "main": "server.js",
      "scripts": {
        "start": "node server.js",
        "dev": "nodemon server.js"
      },
      "dependencies": {
        "express": "^4.18.2",
        "next": "^13.4.0",
        "react": "^18.2.0",
        "react-dom": "^18.2.0",
        "axios": "^1.4.0",
        "styled-components": "^6.0.0",
        "recharts": "^2.6.2",
        "date-fns": "^2.30.0",
        "react-hook-form": "^7.44.0",
        "react-select": "^5.7.0",
        "react-datepicker": "^4.11.0"
      },
      "engines": {
        "node": ">=18.0.0"
      }
    }

  server.js: |
    const express = require('express');
    const next = require('next');
    const path = require('path');
    const fs = require('fs');

    const dev = process.env.NODE_ENV !== 'production';
    const nextApp = next({ dev, dir: '/app/ui' });
    const handle = nextApp.getRequestHandler();

    // Load configuration
    const config = JSON.parse(fs.readFileSync('/app/config/config.json', 'utf8'));

    nextApp.prepare().then(() => {
      const server = express();

      // Security middleware
      server.use(express.json());
      server.use((req, res, next) => {
        res.setHeader('X-Frame-Options', 'DENY');
        res.setHeader('X-Content-Type-Options', 'nosniff');
        res.setHeader('X-XSS-Protection', '1; mode=block');
        next();
      });

      // API proxy to A/B testing service
      server.use('/api/ab-testing', (req, res) => {
        const axios = require('axios');
        const targetUrl = `${config.api.base_url}${req.path}`;
        
        axios({
          method: req.method,
          url: targetUrl,
          data: req.body,
          headers: {
            'Content-Type': 'application/json',
            'Cultural-Context': req.headers['cultural-context'] || 'standard'
          }
        }).then(response => {
          res.json(response.data);
        }).catch(error => {
          res.status(error.response?.status || 500).json({
            error: error.response?.data || 'Internal server error'
          });
        });
      });

      // Handle all other routes with Next.js
      server.all('*', (req, res) => {
        return handle(req, res);
      });

      server.listen(3000, (err) => {
        if (err) throw err;
        console.log('> Experiment Management UI ready on http://localhost:3000');
      });
    });

  ui/pages/index.js: |
    import React, { useState, useEffect } from 'react';
    import styled from 'styled-components';
    import { ExperimentList } from '../components/ExperimentList';
    import { CreateExperimentModal } from '../components/CreateExperimentModal';
    import { CulturalReviewPanel } from '../components/CulturalReviewPanel';

    const DashboardContainer = styled.div`
      min-height: 100vh;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    `;

    const Header = styled.header`
      background: white;
      border-bottom: 1px solid #e2e8f0;
      padding: 1rem 2rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    `;

    const Title = styled.h1`
      margin: 0;
      color: #2d3748;
      font-size: 1.5rem;
      font-weight: 600;
    `;

    const Subtitle = styled.p`
      margin: 0.5rem 0 0;
      color: #718096;
      font-size: 0.9rem;
    `;

    const MainContent = styled.main`
      padding: 2rem;
      max-width: 1200px;
      margin: 0 auto;
    `;

    const ActionBar = styled.div`
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      padding: 1rem;
      background: white;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    `;

    const Button = styled.button`
      background: ${props => props.primary ? '#667eea' : 'white'};
      color: ${props => props.primary ? 'white' : '#4a5568'};
      border: 1px solid ${props => props.primary ? '#667eea' : '#e2e8f0'};
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;

      &:hover {
        background: ${props => props.primary ? '#5a67d8' : '#f7fafc'};
        border-color: ${props => props.primary ? '#5a67d8' : '#cbd5e0'};
      }
    `;

    const StatsGrid = styled.div`
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    `;

    const StatCard = styled.div`
      background: white;
      padding: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    `;

    const StatTitle = styled.h3`
      margin: 0 0 0.5rem;
      color: #4a5568;
      font-size: 0.875rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    `;

    const StatValue = styled.div`
      font-size: 2rem;
      font-weight: 700;
      color: #2d3748;
      margin-bottom: 0.25rem;
    `;

    const StatChange = styled.div`
      font-size: 0.875rem;
      color: ${props => props.positive ? '#38a169' : '#e53e3e'};
    `;

    export default function Dashboard() {
      const [experiments, setExperiments] = useState([]);
      const [stats, setStats] = useState({});
      const [showCreateModal, setShowCreateModal] = useState(false);
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        fetchDashboardData();
      }, []);

      const fetchDashboardData = async () => {
        try {
          setLoading(true);
          const [experimentsRes, statsRes] = await Promise.all([
            fetch('/api/ab-testing/experiments'),
            fetch('/api/ab-testing/dashboard/stats')
          ]);

          const experimentsData = await experimentsRes.json();
          const statsData = await statsRes.json();

          setExperiments(experimentsData.experiments || []);
          setStats(statsData.stats || {});
        } catch (error) {
          console.error('Failed to fetch dashboard data:', error);
        } finally {
          setLoading(false);
        }
      };

      const handleCreateExperiment = async (experimentData) => {
        try {
          const response = await fetch('/api/ab-testing/experiments', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Cultural-Context': experimentData.culturalContext || 'standard'
            },
            body: JSON.stringify(experimentData)
          });

          if (response.ok) {
            setShowCreateModal(false);
            fetchDashboardData();
          } else {
            const error = await response.json();
            alert(`Failed to create experiment: ${error.message}`);
          }
        } catch (error) {
          console.error('Failed to create experiment:', error);
          alert('Failed to create experiment. Please try again.');
        }
      };

      if (loading) {
        return (
          <DashboardContainer>
            <Header>
              <Title>ACT Placemat A/B Testing Dashboard</Title>
              <Subtitle>Loading dashboard data...</Subtitle>
            </Header>
          </DashboardContainer>
        );
      }

      return (
        <DashboardContainer>
          <Header>
            <Title>ACT Placemat A/B Testing Dashboard</Title>
            <Subtitle>
              Community-focused experimentation with cultural respect and Indigenous data sovereignty
            </Subtitle>
          </Header>

          <MainContent>
            <ActionBar>
              <div>
                <h2 style={{ margin: 0, color: '#2d3748' }}>Experiments Overview</h2>
                <p style={{ margin: '0.5rem 0 0', color: '#718096', fontSize: '0.875rem' }}>
                  Manage and monitor your A/B testing experiments
                </p>
              </div>
              <Button primary onClick={() => setShowCreateModal(true)}>
                Create New Experiment
              </Button>
            </ActionBar>

            <StatsGrid>
              <StatCard>
                <StatTitle>Active Experiments</StatTitle>
                <StatValue>{stats.activeExperiments || 0}</StatValue>
                <StatChange positive>{stats.activeChange || '+0%'} from last week</StatChange>
              </StatCard>
              
              <StatCard>
                <StatTitle>Total Participants</StatTitle>
                <StatValue>{stats.totalParticipants || 0}</StatValue>
                <StatChange positive>{stats.participantChange || '+0%'} from last week</StatChange>
              </StatCard>
              
              <StatCard>
                <StatTitle>Cultural Reviews Pending</StatTitle>
                <StatValue>{stats.pendingReviews || 0}</StatValue>
                <StatChange>{stats.reviewChange || '0'} awaiting Elder consultation</StatChange>
              </StatCard>
              
              <StatCard>
                <StatTitle>Community Impact Score</StatTitle>
                <StatValue>{stats.impactScore || '0.0'}</StatValue>
                <StatChange positive>Positive community feedback</StatChange>
              </StatCard>
            </StatsGrid>

            <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr', gap: '2rem' }}>
              <ExperimentList experiments={experiments} onRefresh={fetchDashboardData} />
              <CulturalReviewPanel stats={stats} />
            </div>
          </MainContent>

          {showCreateModal && (
            <CreateExperimentModal
              onClose={() => setShowCreateModal(false)}
              onCreate={handleCreateExperiment}
            />
          )}
        </DashboardContainer>
      );
    }

  ui/components/ExperimentList.js: |
    import React, { useState } from 'react';
    import styled from 'styled-components';
    import { format } from 'date-fns';

    const Container = styled.div`
      background: white;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    `;

    const Header = styled.div`
      padding: 1.5rem;
      border-bottom: 1px solid #e2e8f0;
    `;

    const Title = styled.h3`
      margin: 0;
      color: #2d3748;
      font-size: 1.125rem;
      font-weight: 600;
    `;

    const ExperimentItem = styled.div`
      padding: 1.5rem;
      border-bottom: 1px solid #f7fafc;
      cursor: pointer;
      transition: background-color 0.2s;

      &:hover {
        background-color: #f7fafc;
      }

      &:last-child {
        border-bottom: none;
      }
    `;

    const ExperimentName = styled.h4`
      margin: 0 0 0.5rem;
      color: #2d3748;
      font-size: 1rem;
      font-weight: 600;
    `;

    const ExperimentMeta = styled.div`
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    `;

    const Status = styled.span`
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      
      ${props => {
        switch (props.status) {
          case 'active':
            return 'background: #c6f6d5; color: #22543d;';
          case 'draft':
            return 'background: #fed7d7; color: #742a2a;';
          case 'pending':
            return 'background: #feebc8; color: #7b341e;';
          case 'completed':
            return 'background: #e6fffa; color: #234e52;';
          default:
            return 'background: #e2e8f0; color: #4a5568;';
        }
      }}
    `;

    const CulturalStatus = styled.span`
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 500;
      
      ${props => {
        switch (props.status) {
          case 'approved':
            return 'background: #c6f6d5; color: #22543d;';
          case 'pending':
            return 'background: #feebc8; color: #7b341e;';
          case 'elder_review':
            return 'background: #fed7d7; color: #742a2a;';
          default:
            return 'background: #e2e8f0; color: #4a5568;';
        }
      }}
    `;

    const Description = styled.p`
      margin: 0 0 0.75rem;
      color: #718096;
      font-size: 0.875rem;
      line-height: 1.4;
    `;

    const MetricRow = styled.div`
      display: flex;
      gap: 2rem;
      font-size: 0.875rem;
      color: #4a5568;
    `;

    const Metric = styled.div`
      display: flex;
      flex-direction: column;
    `;

    const MetricLabel = styled.span`
      color: #718096;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    `;

    const MetricValue = styled.span`
      font-weight: 600;
      margin-top: 0.125rem;
    `;

    const EmptyState = styled.div`
      padding: 3rem;
      text-align: center;
      color: #718096;
    `;

    export function ExperimentList({ experiments = [], onRefresh }) {
      const [selectedExperiment, setSelectedExperiment] = useState(null);

      if (experiments.length === 0) {
        return (
          <Container>
            <Header>
              <Title>Active Experiments</Title>
            </Header>
            <EmptyState>
              <h4 style={{ margin: '0 0 0.5rem', color: '#4a5568' }}>No experiments yet</h4>
              <p style={{ margin: 0 }}>Create your first experiment to get started with A/B testing.</p>
            </EmptyState>
          </Container>
        );
      }

      return (
        <Container>
          <Header>
            <Title>Active Experiments ({experiments.length})</Title>
          </Header>
          
          {experiments.map(experiment => (
            <ExperimentItem
              key={experiment.id}
              onClick={() => setSelectedExperiment(experiment.id)}
            >
              <ExperimentMeta>
                <div style={{ display: 'flex', gap: '0.5rem', alignItems: 'center' }}>
                  <Status status={experiment.status}>{experiment.status}</Status>
                  <CulturalStatus status={experiment.cultural_approval_status}>
                    {experiment.cultural_approval_status}
                  </CulturalStatus>
                  {experiment.elder_consultation_required && (
                    <span style={{ 
                      fontSize: '0.75rem',
                      color: '#7b341e',
                      background: '#feebc8',
                      padding: '0.25rem 0.5rem',
                      borderRadius: '4px'
                    }}>
                      Elder Review Required
                    </span>
                  )}
                </div>
                <span style={{ fontSize: '0.75rem', color: '#718096' }}>
                  {experiment.created_at && format(new Date(experiment.created_at), 'MMM d, yyyy')}
                </span>
              </ExperimentMeta>

              <ExperimentName>{experiment.name}</ExperimentName>
              <Description>{experiment.description}</Description>

              <MetricRow>
                <Metric>
                  <MetricLabel>Participants</MetricLabel>
                  <MetricValue>{experiment.participants || 0}</MetricValue>
                </Metric>
                
                <Metric>
                  <MetricLabel>Variants</MetricLabel>
                  <MetricValue>
                    {experiment.variants ? JSON.parse(experiment.variants).length : 0}
                  </MetricValue>
                </Metric>
                
                <Metric>
                  <MetricLabel>Duration</MetricLabel>
                  <MetricValue>
                    {experiment.start_date && experiment.end_date
                      ? `${Math.ceil(
                          (new Date(experiment.end_date) - new Date(experiment.start_date)) / 
                          (1000 * 60 * 60 * 24)
                        )} days`
                      : 'Not set'
                    }
                  </MetricValue>
                </Metric>
                
                <Metric>
                  <MetricLabel>Community Impact</MetricLabel>
                  <MetricValue>{experiment.community_impact_level || 'Low'}</MetricValue>
                </Metric>
              </MetricRow>
            </ExperimentItem>
          ))}
        </Container>
      );
    }

  ui/components/CreateExperimentModal.js: |
    import React, { useState } from 'react';
    import styled from 'styled-components';
    import { useForm } from 'react-hook-form';

    const Overlay = styled.div`
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    `;

    const Modal = styled.div`
      background: white;
      border-radius: 8px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    `;

    const Header = styled.div`
      padding: 1.5rem;
      border-bottom: 1px solid #e2e8f0;
    `;

    const Title = styled.h2`
      margin: 0;
      color: #2d3748;
      font-size: 1.25rem;
      font-weight: 600;
    `;

    const Form = styled.form`
      padding: 1.5rem;
    `;

    const FormGroup = styled.div`
      margin-bottom: 1.5rem;
    `;

    const Label = styled.label`
      display: block;
      margin-bottom: 0.5rem;
      color: #4a5568;
      font-weight: 500;
      font-size: 0.875rem;
    `;

    const Input = styled.input`
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      font-size: 0.875rem;
      
      &:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }
    `;

    const Textarea = styled.textarea`
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      font-size: 0.875rem;
      min-height: 100px;
      resize: vertical;
      
      &:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }
    `;

    const Select = styled.select`
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      font-size: 0.875rem;
      background: white;
      
      &:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }
    `;

    const VariantSection = styled.div`
      margin-top: 1rem;
      padding: 1rem;
      background: #f7fafc;
      border-radius: 6px;
      border: 1px solid #e2e8f0;
    `;

    const VariantHeader = styled.div`
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    `;

    const Button = styled.button`
      background: ${props => props.variant === 'primary' ? '#667eea' : props.variant === 'danger' ? '#e53e3e' : 'white'};
      color: ${props => props.variant === 'primary' || props.variant === 'danger' ? 'white' : '#4a5568'};
      border: 1px solid ${props => props.variant === 'primary' ? '#667eea' : props.variant === 'danger' ? '#e53e3e' : '#e2e8f0'};
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;

      &:hover {
        background: ${props => 
          props.variant === 'primary' ? '#5a67d8' : 
          props.variant === 'danger' ? '#c53030' : 
          '#f7fafc'
        };
      }

      &:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
    `;

    const ButtonGroup = styled.div`
      display: flex;
      gap: 0.75rem;
      justify-content: flex-end;
      padding: 1.5rem;
      border-top: 1px solid #e2e8f0;
      background: #f7fafc;
    `;

    const ErrorMessage = styled.span`
      color: #e53e3e;
      font-size: 0.75rem;
      margin-top: 0.25rem;
    `;

    const CulturalWarning = styled.div`
      background: #feebc8;
      border: 1px solid #f6ad55;
      border-radius: 6px;
      padding: 1rem;
      margin-bottom: 1rem;
      color: #7b341e;
      font-size: 0.875rem;
    `;

    export function CreateExperimentModal({ onClose, onCreate }) {
      const { register, handleSubmit, watch, setValue, formState: { errors } } = useForm({
        defaultValues: {
          variants: [
            { name: 'control', description: 'Original version', weight: 50 },
            { name: 'treatment', description: 'New version', weight: 50 }
          ]
        }
      });

      const [variants, setVariants] = useState([
        { name: 'control', description: 'Original version', weight: 50 },
        { name: 'treatment', description: 'New version', weight: 50 }
      ]);

      const [showCulturalWarning, setShowCulturalWarning] = useState(false);
      const [loading, setLoading] = useState(false);

      const watchedDescription = watch('description', '');

      React.useEffect(() => {
        const culturalKeywords = [
          'indigenous', 'aboriginal', 'torres strait', 'traditional', 'sacred',
          'ceremony', 'elder', 'country', 'dreamtime', 'cultural'
        ];
        
        const hasCulturalContent = culturalKeywords.some(keyword =>
          watchedDescription.toLowerCase().includes(keyword)
        );
        
        setShowCulturalWarning(hasCulturalContent);
      }, [watchedDescription]);

      const addVariant = () => {
        const newVariant = { 
          name: `variant_${variants.length + 1}`, 
          description: '', 
          weight: 100 / (variants.length + 1) 
        };
        setVariants([...variants, newVariant]);
      };

      const removeVariant = (index) => {
        if (variants.length > 2) {
          const newVariants = variants.filter((_, i) => i !== index);
          setVariants(newVariants);
        }
      };

      const updateVariant = (index, field, value) => {
        const newVariants = [...variants];
        newVariants[index] = { ...newVariants[index], [field]: value };
        setVariants(newVariants);
      };

      const onSubmit = async (data) => {
        setLoading(true);
        try {
          const experimentData = {
            ...data,
            variants: variants,
            culturalContext: showCulturalWarning ? 'cultural_content' : 'standard'
          };
          
          await onCreate(experimentData);
        } catch (error) {
          console.error('Error creating experiment:', error);
        } finally {
          setLoading(false);
        }
      };

      return (
        <Overlay onClick={(e) => e.target === e.currentTarget && onClose()}>
          <Modal>
            <Header>
              <Title>Create New A/B Test Experiment</Title>
            </Header>

            <Form onSubmit={handleSubmit(onSubmit)}>
              {showCulturalWarning && (
                <CulturalWarning>
                  <strong>Cultural Content Detected:</strong> Your experiment description contains cultural keywords. 
                  This experiment will require Cultural Advisor review and may need Elder consultation before activation.
                </CulturalWarning>
              )}

              <FormGroup>
                <Label>Experiment Name *</Label>
                <Input
                  type="text"
                  {...register('name', { required: 'Experiment name is required' })}
                  placeholder="e.g., Homepage Button Color Test"
                />
                {errors.name && <ErrorMessage>{errors.name.message}</ErrorMessage>}
              </FormGroup>

              <FormGroup>
                <Label>Description *</Label>
                <Textarea
                  {...register('description', { required: 'Description is required' })}
                  placeholder="Describe what you're testing and why..."
                />
                {errors.description && <ErrorMessage>{errors.description.message}</ErrorMessage>}
              </FormGroup>

              <FormGroup>
                <Label>Target Audience</Label>
                <Select {...register('targeting')}>
                  <option value="all_users">All Users</option>
                  <option value="new_users">New Users Only</option>
                  <option value="returning_users">Returning Users Only</option>
                  <option value="community_leaders">Community Leaders</option>
                  <option value="specific_community">Specific Community</option>
                </Select>
              </FormGroup>

              <FormGroup>
                <Label>Expected Duration (days)</Label>
                <Input
                  type="number"
                  {...register('duration', { min: 7, max: 90 })}
                  placeholder="14"
                  min="7"
                  max="90"
                />
              </FormGroup>

              <FormGroup>
                <Label>Success Metrics</Label>
                <Textarea
                  {...register('successMetrics')}
                  placeholder="e.g., Click-through rate, conversion rate, engagement time..."
                />
              </FormGroup>

              <FormGroup>
                <VariantHeader>
                  <Label style={{ margin: 0 }}>Test Variants</Label>
                  <Button type="button" onClick={addVariant} disabled={variants.length >= 5}>
                    Add Variant
                  </Button>
                </VariantHeader>
                
                {variants.map((variant, index) => (
                  <VariantSection key={index}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '0.5rem' }}>
                      <strong>Variant {index + 1}</strong>
                      {variants.length > 2 && (
                        <Button 
                          type="button" 
                          variant="danger" 
                          onClick={() => removeVariant(index)}
                          style={{ padding: '0.25rem 0.5rem', fontSize: '0.75rem' }}
                        >
                          Remove
                        </Button>
                      )}
                    </div>
                    
                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 100px', gap: '0.5rem' }}>
                      <Input
                        type="text"
                        value={variant.name}
                        onChange={(e) => updateVariant(index, 'name', e.target.value)}
                        placeholder="Variant name"
                      />
                      <Input
                        type="text"
                        value={variant.description}
                        onChange={(e) => updateVariant(index, 'description', e.target.value)}
                        placeholder="Description"
                      />
                      <Input
                        type="number"
                        value={variant.weight}
                        onChange={(e) => updateVariant(index, 'weight', parseInt(e.target.value))}
                        placeholder="Weight %"
                        min="1"
                        max="100"
                      />
                    </div>
                  </VariantSection>
                ))}
              </FormGroup>
            </Form>

            <ButtonGroup>
              <Button type="button" onClick={onClose}>
                Cancel
              </Button>
              <Button 
                type="submit" 
                variant="primary" 
                onClick={handleSubmit(onSubmit)}
                disabled={loading}
              >
                {loading ? 'Creating...' : showCulturalWarning ? 'Create & Submit for Review' : 'Create Experiment'}
              </Button>
            </ButtonGroup>
          </Modal>
        </Overlay>
      );
    }

  ui/components/CulturalReviewPanel.js: |
    import React, { useState, useEffect } from 'react';
    import styled from 'styled-components';
    import { format } from 'date-fns';

    const Container = styled.div`
      background: white;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      height: fit-content;
    `;

    const Header = styled.div`
      padding: 1.5rem;
      border-bottom: 1px solid #e2e8f0;
    `;

    const Title = styled.h3`
      margin: 0;
      color: #2d3748;
      font-size: 1.125rem;
      font-weight: 600;
    `;

    const Section = styled.div`
      padding: 1.5rem;
      border-bottom: 1px solid #f7fafc;

      &:last-child {
        border-bottom: none;
      }
    `;

    const SectionTitle = styled.h4`
      margin: 0 0 1rem;
      color: #4a5568;
      font-size: 0.875rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    `;

    const ReviewItem = styled.div`
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 0;
      border-bottom: 1px solid #f7fafc;

      &:last-child {
        border-bottom: none;
      }
    `;

    const ReviewText = styled.div`
      flex: 1;
    `;

    const ReviewName = styled.div`
      font-weight: 500;
      color: #2d3748;
      font-size: 0.875rem;
    `;

    const ReviewMeta = styled.div`
      font-size: 0.75rem;
      color: #718096;
      margin-top: 0.25rem;
    `;

    const Status = styled.span`
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      
      ${props => {
        switch (props.status) {
          case 'pending':
            return 'background: #feebc8; color: #7b341e;';
          case 'approved':
            return 'background: #c6f6d5; color: #22543d;';
          case 'elder_review':
            return 'background: #fed7d7; color: #742a2a;';
          case 'rejected':
            return 'background: #fed7d7; color: #742a2a;';
          default:
            return 'background: #e2e8f0; color: #4a5568;';
        }
      }}
    `;

    const AlertBox = styled.div`
      background: ${props => props.type === 'warning' ? '#feebc8' : '#c6f6d5'};
      border: 1px solid ${props => props.type === 'warning' ? '#f6ad55' : '#68d391'};
      border-radius: 6px;
      padding: 1rem;
      color: ${props => props.type === 'warning' ? '#7b341e' : '#22543d'};
      font-size: 0.875rem;
      margin-bottom: 1rem;
    `;

    const Button = styled.button`
      background: #667eea;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s;

      &:hover {
        background: #5a67d8;
      }
    `;

    const EmptyState = styled.div`
      padding: 2rem;
      text-align: center;
      color: #718096;
    `;

    export function CulturalReviewPanel({ stats = {} }) {
      const [reviews, setReviews] = useState([]);
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        fetchPendingReviews();
      }, []);

      const fetchPendingReviews = async () => {
        try {
          const response = await fetch('/api/ab-testing/cultural-reviews');
          const data = await response.json();
          setReviews(data.reviews || []);
        } catch (error) {
          console.error('Failed to fetch cultural reviews:', error);
        } finally {
          setLoading(false);
        }
      };

      const requestElderConsultation = async (reviewId) => {
        try {
          await fetch(`/api/ab-testing/cultural-reviews/${reviewId}/elder-consultation`, {
            method: 'POST'
          });
          fetchPendingReviews();
        } catch (error) {
          console.error('Failed to request Elder consultation:', error);
        }
      };

      return (
        <Container>
          <Header>
            <Title>Cultural Review Center</Title>
          </Header>

          <Section>
            <SectionTitle>Review Status Overview</SectionTitle>
            
            {stats.pendingReviews > 0 && (
              <AlertBox type="warning">
                <strong>{stats.pendingReviews} experiments</strong> awaiting cultural review. 
                Elder consultation may be required for culturally sensitive content.
              </AlertBox>
            )}

            {stats.pendingReviews === 0 && (
              <AlertBox type="success">
                All experiments are culturally compliant. No reviews pending.
              </AlertBox>
            )}

            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem', marginTop: '1rem' }}>
              <div style={{ textAlign: 'center', padding: '1rem', background: '#f7fafc', borderRadius: '6px' }}>
                <div style={{ fontSize: '1.5rem', fontWeight: 'bold', color: '#2d3748' }}>
                  {stats.culturalComplianceRate || '100'}%
                </div>
                <div style={{ fontSize: '0.75rem', color: '#718096', textTransform: 'uppercase' }}>
                  Cultural Compliance
                </div>
              </div>
              
              <div style={{ textAlign: 'center', padding: '1rem', background: '#f7fafc', borderRadius: '6px' }}>
                <div style={{ fontSize: '1.5rem', fontWeight: 'bold', color: '#2d3748' }}>
                  {stats.elderConsultations || 0}
                </div>
                <div style={{ fontSize: '0.75rem', color: '#718096', textTransform: 'uppercase' }}>
                  Elder Consultations
                </div>
              </div>
            </div>
          </Section>

          <Section>
            <SectionTitle>Pending Reviews</SectionTitle>
            
            {loading ? (
              <div style={{ textAlign: 'center', color: '#718096' }}>Loading reviews...</div>
            ) : reviews.length === 0 ? (
              <EmptyState>
                <div style={{ marginBottom: '0.5rem', fontWeight: '500' }}>No pending reviews</div>
                <div style={{ fontSize: '0.875rem' }}>All experiments are culturally approved.</div>
              </EmptyState>
            ) : (
              reviews.map(review => (
                <ReviewItem key={review.id}>
                  <ReviewText>
                    <ReviewName>{review.experiment_name || `Experiment ${review.experiment_id}`}</ReviewName>
                    <ReviewMeta>
                      {review.review_type}  {format(new Date(review.created_at), 'MMM d, yyyy')}
                      {review.reviewer_type === 'elder_council' && '  Elder Council'}
                    </ReviewMeta>
                  </ReviewText>
                  <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'flex-end', gap: '0.5rem' }}>
                    <Status status={review.status}>{review.status}</Status>
                    {review.status === 'pending' && review.review_type === 'cultural_sensitivity' && (
                      <Button onClick={() => requestElderConsultation(review.id)}>
                        Request Elder Review
                      </Button>
                    )}
                  </div>
                </ReviewItem>
              ))
            )}
          </Section>

          <Section>
            <SectionTitle>Cultural Guidelines</SectionTitle>
            <div style={{ fontSize: '0.875rem', color: '#4a5568', lineHeight: '1.5' }}>
              <p style={{ margin: '0 0 0.75rem' }}>
                <strong>Indigenous Data Sovereignty:</strong> All experiments must respect CARE principles 
                and community control over cultural data.
              </p>
              <p style={{ margin: '0 0 0.75rem' }}>
                <strong>Elder Consultation:</strong> Required for experiments involving sacred knowledge, 
                Traditional Owners, or culturally sensitive content.
              </p>
              <p style={{ margin: '0' }}>
                <strong>Community Impact:</strong> Maximum 10% of any community can participate in 
                experiments to minimize disruption.
              </p>
            </div>
          </Section>
        </Container>
      );
    }