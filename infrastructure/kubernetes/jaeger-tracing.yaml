# ACT Placemat Distributed Tracing with Jaeger
# End-to-end request tracing across microservices

---
# ========================================
# JAEGER OPERATOR DEPLOYMENT
# ========================================

apiVersion: apps/v1
kind: Deployment
metadata:
  name: jaeger-operator
  namespace: monitoring
  labels:
    app: jaeger-operator
spec:
  replicas: 1
  selector:
    matchLabels:
      app: jaeger-operator
  template:
    metadata:
      labels:
        app: jaeger-operator
    spec:
      serviceAccountName: jaeger-operator
      containers:
      - name: jaeger-operator
        image: jaegertracing/jaeger-operator:1.47.0
        ports:
        - containerPort: 8383
          name: http-metrics
        - containerPort: 9443
          name: webhook-server
        env:
        - name: WATCH_NAMESPACE
          value: "monitoring"
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: OPERATOR_NAME
          value: "jaeger-operator"
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"

---
# ========================================
# JAEGER INSTANCE (ALL-IN-ONE)
# ========================================

apiVersion: v1
kind: ConfigMap
metadata:
  name: jaeger-configuration
  namespace: monitoring
data:
  jaeger.yaml: |
    extensions:
      health_check:
      pprof:
      zpages:

    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
          http:
            endpoint: 0.0.0.0:4318
      jaeger:
        protocols:
          grpc:
            endpoint: 0.0.0.0:14250
          thrift_http:
            endpoint: 0.0.0.0:14268
          thrift_compact:
            endpoint: 0.0.0.0:6831
          thrift_binary:
            endpoint: 0.0.0.0:6832

    processors:
      batch:
        timeout: 1s
        send_batch_size: 1024
      memory_limiter:
        limit_mib: 512
      # ACT Placemat specific processors
      attributes:
        actions:
          - key: service.namespace
            value: "act-placemat"
            action: upsert
          - key: deployment.environment
            value: "production"
            action: upsert
      # Privacy-preserving processor
      transform:
        trace_statements:
          - context: span
            statements:
              # Remove sensitive data from span names and attributes
              - replace_pattern(name, "user_id=\\d+", "user_id=***")
              - replace_pattern(name, "email=[^\\s]+", "email=***")
              - delete_key(attributes, "user.email")
              - delete_key(attributes, "user.phone")
          - context: resource
            statements:
              - set(attributes["act.platform"], "community-first")
              - set(attributes["act.region"], "australia")

    exporters:
      jaeger:
        endpoint: jaeger-collector:14250
        tls:
          insecure: true
      elasticsearch:
        endpoints:
          - "http://elasticsearch-service:9200"
        index: "jaeger-traces"
        mapping:
          index_patterns:
            - "jaeger-traces-*"
          template:
            settings:
              number_of_shards: 3
              number_of_replicas: 1
      # Enhanced Prometheus exporter for ACT Placemat metrics
      prometheus:
        endpoint: "0.0.0.0:8889"
        namespace: "act_placemat"
        const_labels:
          platform: "act-placemat"
          environment: "production"

    service:
      extensions: [health_check, pprof, zpages]
      pipelines:
        traces:
          receivers: [otlp, jaeger]
          processors: [memory_limiter, attributes, transform, batch]
          exporters: [jaeger, elasticsearch]
        metrics:
          receivers: [otlp]
          processors: [memory_limiter, batch]
          exporters: [prometheus]

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: jaeger-all-in-one
  namespace: monitoring
  labels:
    app: jaeger
    component: all-in-one
spec:
  replicas: 1
  selector:
    matchLabels:
      app: jaeger
      component: all-in-one
  template:
    metadata:
      labels:
        app: jaeger
        component: all-in-one
    spec:
      containers:
      - name: jaeger
        image: jaegertracing/all-in-one:1.47.0
        ports:
        - containerPort: 16686
          name: query-http
        - containerPort: 14268
          name: collector-http
        - containerPort: 14250
          name: collector-grpc
        - containerPort: 6831
          protocol: UDP
          name: agent-compact
        - containerPort: 6832
          protocol: UDP
          name: agent-binary
        - containerPort: 5778
          name: config-rest
        env:
        - name: COLLECTOR_OTLP_ENABLED
          value: "true"
        - name: SPAN_STORAGE_TYPE
          value: "elasticsearch"
        - name: ES_SERVER_URLS
          value: "http://elasticsearch-service:9200"
        - name: ES_INDEX_PREFIX
          value: "jaeger"
        - name: QUERY_BASE_PATH
          value: "/jaeger"
        - name: LOG_LEVEL
          value: "info"
        - name: JAEGER_DISABLED
          value: "false"
        # ACT Placemat specific configuration
        - name: PROCESSOR_JAEGER_BINARY_TAG_FILTER
          value: "act.platform,community.id,user.type"
        - name: PROCESSOR_JAEGER_COMPACT_TAG_FILTER
          value: "act.platform,community.id,user.type"
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /
            port: 16686
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /
            port: 16686
          initialDelaySeconds: 10
          periodSeconds: 5

---
# ========================================
# OPENTELEMETRY COLLECTOR
# ========================================

apiVersion: apps/v1
kind: Deployment
metadata:
  name: otel-collector
  namespace: monitoring
  labels:
    app: otel-collector
spec:
  replicas: 2
  selector:
    matchLabels:
      app: otel-collector
  template:
    metadata:
      labels:
        app: otel-collector
    spec:
      containers:
      - name: otel-collector
        image: otel/opentelemetry-collector-contrib:0.84.0
        ports:
        - containerPort: 4317
          name: otlp-grpc
        - containerPort: 4318
          name: otlp-http
        - containerPort: 8889
          name: prometheus
        - containerPort: 13133
          name: health
        volumeMounts:
        - name: config
          mountPath: /etc/otel
        command:
        - "/otelcol-contrib"
        - "--config=/etc/otel/otel-collector-config.yaml"
        env:
        - name: MY_POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /
            port: 13133
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /
            port: 13133
          initialDelaySeconds: 10
          periodSeconds: 5
      volumes:
      - name: config
        configMap:
          name: otel-collector-config

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: otel-collector-config
  namespace: monitoring
data:
  otel-collector-config.yaml: |
    extensions:
      health_check:
        endpoint: 0.0.0.0:13133
      pprof:
        endpoint: 0.0.0.0:1777
      zpages:
        endpoint: 0.0.0.0:55679

    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
          http:
            endpoint: 0.0.0.0:4318
      # Kubernetes cluster receiver for infrastructure traces
      k8s_cluster:
        collection_interval: 10s
        node_conditions_to_report: [Ready, MemoryPressure, DiskPressure, PIDPressure]
        allocatable_types_to_report: [cpu, memory, storage]

    processors:
      batch:
        timeout: 1s
        send_batch_size: 1024
      memory_limiter:
        limit_mib: 512
      # ACT Placemat specific attribute processors
      attributes/community:
        actions:
          - key: act.platform
            value: "community-platform"
            action: upsert
          - key: act.version
            value: "1.0.0"
            action: upsert
          # Extract community context from span names
          - key: community.id
            from_attribute: "span.name"
            action: extract
            pattern: "community_id=([^\\s]+)"
          # Extract user context (anonymized)
          - key: user.type
            from_attribute: "span.name"  
            action: extract
            pattern: "user_type=([^\\s]+)"
      # Privacy protection processor
      transform/privacy:
        trace_statements:
          - context: span
            statements:
              # Remove PII from span names and attributes
              - replace_all_patterns(name, "\\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Z|a-z]{2,}\\b", "[EMAIL]")
              - replace_all_patterns(name, "\\b(?:\\+61|0)[0-9]{9}\\b", "[PHONE]")
              - replace_all_patterns(name, "\\b\\d{4}\\s?\\d{4}\\s?\\d{4}\\s?\\d{4}\\b", "[CARD]")
              - delete_key(attributes, "user.email")
              - delete_key(attributes, "user.phone")
              - delete_key(attributes, "user.address")
      # Performance analysis processor
      spanmetrics:
        metrics_exporter: prometheus
        latency_histogram_buckets: [2ms, 5ms, 10ms, 25ms, 50ms, 100ms, 250ms, 500ms, 1s, 2s, 5s, 10s]
        dimensions:
          - name: http.method
          - name: http.status_code
          - name: service.name
          - name: community.id
          - name: user.type
      # Tail sampling for performance
      tail_sampling:
        decision_wait: 10s
        num_traces: 100
        expected_new_traces_per_sec: 10
        policies:
          # Always sample errors
          - name: errors
            type: status_code
            status_code: {status_codes: [ERROR]}
          # Always sample slow requests
          - name: slow_requests
            type: latency
            latency: {threshold_ms: 2000}
          # Sample community-related operations
          - name: community_operations
            type: string_attribute
            string_attribute: {key: community.id, values: [".*"]}
          # Probabilistic sampling for normal operations
          - name: probabilistic
            type: probabilistic
            probabilistic: {sampling_percentage: 10}

    exporters:
      jaeger:
        endpoint: jaeger-all-in-one:14250
        tls:
          insecure: true
      prometheus:
        endpoint: "0.0.0.0:8889"
        namespace: "act_placemat_traces"
        const_labels:
          platform: "act-placemat"
          environment: "production"
      # Export to Elasticsearch for long-term storage
      elasticsearch:
        endpoints: ["http://elasticsearch-service:9200"]
        index: "otel-traces"
        mapping:
          index_patterns: ["otel-traces-*"]
          template:
            settings:
              number_of_shards: 2
              number_of_replicas: 1
            mappings:
              properties:
                "@timestamp":
                  type: date
                trace_id:
                  type: keyword
                span_id:
                  type: keyword
                parent_span_id:
                  type: keyword
                operation_name:
                  type: text
                duration:
                  type: long
                tags:
                  type: object
                process:
                  type: object

    service:
      extensions: [health_check, pprof, zpages]
      pipelines:
        traces:
          receivers: [otlp]
          processors: [memory_limiter, attributes/community, transform/privacy, tail_sampling, spanmetrics, batch]
          exporters: [jaeger, elasticsearch]
        metrics:
          receivers: [otlp, k8s_cluster]
          processors: [memory_limiter, batch]
          exporters: [prometheus]

---
# ========================================
# SERVICES
# ========================================

apiVersion: v1
kind: Service
metadata:
  name: jaeger-query
  namespace: monitoring
  labels:
    app: jaeger
    component: query
spec:
  selector:
    app: jaeger
    component: all-in-one
  ports:
  - name: query-http
    port: 16686
    targetPort: 16686
  type: ClusterIP

---
apiVersion: v1
kind: Service
metadata:
  name: jaeger-collector
  namespace: monitoring
  labels:
    app: jaeger
    component: collector
spec:
  selector:
    app: jaeger
    component: all-in-one
  ports:
  - name: jaeger-collector-http
    port: 14268
    targetPort: 14268
  - name: jaeger-collector-grpc
    port: 14250
    targetPort: 14250
  - name: jaeger-agent-compact
    port: 6831
    protocol: UDP
    targetPort: 6831
  - name: jaeger-agent-binary
    port: 6832
    protocol: UDP
    targetPort: 6832
  type: ClusterIP

---
apiVersion: v1
kind: Service
metadata:
  name: otel-collector
  namespace: monitoring
  labels:
    app: otel-collector
spec:
  selector:
    app: otel-collector
  ports:
  - name: otlp-grpc
    port: 4317
    targetPort: 4317
  - name: otlp-http
    port: 4318
    targetPort: 4318
  - name: metrics
    port: 8889
    targetPort: 8889
  type: ClusterIP

---
# ========================================
# SERVICE ACCOUNTS AND RBAC
# ========================================

apiVersion: v1
kind: ServiceAccount
metadata:
  name: jaeger-operator
  namespace: monitoring

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: jaeger-operator
rules:
- apiGroups: [""]
  resources: ["pods", "services", "endpoints", "persistentvolumeclaims", "events", "configmaps", "secrets", "serviceaccounts"]
  verbs: ["*"]
- apiGroups: ["apps"]
  resources: ["deployments", "daemonsets", "replicasets", "statefulsets"]
  verbs: ["*"]
- apiGroups: ["monitoring.coreos.com"]
  resources: ["servicemonitors"]
  verbs: ["get", "create"]
- apiGroups: ["jaegertracing.io"]
  resources: ["*"]
  verbs: ["*"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: jaeger-operator
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: jaeger-operator
subjects:
- kind: ServiceAccount
  name: jaeger-operator
  namespace: monitoring

---
# ========================================
# INGRESS FOR JAEGER UI
# ========================================

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: jaeger-ingress
  namespace: monitoring
  annotations:
    kubernetes.io/ingress.class: nginx
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/auth-type: basic
    nginx.ingress.kubernetes.io/auth-secret: monitoring-auth
    nginx.ingress.kubernetes.io/rewrite-target: /$1
spec:
  tls:
  - hosts:
    - monitoring.actplacemat.org.au
    secretName: monitoring-tls
  rules:
  - host: monitoring.actplacemat.org.au
    http:
      paths:
      - path: /jaeger/(.*)
        pathType: Prefix
        backend:
          service:
            name: jaeger-query
            port:
              number: 16686

---
# ========================================
# JAEGER CUSTOM RESOURCE (Alternative approach)
# ========================================

apiVersion: v1
kind: ConfigMap
metadata:
  name: jaeger-custom-config
  namespace: monitoring
data:
  jaeger.yaml: |
    apiVersion: jaegertracing.io/v1
    kind: Jaeger
    metadata:
      name: act-placemat-jaeger
      namespace: monitoring
    spec:
      strategy: allInOne
      allInOne:
        image: jaegertracing/all-in-one:1.47.0
        options:
          log-level: info
          collector:
            otlp:
              grpc:
                host-port: "0.0.0.0:4317"
              http:
                host-port: "0.0.0.0:4318"
          query:
            base-path: "/jaeger"
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
      storage:
        type: elasticsearch
        elasticsearch:
          server-urls: http://elasticsearch-service:9200
          index-prefix: jaeger
      ui:
        options:
          dependencies:
            menuEnabled: true
          archiveEnabled: true
          tracking:
            gaID: "UA-000000-2"
      ingress:
        enabled: true
        annotations:
          kubernetes.io/ingress.class: nginx
          cert-manager.io/cluster-issuer: letsencrypt-prod
        hosts:
          - monitoring.actplacemat.org.au
        tls:
          - secretName: monitoring-tls
            hosts:
              - monitoring.actplacemat.org.au

---
# ========================================
# JAEGER COMMUNITY SPECIFIC CONFIGURATION
# ========================================

apiVersion: v1
kind: ConfigMap
metadata:
  name: jaeger-community-config
  namespace: monitoring
data:
  sampling-strategies.json: |
    {
      "default_strategy": {
        "type": "probabilistic",
        "param": 0.1
      },
      "per_service_strategies": [
        {
          "service": "backend",
          "type": "probabilistic",
          "param": 0.2
        },
        {
          "service": "frontend",
          "type": "probabilistic",
          "param": 0.1
        },
        {
          "service": "community-insights-engine",
          "type": "probabilistic",
          "param": 0.3
        },
        {
          "service": "benefit-sharing-processor",
          "type": "probabilistic",
          "param": 0.5
        }
      ],
      "per_operation_strategies": [
        {
          "service": "backend",
          "operation": "POST /api/stories",
          "type": "probabilistic",
          "param": 0.8
        },
        {
          "service": "backend",
          "operation": "POST /api/communities/join",
          "type": "probabilistic",
          "param": 1.0
        },
        {
          "service": "backend",
          "operation": "GET /api/opportunities",
          "type": "probabilistic",
          "param": 0.3
        }
      ]
    }