# Database Connection Pooling and Monitoring
# PgBouncer connection pooling with comprehensive monitoring for Australian compliance

---
# PgBouncer Configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: pgbouncer-config
  namespace: act-placemat
  labels:
    component: database
    service-type: connection-pooling
    data-residency: australia
  annotations:
    description: "PgBouncer connection pooling configuration"
    compliance.framework: "australian-privacy-act"
data:
  pgbouncer.ini: |
    [databases]
    agent_state_db = host=cloudsql-proxy-service.act-placemat.svc.cluster.local port=5432 dbname=agent_state_db
    task_queue_db = host=cloudsql-proxy-service.act-placemat.svc.cluster.local port=5432 dbname=task_queue_db
    postgres = host=cloudsql-proxy-service.act-placemat.svc.cluster.local port=5432 dbname=postgres

    [pgbouncer]
    # Connection pool settings
    pool_mode = transaction
    max_client_conn = 200
    default_pool_size = 50
    min_pool_size = 10
    reserve_pool_size = 10
    reserve_pool_timeout = 5
    max_db_connections = 100
    max_user_connections = 50

    # Network and timing
    listen_port = 5432
    listen_addr = 0.0.0.0
    tcp_keepalive = 1
    tcp_keepcnt = 3
    tcp_keepidle = 600
    tcp_keepintvl = 30

    # Security and authentication
    auth_type = scram-sha-256
    auth_file = /etc/pgbouncer/userlist.txt
    auth_hba_file = /etc/pgbouncer/pg_hba.conf

    # Logging and monitoring for Australian compliance
    log_connections = 1
    log_disconnections = 1
    log_pooler_errors = 1
    stats_period = 60
    log_stats = 1

    # Performance tuning
    query_timeout = 30
    query_wait_timeout = 120
    client_idle_timeout = 900
    server_idle_timeout = 600
    server_lifetime = 3600
    server_reset_query = DISCARD ALL
    server_check_query = SELECT 1
    server_check_delay = 30

    # Australian timezone
    timezone = Australia/Sydney

    # Compliance and audit settings
    application_name_add_host = 1
    log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '

  userlist.txt: |
    "langgraph_agent" "SCRAM-SHA-256$4096:salt$hash"
    "monitoring_user" "SCRAM-SHA-256$4096:salt$hash"

  pg_hba.conf: |
    # TYPE  DATABASE        USER            ADDRESS                 METHOD
    host    all             all             10.0.0.0/8              scram-sha-256
    host    all             all             127.0.0.1/32            scram-sha-256
    local   all             all                                     scram-sha-256

  # Monitoring configuration
  monitoring_config: |
    # PgBouncer metrics to collect
    metrics:
      pool_metrics:
        - "cl_active"      # Active client connections
        - "cl_waiting"     # Waiting client connections
        - "sv_active"      # Active server connections
        - "sv_idle"        # Idle server connections
        - "sv_used"        # Used server connections
        - "sv_tested"      # Tested server connections
        - "sv_login"       # Server connections being logged in
        - "maxwait"        # Maximum wait time
        - "pool_mode"      # Pool mode
        
      database_metrics:
        - "xact_count"     # Transaction count
        - "query_count"    # Query count
        - "bytes_received" # Bytes received
        - "bytes_sent"     # Bytes sent
        - "xact_time"      # Transaction time
        - "query_time"     # Query time
        - "wait_time"      # Wait time
        
    # Australian compliance monitoring
    compliance_monitoring:
      audit_logging: true
      connection_tracking: true
      performance_metrics: true
      security_events: true

---
# PgBouncer Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: pgbouncer
  namespace: act-placemat
  labels:
    component: database
    service-type: connection-pooling
    data-residency: australia
  annotations:
    description: "PgBouncer connection pooling service"
    compliance.framework: "australian-privacy-act"
spec:
  replicas: 3
  selector:
    matchLabels:
      component: pgbouncer
      data-residency: australia
  template:
    metadata:
      labels:
        component: pgbouncer
        data-residency: australia
      annotations:
        compliance.framework: "australian-privacy-act"
        data.classification: "restricted"
        audit.required: "true"
    spec:
      serviceAccountName: pgbouncer-service
      securityContext:
        runAsNonRoot: true
        runAsUser: 1001
        fsGroup: 1001
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: "kubernetes.io/zone"
                operator: In
                values:
                - "australia-southeast1-a"
                - "australia-southeast1-b"
                - "australia-southeast1-c"
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchLabels:
                  component: pgbouncer
              topologyKey: kubernetes.io/hostname
      containers:
      - name: pgbouncer
        image: pgbouncer/pgbouncer:1.21.0
        imagePullPolicy: Always
        env:
        - name: TZ
          value: "Australia/Sydney"
        - name: DATA_RESIDENCY
          value: "australia"
        - name: COMPLIANCE_FRAMEWORK
          value: "australian-privacy-act"
        - name: DATABASES_HOST
          value: "cloudsql-proxy-service.act-placemat.svc.cluster.local"
        - name: DATABASES_PORT
          value: "5432"
        - name: DATABASES_USER
          valueFrom:
            secretKeyRef:
              name: database-connection-config
              key: postgres-username
        - name: DATABASES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: database-connection-config
              key: postgres-password
        ports:
        - name: pgbouncer
          containerPort: 5432
          protocol: TCP
        - name: metrics
          containerPort: 9127
          protocol: TCP
        livenessProbe:
          tcpSocket:
            port: pgbouncer
          initialDelaySeconds: 30
          periodSeconds: 30
        readinessProbe:
          tcpSocket:
            port: pgbouncer
          initialDelaySeconds: 5
          periodSeconds: 10
        resources:
          limits:
            cpu: 500m
            memory: 1Gi
          requests:
            cpu: 200m
            memory: 512Mi
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          runAsNonRoot: true
          runAsUser: 1001
          capabilities:
            drop:
            - ALL
        volumeMounts:
        - name: pgbouncer-config
          mountPath: /etc/pgbouncer
          readOnly: true
        - name: tmp
          mountPath: /tmp
        - name: var-log
          mountPath: /var/log
      - name: pgbouncer-exporter
        image: prometheuscommunity/pgbouncer-exporter:v0.7.0
        imagePullPolicy: Always
        env:
        - name: TZ
          value: "Australia/Sydney"
        - name: PGBOUNCER_EXPORTER_HOST
          value: "localhost"
        - name: PGBOUNCER_EXPORTER_PORT
          value: "5432"
        - name: PGBOUNCER_EXPORTER_USER
          valueFrom:
            secretKeyRef:
              name: database-connection-config
              key: postgres-username
        - name: PGBOUNCER_EXPORTER_PASSWORD
          valueFrom:
            secretKeyRef:
              name: database-connection-config
              key: postgres-password
        ports:
        - name: exporter
          containerPort: 9127
          protocol: TCP
        livenessProbe:
          httpGet:
            path: /metrics
            port: exporter
          initialDelaySeconds: 30
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /metrics
            port: exporter
          initialDelaySeconds: 5
          periodSeconds: 10
        resources:
          limits:
            cpu: 200m
            memory: 256Mi
          requests:
            cpu: 100m
            memory: 128Mi
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          runAsNonRoot: true
          runAsUser: 1001
          capabilities:
            drop:
            - ALL
      volumes:
      - name: pgbouncer-config
        configMap:
          name: pgbouncer-config
      - name: tmp
        emptyDir: {}
      - name: var-log
        emptyDir: {}
      imagePullSecrets:
      - name: registry-credentials
      nodeSelector:
        data-residency: australia

---
# PgBouncer Service Account
apiVersion: v1
kind: ServiceAccount
metadata:
  name: pgbouncer-service
  namespace: act-placemat
  labels:
    component: database
    service-type: connection-pooling
    data-residency: australia
  annotations:
    description: "Service account for PgBouncer connection pooling"
    compliance.framework: "australian-privacy-act"
automountServiceAccountToken: false

---
# PgBouncer Service
apiVersion: v1
kind: Service
metadata:
  name: pgbouncer-service
  namespace: act-placemat
  labels:
    component: database
    service-type: connection-pooling
    data-residency: australia
  annotations:
    description: "PgBouncer connection pooling service"
    compliance.framework: "australian-privacy-act"
spec:
  selector:
    component: pgbouncer
    data-residency: australia
  ports:
  - name: pgbouncer
    port: 5432
    targetPort: pgbouncer
    protocol: TCP
  - name: metrics
    port: 9127
    targetPort: exporter
    protocol: TCP
  type: ClusterIP

---
# Database Performance Monitoring Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: database-performance-monitor
  namespace: act-placemat
  labels:
    component: database
    monitor-type: performance
    data-residency: australia
  annotations:
    description: "Database performance monitoring service"
    compliance.framework: "australian-privacy-act"
spec:
  replicas: 1
  selector:
    matchLabels:
      component: database-performance-monitor
      data-residency: australia
  template:
    metadata:
      labels:
        component: database-performance-monitor
        data-residency: australia
      annotations:
        compliance.framework: "australian-privacy-act"
        data.classification: "restricted"
        audit.required: "true"
    spec:
      serviceAccountName: database-performance-monitor-service
      securityContext:
        runAsNonRoot: true
        runAsUser: 1001
        fsGroup: 1001
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: "kubernetes.io/zone"
                operator: In
                values:
                - "australia-southeast1-a"
                - "australia-southeast1-b"
                - "australia-southeast1-c"
      containers:
      - name: performance-monitor
        image: registry.actplacemat.org.au:5000/act-placemat/database-performance-monitor:latest
        imagePullPolicy: Always
        env:
        - name: TZ
          value: "Australia/Sydney"
        - name: DATA_RESIDENCY
          value: "australia"
        - name: COMPLIANCE_FRAMEWORK
          value: "australian-privacy-act"
        - name: PGHOST
          value: "pgbouncer-service.act-placemat.svc.cluster.local"
        - name: PGPORT
          value: "5432"
        - name: PGUSER
          valueFrom:
            secretKeyRef:
              name: database-connection-config
              key: postgres-username
        - name: PGPASSWORD
          valueFrom:
            secretKeyRef:
              name: database-connection-config
              key: postgres-password
        - name: MONITORING_INTERVAL
          value: "30"
        ports:
        - name: metrics
          containerPort: 8080
          protocol: TCP
        - name: health
          containerPort: 8081
          protocol: TCP
        livenessProbe:
          httpGet:
            path: /health
            port: health
          initialDelaySeconds: 30
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /ready
            port: health
          initialDelaySeconds: 5
          periodSeconds: 10
        resources:
          limits:
            cpu: 300m
            memory: 512Mi
          requests:
            cpu: 150m
            memory: 256Mi
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          runAsNonRoot: true
          runAsUser: 1001
          capabilities:
            drop:
            - ALL
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: config
          mountPath: /etc/monitor-config
          readOnly: true
      volumes:
      - name: tmp
        emptyDir: {}
      - name: config
        configMap:
          name: pgbouncer-config
      imagePullSecrets:
      - name: registry-credentials
      nodeSelector:
        data-residency: australia

---
# Database Performance Monitor Service Account
apiVersion: v1
kind: ServiceAccount
metadata:
  name: database-performance-monitor-service
  namespace: act-placemat
  labels:
    component: database
    role: performance-monitor
    data-residency: australia
  annotations:
    description: "Service account for database performance monitoring"
    compliance.framework: "australian-privacy-act"
automountServiceAccountToken: true

---
# Database Performance Monitor Service
apiVersion: v1
kind: Service
metadata:
  name: database-performance-monitor-metrics
  namespace: act-placemat
  labels:
    component: database
    monitor-type: performance
    data-residency: australia
  annotations:
    description: "Metrics service for database performance monitoring"
    compliance.framework: "australian-privacy-act"
spec:
  selector:
    component: database-performance-monitor
    data-residency: australia
  ports:
  - name: metrics
    port: 8080
    targetPort: metrics
    protocol: TCP
  - name: health
    port: 8081
    targetPort: health
    protocol: TCP
  type: ClusterIP

---
# PgBouncer ServiceMonitor
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: pgbouncer-monitoring
  namespace: act-placemat
  labels:
    component: database
    service-type: connection-pooling
    data-residency: australia
  annotations:
    description: "Monitoring for PgBouncer connection pooling"
    compliance.framework: "australian-privacy-act"
spec:
  selector:
    matchLabels:
      component: database
      service-type: connection-pooling
  endpoints:
  - port: metrics
    interval: 30s
    path: /metrics
    honorLabels: true
    relabelings:
    - sourceLabels: [__meta_kubernetes_pod_label_data_residency]
      targetLabel: data_residency
    - sourceLabels: [__meta_kubernetes_pod_annotation_compliance_framework]
      targetLabel: compliance_framework

---
# Database Performance ServiceMonitor
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: database-performance-monitoring
  namespace: act-placemat
  labels:
    component: database
    monitor-type: performance
    data-residency: australia
  annotations:
    description: "Monitoring for database performance metrics"
    compliance.framework: "australian-privacy-act"
spec:
  selector:
    matchLabels:
      component: database
      monitor-type: performance
  endpoints:
  - port: metrics
    interval: 30s
    path: /metrics
    honorLabels: true
    relabelings:
    - sourceLabels: [__meta_kubernetes_pod_label_data_residency]
      targetLabel: data_residency
    - sourceLabels: [__meta_kubernetes_pod_annotation_compliance_framework]
      targetLabel: compliance_framework

---
# Database Performance Alert Rules
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: database-performance-alerts
  namespace: act-placemat
  labels:
    component: database
    alert-type: performance
    data-residency: australia
  annotations:
    description: "Alert rules for database performance monitoring"
    compliance.framework: "australian-privacy-act"
spec:
  groups:
  - name: database-performance
    rules:
    - alert: DatabaseHighConnectionCount
      expr: pgbouncer_pools_cl_active > 80
      for: 5m
      labels:
        severity: warning
        component: database
        data_residency: australia
      annotations:
        summary: "High database connection count"
        description: "Database has {{ $value }} active connections (threshold: 80)"
        
    - alert: DatabaseConnectionPoolExhausted
      expr: pgbouncer_pools_cl_waiting > 0
      for: 2m
      labels:
        severity: critical
        component: database
        data_residency: australia
      annotations:
        summary: "Database connection pool exhausted"
        description: "{{ $value }} clients waiting for database connections"
        
    - alert: DatabaseSlowQueries
      expr: rate(pgbouncer_stats_query_time_seconds_total[5m]) > 1
      for: 5m
      labels:
        severity: warning
        component: database
        data_residency: australia
      annotations:
        summary: "Database slow queries detected"
        description: "Average query time is {{ $value }}s (threshold: 1s)"
        
    - alert: DatabaseHighTransactionTime
      expr: rate(pgbouncer_stats_xact_time_seconds_total[5m]) > 5
      for: 5m
      labels:
        severity: warning
        component: database
        data_residency: australia
      annotations:
        summary: "High database transaction time"
        description: "Average transaction time is {{ $value }}s (threshold: 5s)"

  - name: database-connection-pooling
    rules:
    - alert: PgBouncerDown
      expr: up{job="pgbouncer-service"} == 0
      for: 1m
      labels:
        severity: critical
        component: database
        data_residency: australia
      annotations:
        summary: "PgBouncer connection pooler is down"
        description: "PgBouncer has been down for more than 1 minute"
        
    - alert: PgBouncerHighServerConnectionUsage
      expr: (pgbouncer_pools_sv_active / pgbouncer_pools_maxwait) * 100 > 80
      for: 5m
      labels:
        severity: warning
        component: database
        data_residency: australia
      annotations:
        summary: "High PgBouncer server connection usage"
        description: "Server connection usage is {{ $value }}% (threshold: 80%)"

  - name: database-compliance
    rules:
    - alert: DatabaseComplianceViolation
      expr: increase(database_compliance_violations_total[1h]) > 0
      for: 0m
      labels:
        severity: critical
        component: database
        data_residency: australia
        compliance_violation: "true"
      annotations:
        summary: "Database compliance violation detected"
        description: "{{ $value }} compliance violations detected in the last hour"

---
# Database Performance Monitoring CronJob
apiVersion: batch/v1
kind: CronJob
metadata:
  name: database-performance-report
  namespace: act-placemat
  labels:
    component: database
    operation: performance-report
    data-residency: australia
  annotations:
    description: "Generate database performance reports"
    compliance.framework: "australian-privacy-act"
spec:
  schedule: "0 1 * * *"  # Daily at 1 AM AEDT
  timeZone: "Australia/Sydney"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 7
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            component: database-performance-report
            data-residency: australia
        spec:
          serviceAccountName: database-performance-reporter
          restartPolicy: Never
          securityContext:
            runAsNonRoot: true
            runAsUser: 1001
            fsGroup: 1001
          containers:
          - name: performance-reporter
            image: postgres:16-alpine
            env:
            - name: TZ
              value: "Australia/Sydney"
            - name: DATA_RESIDENCY
              value: "australia"
            - name: COMPLIANCE_FRAMEWORK
              value: "australian-privacy-act"
            - name: PGHOST
              value: "pgbouncer-service.act-placemat.svc.cluster.local"
            - name: PGPORT
              value: "5432"
            - name: PGUSER
              valueFrom:
                secretKeyRef:
                  name: database-connection-config
                  key: postgres-username
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: database-connection-config
                  key: postgres-password
            command:
            - /bin/sh
            - -c
            - |
              echo "Starting database performance report generation at $(date)"
              
              # Function to generate performance report
              generate_performance_report() {
                echo "=== Database Performance Report ==="
                
                # Database connection statistics
                echo "=== Connection Statistics ==="
                for db in agent_state_db task_queue_db postgres; do
                  echo "Database: $db"
                  
                  # Active connections
                  ACTIVE_CONNECTIONS=$(psql -h "$PGHOST" -p "$PGPORT" -U "$PGUSER" -d "$db" -t -c "
                    SELECT count(*) FROM pg_stat_activity WHERE state = 'active' AND datname = '$db';
                  " 2>/dev/null | tr -d ' ' || echo "0")
                  
                  # Total connections
                  TOTAL_CONNECTIONS=$(psql -h "$PGHOST" -p "$PGPORT" -U "$PGUSER" -d "$db" -t -c "
                    SELECT count(*) FROM pg_stat_activity WHERE datname = '$db';
                  " 2>/dev/null | tr -d ' ' || echo "0")
                  
                  # Average query duration
                  AVG_QUERY_DURATION=$(psql -h "$PGHOST" -p "$PGPORT" -U "$PGUSER" -d "$db" -t -c "
                    SELECT COALESCE(ROUND(AVG(EXTRACT(EPOCH FROM (clock_timestamp() - query_start))), 2), 0)
                    FROM pg_stat_activity 
                    WHERE state = 'active' AND datname = '$db' AND query_start IS NOT NULL;
                  " 2>/dev/null | tr -d ' ' || echo "0")
                  
                  echo "  Active Connections: $ACTIVE_CONNECTIONS"
                  echo "  Total Connections: $TOTAL_CONNECTIONS" 
                  echo "  Average Query Duration: ${AVG_QUERY_DURATION}s"
                  echo
                done
                
                # Database size statistics
                echo "=== Database Size Statistics ==="
                for db in agent_state_db task_queue_db; do
                  DB_SIZE=$(psql -h "$PGHOST" -p "$PGPORT" -U "$PGUSER" -d "$db" -t -c "
                    SELECT pg_size_pretty(pg_database_size('$db'));
                  " 2>/dev/null | tr -d ' ' || echo "Unknown")
                  
                  echo "Database $db: $DB_SIZE"
                done
                echo
                
                # Slow query analysis
                echo "=== Slow Query Analysis ==="
                SLOW_QUERIES=$(psql -h "$PGHOST" -p "$PGPORT" -U "$PGUSER" -d postgres -t -c "
                  SELECT count(*) FROM pg_stat_statements 
                  WHERE mean_exec_time > 1000;  -- Queries taking > 1 second
                " 2>/dev/null | tr -d ' ' || echo "N/A")
                
                echo "Slow queries (>1s): $SLOW_QUERIES"
                echo
                
                return 0
              }
              
              # Function to check Australian compliance
              check_compliance_status() {
                echo "=== Australian Compliance Check ==="
                
                # Check timezone setting
                TIMEZONE=$(psql -h "$PGHOST" -p "$PGPORT" -U "$PGUSER" -d postgres -t -c "
                  SHOW timezone;
                " 2>/dev/null | tr -d ' ' || echo "Unknown")
                
                if [[ "$TIMEZONE" == *"Australia"* ]]; then
                  echo "✅ Database timezone: $TIMEZONE"
                else
                  echo "⚠️ Database timezone not set to Australia: $TIMEZONE"
                fi
                
                # Check SSL enforcement
                SSL_STATUS=$(psql -h "$PGHOST" -p "$PGPORT" -U "$PGUSER" -d postgres -t -c "
                  SHOW ssl;
                " 2>/dev/null | tr -d ' ' || echo "off")
                
                if [ "$SSL_STATUS" = "on" ]; then
                  echo "✅ SSL encryption enabled"
                else
                  echo "⚠️ SSL encryption not enabled"
                fi
                
                # Check log settings for audit compliance
                LOG_CONNECTIONS=$(psql -h "$PGHOST" -p "$PGPORT" -U "$PGUSER" -d postgres -t -c "
                  SHOW log_connections;
                " 2>/dev/null | tr -d ' ' || echo "off")
                
                if [ "$LOG_CONNECTIONS" = "on" ]; then
                  echo "✅ Connection logging enabled for audit compliance"
                else
                  echo "⚠️ Connection logging not enabled"
                fi
                
                echo
                return 0
              }
              
              # Generate comprehensive report
              cat > /tmp/database-performance-report.json << EOF
              {
                "report_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
                "report_type": "database_performance",
                "compliance_framework": "Australian Privacy Act 1988",
                "data_residency": "australia",
                "databases": ["agent_state_db", "task_queue_db", "postgres"],
                "performance_summary": {
                  "total_active_connections": "TBD",
                  "average_query_duration": "TBD",
                  "slow_queries_count": "TBD",
                  "database_sizes": "TBD"
                },
                "compliance_status": {
                  "timezone_compliance": "TBD",
                  "ssl_encryption": "TBD",
                  "audit_logging": "TBD"
                },
                "recommendations": [
                  "Monitor connection pool utilization",
                  "Optimize slow queries",
                  "Ensure Australian timezone compliance",
                  "Validate SSL encryption settings"
                ],
                "next_report": "$(date -d '+1 day' -u +%Y-%m-%dT%H:%M:%SZ)"
              }
              EOF
              
              # Run report generation
              generate_performance_report
              check_compliance_status
              
              # Store performance report
              kubectl create configmap database-performance-report-$(date +%Y%m%d) \
                --from-file=report.json=/tmp/database-performance-report.json \
                --from-literal="report_type=database_performance" \
                --from-literal="compliance_framework=australian-privacy-act" \
                --from-literal="data_residency=australia" \
                -n act-placemat --dry-run=client -o yaml | kubectl apply -f -
              
              echo "Database performance report completed at $(date)"
            resources:
              limits:
                cpu: 200m
                memory: 256Mi
              requests:
                cpu: 100m
                memory: 128Mi
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              runAsNonRoot: true
              runAsUser: 1001
              capabilities:
                drop:
                - ALL
            volumeMounts:
            - name: tmp
              mountPath: /tmp
          volumes:
          - name: tmp
            emptyDir: {}
          imagePullSecrets:
          - name: registry-credentials
          nodeSelector:
            data-residency: australia

---
# Database Performance Reporter Service Account
apiVersion: v1
kind: ServiceAccount
metadata:
  name: database-performance-reporter
  namespace: act-placemat
  labels:
    component: database
    role: performance-reporter
    data-residency: australia
  annotations:
    description: "Service account for database performance reporting"
    compliance.framework: "australian-privacy-act"
automountServiceAccountToken: true

---
# Database Performance Reporter RBAC Role
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: database-performance-reporter
  namespace: act-placemat
  labels:
    component: database
    data-residency: australia
  annotations:
    description: "Role for database performance reporting operations"
    compliance.framework: "australian-privacy-act"
rules:
# ConfigMap creation for performance reports
- apiGroups: [""]
  resources: ["configmaps"]
  verbs: ["create", "update", "patch"]
  resourceNames: ["database-performance-report-*"]

---
# Database Performance Reporter Role Binding
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: database-performance-reporter-binding
  namespace: act-placemat
  labels:
    component: database
    data-residency: australia
  annotations:
    description: "Binds database-performance-reporter to reporting role"
    compliance.framework: "australian-privacy-act"
subjects:
- kind: ServiceAccount
  name: database-performance-reporter
  namespace: act-placemat
roleRef:
  kind: Role
  name: database-performance-reporter
  apiGroup: rbac.authorization.k8s.io