# VPC Private Connectivity for Cloud SQL
# Secure private networking with Australian compliance

---
# VPC Network Configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: vpc-network-config
  namespace: act-placemat
  labels:
    component: networking
    network-type: vpc
    data-residency: australia
  annotations:
    description: "VPC network configuration for private Cloud SQL connectivity"
    compliance.framework: "australian-privacy-act"
data:
  network_config: |
    # VPC Network configuration
    vpc_network:
      name: "act-placemat-vpc"
      region: "australia-southeast1"
      auto_create_subnetworks: false
      routing_mode: "REGIONAL"
      
    # Subnets configuration
    subnets:
      # Primary subnet for GKE cluster
      - name: "act-placemat-gke-subnet"
        ip_cidr_range: "10.0.0.0/20"
        region: "australia-southeast1"
        secondary_ip_ranges:
          - range_name: "gke-pods"
            ip_cidr_range: "10.4.0.0/14"  # /14 for large pod network
          - range_name: "gke-services"
            ip_cidr_range: "10.8.0.0/20"
            
      # Private subnet for Cloud SQL
      - name: "act-placemat-database-subnet"
        ip_cidr_range: "10.1.0.0/24"
        region: "australia-southeast1"
        purpose: "PRIVATE"
        
      # Management subnet for monitoring and operations
      - name: "act-placemat-management-subnet"
        ip_cidr_range: "10.2.0.0/24"
        region: "australia-southeast1"
        
    # Private service access for Cloud SQL
    private_service_access:
      address_range: "10.3.0.0/24"
      service: "servicenetworking.googleapis.com"
      
    # Firewall rules
    firewall_rules:
      # Allow internal communication
      - name: "allow-internal-communication"
        direction: "INGRESS"
        source_ranges: ["10.0.0.0/8"]
        allowed:
          - protocol: "tcp"
            ports: ["0-65535"]
          - protocol: "udp"
            ports: ["0-65535"]
          - protocol: "icmp"
            
      # Allow PostgreSQL from GKE to Cloud SQL
      - name: "allow-postgres-from-gke"
        direction: "INGRESS"
        source_tags: ["gke-node"]
        target_tags: ["cloudsql-instance"]
        allowed:
          - protocol: "tcp"
            ports: ["5432"]
            
      # Allow health checks
      - name: "allow-health-checks"
        direction: "INGRESS"
        source_ranges: ["35.191.0.0/16", "130.211.0.0/22"]
        allowed:
          - protocol: "tcp"
            
      # Deny all external access to database subnet
      - name: "deny-external-database-access"
        direction: "INGRESS"
        source_ranges: ["0.0.0.0/0"]
        target_tags: ["database-subnet"]
        denied:
          - protocol: "tcp"
            ports: ["5432", "3306", "1433", "27017"]
        priority: 1000

  # Network security policies
  security_policies: |
    # Australian compliance network security
    compliance_policies:
      data_residency_enforcement:
        - "block_traffic_outside_australia"
        - "require_private_networking"
        - "audit_all_connections"
        
      encryption_requirements:
        - "require_tls_for_all_database_connections"
        - "enforce_ssl_certificates"
        - "validate_certificate_australia_ca"
        
      access_controls:
        - "deny_public_database_access"
        - "require_service_account_authentication"
        - "enforce_least_privilege_networking"

---
# Network Policy for Database Access
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: database-access-policy
  namespace: act-placemat
  labels:
    component: networking
    policy-type: database-access
    data-residency: australia
  annotations:
    description: "Network policy controlling database access"
    compliance.framework: "australian-privacy-act"
spec:
  podSelector:
    matchLabels:
      data-access: database
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow monitoring from prometheus
  - from:
    - podSelector:
        matchLabels:
          app: prometheus
    ports:
    - protocol: TCP
      port: 9090
  # Allow health checks
  - from:
    - podSelector:
        matchLabels:
          component: health-check
    ports:
    - protocol: TCP
      port: 5432
  egress:
  # Allow database connections
  - to: []
    ports:
    - protocol: TCP
      port: 5432
  # Allow DNS resolution
  - to: []
    ports:
    - protocol: UDP
      port: 53
  # Allow HTTPS for Cloud SQL Auth Proxy
  - to: []
    ports:
    - protocol: TCP
      port: 443

---
# Network Policy for Cloud SQL Proxy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: cloudsql-proxy-network-policy
  namespace: act-placemat
  labels:
    component: networking
    policy-type: cloudsql-proxy
    data-residency: australia
  annotations:
    description: "Network policy for Cloud SQL Proxy pods"
    compliance.framework: "australian-privacy-act"
spec:
  podSelector:
    matchLabels:
      component: cloudsql-proxy
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow connections from agent services
  - from:
    - podSelector:
        matchLabels:
          component: langgraph-agent
    - podSelector:
        matchLabels:
          component: financial-intelligence
    - podSelector:
        matchLabels:
          component: research-analyst
    - podSelector:
        matchLabels:
          component: compliance-officer
    - podSelector:
        matchLabels:
          component: community-coordinator
    ports:
    - protocol: TCP
      port: 5432
  # Allow health checks
  - from:
    - podSelector:
        matchLabels:
          component: health-check
    ports:
    - protocol: TCP
      port: 9090
  egress:
  # Allow outbound to Cloud SQL
  - to: []
    ports:
    - protocol: TCP
      port: 443
  # Allow DNS resolution
  - to: []
    ports:
    - protocol: UDP
      port: 53

---
# Private Service Connection Configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: private-service-connection-config
  namespace: act-placemat
  labels:
    component: networking
    connection-type: private-service
    data-residency: australia
  annotations:
    description: "Private service connection configuration for Cloud SQL"
    compliance.framework: "australian-privacy-act"
data:
  connection_config: |
    # Private service connection for Cloud SQL
    private_service_connection:
      name: "act-placemat-private-connection"
      network: "projects/act-placemat-intelligence-hub/global/networks/act-placemat-vpc"
      service: "servicenetworking.googleapis.com"
      reserved_peering_ranges:
        - "google-managed-services-act-placemat-vpc"
        
    # IP allocation for private services
    ip_allocation:
      name: "google-managed-services-act-placemat-vpc"
      network: "projects/act-placemat-intelligence-hub/global/networks/act-placemat-vpc"
      purpose: "VPC_PEERING"
      address_type: "INTERNAL"
      prefix_length: 24
      ip_version: "IPV4"
      region: "australia-southeast1"

  # Connection monitoring
  monitoring_config: |
    # Network connectivity monitoring
    connectivity_monitoring:
      health_checks:
        - name: "cloudsql-connectivity-check"
          type: "TCP"
          port: 5432
          check_interval_sec: 30
          timeout_sec: 5
          healthy_threshold: 2
          unhealthy_threshold: 3
          
      network_metrics:
        - "connection_count"
        - "connection_latency"
        - "packet_loss_rate"
        - "bandwidth_utilization"
        
      alerting:
        - metric: "connection_latency"
          threshold: "100ms"
          severity: "warning"
        - metric: "packet_loss_rate"
          threshold: "1%"
          severity: "critical"
        - metric: "connection_failures"
          threshold: "5/5m"
          severity: "critical"

---
# Network Monitoring Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: network-connectivity-monitor
  namespace: act-placemat
  labels:
    component: networking
    monitor-type: connectivity
    data-residency: australia
  annotations:
    description: "Network connectivity monitoring for Cloud SQL"
    compliance.framework: "australian-privacy-act"
spec:
  replicas: 1
  selector:
    matchLabels:
      component: network-connectivity-monitor
      data-residency: australia
  template:
    metadata:
      labels:
        component: network-connectivity-monitor
        data-residency: australia
      annotations:
        compliance.framework: "australian-privacy-act"
        data.classification: "restricted"
        audit.required: "true"
    spec:
      serviceAccountName: network-monitor-service
      securityContext:
        runAsNonRoot: true
        runAsUser: 1001
        fsGroup: 1001
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: "kubernetes.io/zone"
                operator: In
                values:
                - "australia-southeast1-a"
                - "australia-southeast1-b"
                - "australia-southeast1-c"
      containers:
      - name: connectivity-monitor
        image: registry.actplacemat.org.au:5000/act-placemat/network-monitor:latest
        imagePullPolicy: Always
        env:
        - name: TZ
          value: "Australia/Sydney"
        - name: DATA_RESIDENCY
          value: "australia"
        - name: COMPLIANCE_FRAMEWORK
          value: "australian-privacy-act"
        - name: TARGET_HOST
          value: "cloudsql-proxy-service.act-placemat.svc.cluster.local"
        - name: TARGET_PORT
          value: "5432"
        - name: CHECK_INTERVAL
          value: "30"
        ports:
        - name: metrics
          containerPort: 8080
          protocol: TCP
        - name: health
          containerPort: 8081
          protocol: TCP
        livenessProbe:
          httpGet:
            path: /health
            port: health
          initialDelaySeconds: 30
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /ready
            port: health
          initialDelaySeconds: 5
          periodSeconds: 10
        resources:
          limits:
            cpu: 200m
            memory: 512Mi
          requests:
            cpu: 100m
            memory: 256Mi
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          runAsNonRoot: true
          runAsUser: 1001
          capabilities:
            drop:
            - ALL
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: config
          mountPath: /etc/monitor-config
          readOnly: true
      volumes:
      - name: tmp
        emptyDir: {}
      - name: config
        configMap:
          name: private-service-connection-config
      imagePullSecrets:
      - name: registry-credentials
      nodeSelector:
        data-residency: australia

---
# Network Monitor Service Account
apiVersion: v1
kind: ServiceAccount
metadata:
  name: network-monitor-service
  namespace: act-placemat
  labels:
    component: networking
    role: monitor
    data-residency: australia
  annotations:
    description: "Service account for network connectivity monitoring"
    compliance.framework: "australian-privacy-act"
automountServiceAccountToken: true

---
# Network Monitor Service
apiVersion: v1
kind: Service
metadata:
  name: network-connectivity-monitor-metrics
  namespace: act-placemat
  labels:
    component: networking
    monitor-type: connectivity
    data-residency: australia
  annotations:
    description: "Metrics service for network connectivity monitoring"
    compliance.framework: "australian-privacy-act"
spec:
  selector:
    component: network-connectivity-monitor
    data-residency: australia
  ports:
  - name: metrics
    port: 8080
    targetPort: metrics
    protocol: TCP
  - name: health
    port: 8081
    targetPort: health
    protocol: TCP
  type: ClusterIP

---
# Network Connectivity ServiceMonitor
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: network-connectivity-monitoring
  namespace: act-placemat
  labels:
    component: networking
    monitor-type: connectivity
    data-residency: australia
  annotations:
    description: "Monitoring for network connectivity to Cloud SQL"
    compliance.framework: "australian-privacy-act"
spec:
  selector:
    matchLabels:
      component: networking
      monitor-type: connectivity
  endpoints:
  - port: metrics
    interval: 30s
    path: /metrics
    honorLabels: true
    relabelings:
    - sourceLabels: [__meta_kubernetes_pod_label_data_residency]
      targetLabel: data_residency
    - sourceLabels: [__meta_kubernetes_pod_annotation_compliance_framework]
      targetLabel: compliance_framework

---
# VPC Security Validation CronJob
apiVersion: batch/v1
kind: CronJob
metadata:
  name: vpc-security-validation
  namespace: act-placemat
  labels:
    component: networking
    operation: security-validation
    data-residency: australia
  annotations:
    description: "Validates VPC security configuration compliance"
    compliance.framework: "australian-privacy-act"
spec:
  schedule: "0 */6 * * *"  # Every 6 hours
  timeZone: "Australia/Sydney"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            component: vpc-security-validation
            data-residency: australia
        spec:
          serviceAccountName: network-security-validator
          restartPolicy: Never
          securityContext:
            runAsNonRoot: true
            runAsUser: 1001
            fsGroup: 1001
          containers:
          - name: security-validator
            image: google/cloud-sdk:alpine
            env:
            - name: TZ
              value: "Australia/Sydney"
            - name: DATA_RESIDENCY
              value: "australia"
            - name: COMPLIANCE_FRAMEWORK
              value: "australian-privacy-act"
            - name: PROJECT_ID
              value: "act-placemat-intelligence-hub"
            - name: VPC_NETWORK
              value: "act-placemat-vpc"
            command:
            - /bin/sh
            - -c
            - |
              echo "Starting VPC security validation at $(date)"
              
              # Function to validate network security
              validate_network_security() {
                echo "=== VPC Security Validation ==="
                
                # Check VPC network exists and is properly configured
                if gcloud compute networks describe "$VPC_NETWORK" --project="$PROJECT_ID" --format="value(name)" > /dev/null 2>&1; then
                  echo "âœ… VPC network exists: $VPC_NETWORK"
                else
                  echo "âŒ VPC network not found: $VPC_NETWORK"
                  return 1
                fi
                
                # Check private Google access is enabled
                PRIVATE_GOOGLE_ACCESS=$(gcloud compute networks subnets describe act-placemat-gke-subnet \
                  --region=australia-southeast1 \
                  --project="$PROJECT_ID" \
                  --format="value(privateIpGoogleAccess)" 2>/dev/null || echo "false")
                  
                if [ "$PRIVATE_GOOGLE_ACCESS" = "True" ]; then
                  echo "âœ… Private Google Access enabled"
                else
                  echo "âš ï¸ Private Google Access not enabled"
                fi
                
                # Check firewall rules for database access
                FIREWALL_RULES=$(gcloud compute firewall-rules list \
                  --filter="network:$VPC_NETWORK AND name:(postgres OR database)" \
                  --project="$PROJECT_ID" \
                  --format="value(name)" | wc -l)
                  
                if [ "$FIREWALL_RULES" -gt 0 ]; then
                  echo "âœ… Database firewall rules configured: $FIREWALL_RULES rules"
                else
                  echo "âš ï¸ No database-specific firewall rules found"
                fi
                
                # Check for external access prevention
                EXTERNAL_ACCESS_RULES=$(gcloud compute firewall-rules list \
                  --filter="network:$VPC_NETWORK AND sourceRanges:0.0.0.0/0 AND allowed.ports:(5432 OR 3306)" \
                  --project="$PROJECT_ID" \
                  --format="value(name)" | wc -l)
                  
                if [ "$EXTERNAL_ACCESS_RULES" -eq 0 ]; then
                  echo "âœ… No external database access rules found"
                else
                  echo "âŒ External database access detected: $EXTERNAL_ACCESS_RULES rules"
                  return 1
                fi
                
                # Check Cloud SQL instance private IP configuration
                CLOUDSQL_INSTANCES=$(gcloud sql instances list \
                  --filter="region:australia-southeast1" \
                  --project="$PROJECT_ID" \
                  --format="value(name)" | wc -l)
                  
                if [ "$CLOUDSQL_INSTANCES" -gt 0 ]; then
                  echo "âœ… Cloud SQL instances found in Australian region: $CLOUDSQL_INSTANCES"
                else
                  echo "âš ï¸ No Cloud SQL instances found in Australian region"
                fi
                
                return 0
              }
              
              # Function to validate Australian compliance
              validate_australian_compliance() {
                echo "=== Australian Compliance Validation ==="
                
                # Check data residency - all resources in Australian regions
                NON_AU_RESOURCES=$(gcloud compute instances list \
                  --filter="NOT zone:(australia-southeast1)" \
                  --project="$PROJECT_ID" \
                  --format="value(name)" | wc -l)
                  
                if [ "$NON_AU_RESOURCES" -eq 0 ]; then
                  echo "âœ… All compute resources in Australian zones"
                else
                  echo "âŒ Non-Australian resources detected: $NON_AU_RESOURCES"
                  return 1
                fi
                
                # Check SSL/TLS enforcement
                SSL_POLICIES=$(gcloud compute ssl-policies list \
                  --project="$PROJECT_ID" \
                  --format="value(name)" | wc -l)
                  
                if [ "$SSL_POLICIES" -gt 0 ]; then
                  echo "âœ… SSL policies configured: $SSL_POLICIES policies"
                else
                  echo "âš ï¸ No SSL policies found"
                fi
                
                return 0
              }
              
              # Run validation checks
              VALIDATION_FAILURES=0
              
              if ! validate_network_security; then
                VALIDATION_FAILURES=$((VALIDATION_FAILURES + 1))
              fi
              
              if ! validate_australian_compliance; then
                VALIDATION_FAILURES=$((VALIDATION_FAILURES + 1))
              fi
              
              # Generate validation report
              if [ $VALIDATION_FAILURES -eq 0 ]; then
                OVERALL_STATUS="COMPLIANT"
                echo "ðŸŽ‰ All VPC security validations passed"
              else
                OVERALL_STATUS="NON_COMPLIANT"
                echo "âš ï¸ $VALIDATION_FAILURES validation(s) failed"
              fi
              
              # Create validation report
              cat > /tmp/vpc-security-validation-report.json << EOF
              {
                "validation_time": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
                "overall_status": "$OVERALL_STATUS",
                "compliance_framework": "Australian Privacy Act 1988",
                "data_residency": "australia",
                "validation_failures": $VALIDATION_FAILURES,
                "vpc_network": "$VPC_NETWORK",
                "next_validation": "$(date -d '+6 hours' -u +%Y-%m-%dT%H:%M:%SZ)"
              }
              EOF
              
              # Store validation report
              kubectl create configmap vpc-security-validation-report-$(date +%Y%m%d-%H%M) \
                --from-file=report.json=/tmp/vpc-security-validation-report.json \
                --from-literal="overall_status=$OVERALL_STATUS" \
                --from-literal="validation_failures=$VALIDATION_FAILURES" \
                --from-literal="compliance_framework=australian-privacy-act" \
                --from-literal="data_residency=australia" \
                -n act-placemat --dry-run=client -o yaml | kubectl apply -f - 2>/dev/null || true
              
              echo "VPC security validation completed at $(date)"
              echo "Overall status: $OVERALL_STATUS"
              
              # Exit with appropriate code
              exit $VALIDATION_FAILURES
            resources:
              limits:
                cpu: 200m
                memory: 512Mi
              requests:
                cpu: 100m
                memory: 256Mi
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              runAsNonRoot: true
              runAsUser: 1001
              capabilities:
                drop:
                - ALL
            volumeMounts:
            - name: tmp
              mountPath: /tmp
            - name: gcp-credentials
              mountPath: /var/secrets/google
              readOnly: true
          volumes:
          - name: tmp
            emptyDir: {}
          - name: gcp-credentials
            secret:
              secretName: network-security-validator-gcp-credentials
          imagePullSecrets:
          - name: registry-credentials
          nodeSelector:
            data-residency: australia

---
# Network Security Validator Service Account
apiVersion: v1
kind: ServiceAccount
metadata:
  name: network-security-validator
  namespace: act-placemat
  labels:
    component: networking
    role: security-validator
    data-residency: australia
  annotations:
    description: "Service account for VPC security validation"
    compliance.framework: "australian-privacy-act"
    iam.gke.io/gcp-service-account: "network-security-validator@act-placemat-intelligence-hub.iam.gserviceaccount.com"
automountServiceAccountToken: true

---
# Network Security Validator RBAC Role
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: network-security-validator
  namespace: act-placemat
  labels:
    component: networking
    data-residency: australia
  annotations:
    description: "Role for VPC security validation operations"
    compliance.framework: "australian-privacy-act"
rules:
# ConfigMap creation for validation reports
- apiGroups: [""]
  resources: ["configmaps"]
  verbs: ["create", "update", "patch"]
  resourceNames: ["vpc-security-validation-report-*"]
# Event creation for validation results
- apiGroups: [""]
  resources: ["events"]
  verbs: ["create", "patch"]

---
# Network Security Validator Role Binding
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: network-security-validator-binding
  namespace: act-placemat
  labels:
    component: networking
    data-residency: australia
  annotations:
    description: "Binds network-security-validator to validation role"
    compliance.framework: "australian-privacy-act"
subjects:
- kind: ServiceAccount
  name: network-security-validator
  namespace: act-placemat
roleRef:
  kind: Role
  name: network-security-validator
  apiGroup: rbac.authorization.k8s.io