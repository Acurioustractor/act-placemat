// ACT Placemat Prisma Schema
// This is your main database schema file for ACT Placemat

generator client {
  provider = "prisma-client-js"
  output   = "../../packages/database/generated/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User Management
model User {
  id       String  @id @default(cuid())
  email    String  @unique
  name     String
  avatar   String?
  bio      String?
  location String?
  website  String?

  // Authentication
  emailVerified DateTime?
  role          UserRole  @default(MEMBER)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  stories       Story[]
  projects      ProjectMember[]
  comments      Comment[]
  opportunities OpportunityApplication[]

  // Life OS Relations
  lifeOSProfile   LifeOSProfile?
  calendarEvents  CalendarEvent[]
  eventAttendance EventAttendee[]

  // Community engagement
  skills    String[]
  interests String[]

  @@map("users")
}

model Project {
  id          String  @id @default(cuid())
  title       String
  description String
  content     String?

  // Project details
  status     ProjectStatus @default(ACTIVE)
  visibility Visibility    @default(PUBLIC)
  category   String?
  tags       String[]

  // Location
  location    String?
  region      String?
  coordinates Json? // {lat, lng}

  // Media
  coverImage String?
  images     String[]
  documents  String[]

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  startDate DateTime?
  endDate   DateTime?

  // Relations
  members        ProjectMember[]
  stories        Story[]
  opportunities  Opportunity[]
  calendarEvents CalendarEvent[]

  @@map("projects")
}

model ProjectMember {
  id        String      @id @default(cuid())
  userId    String
  projectId String
  role      ProjectRole @default(MEMBER)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([userId, projectId])
  @@map("project_members")
}

model Story {
  id      String  @id @default(cuid())
  title   String
  content String
  excerpt String?

  // Story metadata
  status     StoryStatus @default(DRAFT)
  visibility Visibility  @default(PUBLIC)
  category   String?
  tags       String[]

  // Media
  coverImage String?
  images     String[]

  // SEO
  slug            String  @unique
  metaTitle       String?
  metaDescription String?

  // Analytics
  viewCount  Int @default(0)
  shareCount Int @default(0)

  // Author and project
  authorId  String
  projectId String?

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime?

  // Relations
  author   User      @relation(fields: [authorId], references: [id], onDelete: Cascade)
  project  Project?  @relation(fields: [projectId], references: [id], onDelete: SetNull)
  comments Comment[]

  @@map("stories")
}

model Comment {
  id      String @id @default(cuid())
  content String

  // Moderation
  status CommentStatus @default(APPROVED)

  // Relations
  authorId String
  storyId  String
  parentId String? // For nested comments

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  author  User      @relation(fields: [authorId], references: [id], onDelete: Cascade)
  story   Story     @relation(fields: [storyId], references: [id], onDelete: Cascade)
  parent  Comment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies Comment[] @relation("CommentReplies")

  @@map("comments")
}

model Opportunity {
  id          String  @id @default(cuid())
  title       String
  description String
  content     String?

  // Opportunity details
  type     OpportunityType
  status   OpportunityStatus @default(OPEN)
  category String?
  tags     String[]

  // Requirements
  skills         String[]
  timeCommitment String?
  location       String?
  remote         Boolean  @default(false)

  // Compensation
  isPaid       Boolean @default(false)
  compensation String?

  // Timeline
  deadline  DateTime?
  startDate DateTime?
  duration  String?

  // Media
  coverImage String?
  images     String[]

  // Project relation
  projectId String?

  // Contact
  contactEmail   String?
  contactPhone   String?
  applicationUrl String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  project      Project?                 @relation(fields: [projectId], references: [id], onDelete: SetNull)
  applications OpportunityApplication[]

  @@map("opportunities")
}

model OpportunityApplication {
  id        String  @id @default(cuid())
  message   String
  resume    String?
  portfolio String?

  status ApplicationStatus @default(PENDING)

  userId        String
  opportunityId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  opportunity Opportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)

  @@unique([userId, opportunityId])
  @@map("opportunity_applications")
}

// Analytics and Tracking
model PageView {
  id        String  @id @default(cuid())
  path      String
  userAgent String?
  ipAddress String?
  referer   String?

  // Session tracking
  sessionId String?
  userId    String?

  createdAt DateTime @default(now())

  @@map("page_views")
}

model SearchQuery {
  id      String  @id @default(cuid())
  query   String
  results Int     @default(0)
  userId  String?

  createdAt DateTime @default(now())

  @@map("search_queries")
}

// System Configuration
model Setting {
  id    String @id
  value Json

  updatedAt DateTime @updatedAt

  @@map("settings")
}

// Media Management
model Media {
  id           String @id @default(cuid())
  filename     String
  originalName String
  mimeType     String
  size         Int
  url          String

  // Metadata
  alt     String?
  caption String?

  // File info
  width    Int?
  height   Int?
  duration Int? // For videos in seconds

  // Relations
  uploadedById String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("media")
}

// Enums
enum UserRole {
  MEMBER
  MODERATOR
  ADMIN
  SUPER_ADMIN
}

enum ProjectRole {
  MEMBER
  CONTRIBUTOR
  LEAD
  OWNER
}

enum ProjectStatus {
  DRAFT
  ACTIVE
  COMPLETED
  PAUSED
  ARCHIVED
}

enum StoryStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum Visibility {
  PUBLIC
  PRIVATE
  COMMUNITY_ONLY
}

enum CommentStatus {
  PENDING
  APPROVED
  REJECTED
  SPAM
}

enum OpportunityType {
  VOLUNTEER
  JOB
  COLLABORATION
  FUNDING
  MENTORSHIP
  SKILL_SHARE
}

enum OpportunityStatus {
  DRAFT
  OPEN
  CLOSED
  FILLED
  CANCELLED
}

enum ApplicationStatus {
  PENDING
  REVIEWING
  ACCEPTED
  REJECTED
  WITHDRAWN
}

// =================================================================
// LIFE OS MODELS - Beautiful Obsolescence Platform Extensions
// =================================================================

// Life OS User Profile Extensions
model LifeOSProfile {
  id     String @id @default(cuid())
  userId String @unique

  // Life OS specific preferences
  timezone String @default("Australia/Sydney")
  locale   String @default("en-AU")
  currency String @default("AUD")

  // Personalisation settings
  themePreference      String @default("auto") // auto, light, dark
  notificationSettings Json   @default("{}")
  privacySettings      Json   @default("{}")

  // Beautiful Obsolescence alignment
  extractiveSystemsTargeting Boolean @default(true)
  communityControlEnabled    Boolean @default(true)
  dataResidencyPreference    String  @default("Australia")

  // Onboarding and activation
  onboardingCompleted Boolean   @default(false)
  lastActiveAt        DateTime  @default(now())
  activationDate      DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user         User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  habits       Habit[]
  goals        Goal[]
  moodEntries  MoodEntry[]
  meditations  MeditationSession[]
  journals     Journal[]
  transactions FinancialTransaction[]
  budgets      Budget[]

  @@map("life_os_profiles")
}

// Habit Tracking System
model Habit {
  id        String @id @default(cuid())
  profileId String

  // Habit definition
  name        String
  description String?
  category    String? // health, productivity, mindfulness, social

  // Tracking configuration
  frequency   HabitFrequency @default(DAILY)
  targetValue Int            @default(1) // times per frequency period
  unit        String? // glasses, minutes, pages, etc.

  // Habit settings
  color    String? // for UI representation
  icon     String? // emoji or icon identifier
  reminder Json? // reminder settings
  isActive Boolean @default(true)

  // Streak tracking
  currentStreak     Int       @default(0)
  longestStreak     Int       @default(0)
  lastCompletedDate DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  profile     LifeOSProfile     @relation(fields: [profileId], references: [id], onDelete: Cascade)
  completions HabitCompletion[]

  @@map("habits")
}

model HabitCompletion {
  id      String @id @default(cuid())
  habitId String

  // Completion details
  completedAt DateTime @default(now())
  value       Int      @default(1) // actual value completed
  notes       String?

  // Quality metrics
  satisfaction Int? // 1-5 rating
  difficulty   Int? // 1-5 rating

  habit Habit @relation(fields: [habitId], references: [id], onDelete: Cascade)

  @@unique([habitId, completedAt])
  @@map("habit_completions")
}

// Goal Management System
model Goal {
  id        String @id @default(cuid())
  profileId String

  // SMART goal attributes
  title       String
  description String?
  category    String?

  // Measurable criteria
  targetValue  Float?
  currentValue Float   @default(0)
  unit         String?

  // Time-bound attributes
  startDate   DateTime  @default(now())
  targetDate  DateTime?
  completedAt DateTime?

  // Goal status and priority
  status   GoalStatus @default(ACTIVE)
  priority Priority   @default(MEDIUM)

  // Progress tracking
  progress Float @default(0) // 0-100 percentage

  // Motivation and accountability
  motivation    String?
  visualisation String? // image URL or description

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  profile    LifeOSProfile   @relation(fields: [profileId], references: [id], onDelete: Cascade)
  milestones GoalMilestone[]
  updates    GoalUpdate[]

  @@map("goals")
}

model GoalMilestone {
  id     String @id @default(cuid())
  goalId String

  title       String
  description String?
  targetDate  DateTime?
  completedAt DateTime?

  // Milestone value/progress
  targetValue  Float?
  currentValue Float  @default(0)

  status MilestoneStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  goal Goal @relation(fields: [goalId], references: [id], onDelete: Cascade)

  @@map("goal_milestones")
}

model GoalUpdate {
  id     String @id @default(cuid())
  goalId String

  content String
  value   Float? // progress value update

  createdAt DateTime @default(now())

  goal Goal @relation(fields: [goalId], references: [id], onDelete: Cascade)

  @@map("goal_updates")
}

// Mindfulness and Wellbeing System
model MeditationSession {
  id        String @id @default(cuid())
  profileId String

  // Session details
  duration      Int // seconds
  technique     String? // mindfulness, breathing, body scan, etc.
  guidedSession Boolean @default(false)
  guideUrl      String? // audio/video guide URL

  // Session quality
  rating Int? // 1-5 rating
  notes  String?
  mood   String?

  // Environment
  location     String?
  distractions String?

  createdAt DateTime @default(now())

  profile LifeOSProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@map("meditation_sessions")
}

model MoodEntry {
  id        String @id @default(cuid())
  profileId String

  // Mood assessment
  mood      String // happy, sad, anxious, calm, energetic, etc.
  intensity Int // 1-10 scale
  emotions  String[] // array of emotion tags

  // Context
  activities String[] // what was happening
  location   String?
  weather    String?

  // Notes and reflection
  notes     String?
  triggers  String?
  gratitude String?

  recordedAt DateTime @default(now())
  createdAt  DateTime @default(now())

  profile LifeOSProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@map("mood_entries")
}

model Journal {
  id        String @id @default(cuid())
  profileId String

  title   String?
  content String

  // Journal metadata
  mood      String?
  tags      String[]
  isPrivate Boolean  @default(true)

  // Template-based entries
  template String? // gratitude, reflection, planning
  prompts  Json? // structured prompts and responses

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  profile LifeOSProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@map("journals")
}

// Calendar and Event Management
model CalendarEvent {
  id     String @id @default(cuid())
  userId String

  title       String
  description String?

  // Event timing
  startTime DateTime
  endTime   DateTime?
  isAllDay  Boolean   @default(false)

  // Event details
  location String?
  url      String?
  category String?
  color    String?

  // Recurrence
  isRecurring    Boolean @default(false)
  recurrenceRule String? // RRULE format
  parentEventId  String? // for recurring event instances

  // Event type and privacy
  eventType  EventType  @default(PERSONAL)
  visibility Visibility @default(PRIVATE)

  // Community integration
  projectId      String? // link to community projects
  communityEvent Boolean @default(false)

  // Reminders and notifications
  reminders Json @default("[]") // array of reminder settings

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  project   Project?        @relation(fields: [projectId], references: [id], onDelete: SetNull)
  attendees EventAttendee[]

  @@map("calendar_events")
}

model EventAttendee {
  id      String @id @default(cuid())
  eventId String
  userId  String

  status   AttendeeStatus @default(PENDING)
  response String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  event CalendarEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user  User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@map("event_attendees")
}

// Financial Management System
model FinancialTransaction {
  id        String @id @default(cuid())
  profileId String

  // Transaction details
  amount      Float
  currency    String  @default("AUD")
  description String
  notes       String?

  // Transaction classification
  type        TransactionType
  category    String
  subcategory String?

  // Transaction metadata
  merchant      String?
  location      String?
  paymentMethod String?

  // Budgeting and tracking
  budgetId String?
  tags     String[]

  // Australian compliance
  gstAmount   Float? // GST component for Australian tax
  taxCategory String? // business, personal, deductible

  transactionDate DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  profile LifeOSProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  budget  Budget?       @relation(fields: [budgetId], references: [id], onDelete: SetNull)

  @@map("financial_transactions")
}

model Budget {
  id        String @id @default(cuid())
  profileId String

  name        String
  description String?

  // Budget parameters
  totalAmount Float
  spentAmount Float        @default(0)
  period      BudgetPeriod @default(MONTHLY)

  // Budget timing
  startDate DateTime  @default(now())
  endDate   DateTime?

  // Budget categories
  categories Json @default("[]") // array of category allocations

  // Status and alerts
  isActive       Boolean @default(true)
  alertThreshold Float   @default(0.8) // alert at 80% spent

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  profile      LifeOSProfile          @relation(fields: [profileId], references: [id], onDelete: Cascade)
  transactions FinancialTransaction[]

  @@map("budgets")
}

// Life OS Enums
enum HabitFrequency {
  DAILY
  WEEKLY
  MONTHLY
  CUSTOM
}

enum GoalStatus {
  DRAFT
  ACTIVE
  ON_HOLD
  COMPLETED
  CANCELLED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum MilestoneStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum EventType {
  PERSONAL
  WORK
  COMMUNITY
  HEALTH
  EDUCATION
  SOCIAL
}

enum AttendeeStatus {
  PENDING
  ACCEPTED
  DECLINED
  TENTATIVE
}

enum TransactionType {
  INCOME
  EXPENSE
  TRANSFER
  INVESTMENT
}

enum BudgetPeriod {
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
  CUSTOM
}
