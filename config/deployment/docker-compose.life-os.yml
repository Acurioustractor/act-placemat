# Life OS Development Stack - Beautiful Obsolescence Platform
# Extends ACT Placemat infrastructure with Life OS applications
# Use with: docker-compose -f docker-compose.yml -f docker-compose.life-os.yml up

services:
  # Life OS Web Application - Next.js 14+ with App Router
  life-os-web:
    build:
      context: .
      dockerfile: ./apps/life-os-web/Dockerfile
      target: runner
    container_name: life-os-web
    restart: unless-stopped
    environment:
      - NODE_ENV=development
      - PORT=3010
      - TZ=Australia/Sydney
      - LOCALE=en-AU
      - CURRENCY=AUD
      - DATA_RESIDENCY=Australia
      - NEXT_TELEMETRY_DISABLED=1
      # Database connections
      - DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD}@postgres:5432/life_os_web
      - REDIS_URL=redis://redis:6379
      # API endpoints
      - API_BASE_URL=http://api-gateway:3000
      - INTELLIGENCE_HUB_URL=http://intelligence-hub:3002
      - AI_WORKHOUSE_URL=http://ai-workhouse:3003
      # Beautiful Obsolescence configuration
      - BEAUTIFUL_OBSOLESCENCE_TARGET=2027
      - COMMUNITY_CONTROL_ENABLED=true
      - EXTRACTIVE_SYSTEMS_TARGETING=enabled
      # Life OS specific
      - HABITS_TRACKING_ENABLED=true
      - GOALS_MANAGEMENT_ENABLED=true
      - MINDFULNESS_INTEGRATION=true
      - AUSTRALIAN_VALUES_COMPLIANCE=strict
    ports:
      - "3010:3000"
    depends_on:
      - postgres
      - redis
      - api-gateway
    networks:
      - web-network
      - intelligence-network
      - life-os-network
    volumes:
      - ./apps/life-os-web:/app/apps/life-os-web
      - ./packages:/app/packages
      - /app/apps/life-os-web/node_modules
      - /app/node_modules
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/hello"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    labels:
      - "act.service=life-os-web"
      - "act.role=user-interface"
      - "act.beautiful-obsolescence=2027"
      - "act.community-control=enabled"
      - "act.extractive-obsolescence=true"
      - "act.australian-values=strict"

  # Life OS Mobile Development Server - React Native with Expo
  life-os-mobile:
    build:
      context: .
      dockerfile: ./apps/life-os-mobile/Dockerfile.dev
    container_name: life-os-mobile
    restart: unless-stopped
    environment:
      - NODE_ENV=development
      - EXPO_DEVTOOLS_LISTEN_ADDRESS=0.0.0.0
      - EXPO_DEV_SERVER_URL=http://localhost:8081
      - TZ=Australia/Sydney
      - LOCALE=en-AU
      - DATA_RESIDENCY=Australia
      # API endpoints
      - API_BASE_URL=http://host.docker.internal:3000
      - LIFE_OS_WEB_URL=http://host.docker.internal:3010
      # Beautiful Obsolescence configuration
      - BEAUTIFUL_OBSOLESCENCE_TARGET=2027
      - COMMUNITY_CONTROL_ENABLED=true
      - OFFLINE_FIRST_ENABLED=true
    ports:
      - "8081:8081" # Metro bundler
      - "19000:19000" # Expo DevTools
      - "19001:19001" # Expo CLI
      - "19002:19002" # Expo Tunnel
    networks:
      - life-os-network
    volumes:
      - ./apps/life-os-mobile:/app/apps/life-os-mobile
      - ./packages:/app/packages
      - /app/apps/life-os-mobile/node_modules
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    labels:
      - "act.service=life-os-mobile"
      - "act.role=mobile-development"
      - "act.beautiful-obsolescence=2027"
      - "act.community-control=enabled"

  # Life OS Desktop Development - Electron with X11 forwarding
  life-os-desktop:
    build:
      context: .
      dockerfile: ./apps/life-os-desktop/Dockerfile.dev
    container_name: life-os-desktop
    restart: unless-stopped
    environment:
      - NODE_ENV=development
      - ELECTRON_IS_DEV=1
      - DISPLAY=:99
      - TZ=Australia/Sydney
      - LOCALE=en-AU
      - DATA_RESIDENCY=Australia
      # API endpoints
      - API_BASE_URL=http://host.docker.internal:3000
      - LIFE_OS_WEB_URL=http://host.docker.internal:3010
      # Beautiful Obsolescence configuration
      - BEAUTIFUL_OBSOLESCENCE_TARGET=2027
      - COMMUNITY_CONTROL_ENABLED=true
      - DESKTOP_INTEGRATION=native
    ports:
      - "5173:5173" # Vite dev server if used
    networks:
      - life-os-network
    volumes:
      - ./apps/life-os-desktop:/app/apps/life-os-desktop
      - ./packages:/app/packages
      - /app/apps/life-os-desktop/node_modules
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - SYS_ADMIN # Required for GUI applications
    labels:
      - "act.service=life-os-desktop"
      - "act.role=desktop-development"
      - "act.beautiful-obsolescence=2027"
      - "act.community-control=enabled"

  # Life OS Database - PostgreSQL with Life OS schemas
  life-os-postgres:
    image: postgres:16-alpine
    container_name: life-os-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_DB=life_os
      - POSTGRES_USER=life_os_user
      - POSTGRES_PASSWORD=${LIFE_OS_DB_PASSWORD:-lifeos2027password}
      - TZ=Australia/Sydney
      - PGTZ=Australia/Sydney
    volumes:
      - life-os-postgres-data:/var/lib/postgresql/data
      - ./apps/life-os-web/database:/docker-entrypoint-initdb.d:ro
    ports:
      - "5433:5432"
    networks:
      - life-os-network
      - database-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U life_os_user -d life_os"]
      interval: 10s
      timeout: 5s
      retries: 5
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - SETUID
      - SETGID
      - DAC_OVERRIDE
    labels:
      - "act.service=life-os-postgres"
      - "act.role=life-os-database"
      - "act.data-residency=australia"
      - "act.beautiful-obsolescence=2027"

  # Life OS API Gateway - Node.js backend for Life OS services
  life-os-api:
    build:
      context: ./apps/backend
      dockerfile: Dockerfile.dev
    container_name: life-os-api
    restart: unless-stopped
    environment:
      - NODE_ENV=development
      - PORT=3011
      - TZ=Australia/Sydney
      - LOCALE=en-AU
      - DATA_RESIDENCY=Australia
      # Database connections
      - DATABASE_URL=postgresql://life_os_user:${LIFE_OS_DB_PASSWORD:-lifeos2027password}@life-os-postgres:5432/life_os
      - REDIS_URL=redis://redis:6379
      # External integrations
      - MAIN_API_URL=http://api-gateway:3000
      - INTELLIGENCE_HUB_URL=http://intelligence-hub:3002
      # Beautiful Obsolescence configuration
      - BEAUTIFUL_OBSOLESCENCE_TARGET=2027
      - COMMUNITY_CONTROL_ENABLED=true
      - VALUES_COMPLIANCE_URL=http://values-compliance:3001
    ports:
      - "3011:3011"
    depends_on:
      - life-os-postgres
      - redis
      - values-compliance
    networks:
      - life-os-network
      - intelligence-network
      - database-network
    volumes:
      - ./apps/backend:/app
      - /app/node_modules
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3011/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    labels:
      - "act.service=life-os-api"
      - "act.role=life-os-backend"
      - "act.beautiful-obsolescence=2027"
      - "act.community-control=enabled"

# Extended Network Configuration
networks:
  # Life OS specific network
  life-os-network:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: life-os-br
    ipam:
      config:
        - subnet: 172.25.1.0/24
          gateway: 172.25.1.1
    labels:
      - "purpose=life-os-applications"
      - "security-zone=life-os"
      - "data-residency=australia"
      - "beautiful-obsolescence=2027"
      - "community-control=enabled"

  # Connect to existing networks (defined in main docker-compose.yml)
  web-network:
    external: true
    name: act-placemat_web-network

  intelligence-network:
    external: true
    name: act-placemat_intelligence-network

  database-network:
    external: true
    name: act-placemat_database-network

# Life OS Persistent Volumes
volumes:
  # Life OS PostgreSQL data
  life-os-postgres-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/act-placemat/data/life-os-postgres
    labels:
      - "service=life-os-postgres"
      - "data-residency=australia"
      - "backup-required=true"
      - "encryption-required=true"
      - "beautiful-obsolescence=2027"

  # Life OS application logs
  life-os-logs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/act-placemat/logs/life-os
    labels:
      - "service=life-os"
      - "data-residency=australia"
      - "retention-period=30d"
      - "beautiful-obsolescence=2027"

  # Life OS user data (habits, goals, etc.)
  life-os-user-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/act-placemat/data/life-os-user-data
    labels:
      - "service=life-os"
      - "data-residency=australia"
      - "backup-required=true"
      - "encryption-required=true"
      - "privacy-critical=true"
      - "beautiful-obsolescence=2027"
      - "community-control=enabled"
