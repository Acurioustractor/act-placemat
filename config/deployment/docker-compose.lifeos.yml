# Life OS Database Orchestra Configuration
# Comprehensive database setup for ACT Life Operating System
# PostgreSQL 16+ | Neo4j 5.x | Redis 7+ with Australian compliance

services:
  # PostgreSQL 16+ - Primary relational database for Life OS
  lifeos-postgres:
    image: postgres:16-alpine
    container_name: lifeos-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_DB=lifeos_database
      - POSTGRES_USER=lifeos_user
      - POSTGRES_PASSWORD=${LIFEOS_POSTGRES_PASSWORD:-lifeos_secure_password_2024}
      - TZ=Australia/Sydney
      - PGTZ=Australia/Sydney
      # Performance optimization
      - POSTGRES_INITDB_ARGS=--encoding=UTF8 --locale=en_AU.UTF-8 --data-checksums
      # Australian compliance logging
      - POSTGRES_LOG_TIMEZONE=Australia/Sydney
      - POSTGRES_LOG_MIN_DURATION_STATEMENT=1000
      - POSTGRES_LOG_CONNECTIONS=on
      - POSTGRES_LOG_DISCONNECTIONS=on
    ports:
      - "${LIFEOS_POSTGRES_PORT:-5433}:5432"
    volumes:
      # Data persistence with Australian data residency
      - lifeos-postgres-data:/var/lib/postgresql/data
      # Configuration files
      - ./docker/postgres/postgresql-lifeos.conf:/etc/postgresql/postgresql.conf:ro
      # Initialization scripts
      - ./infrastructure/prisma/migrations:/docker-entrypoint-initdb.d/migrations:ro
      - ./infrastructure/neo4j/setup.cypher:/docker-entrypoint-initdb.d/neo4j-setup.cypher:ro
      # Life OS specific initialization
      - ./docker/postgres/lifeos-init.sql:/docker-entrypoint-initdb.d/01-lifeos-init.sql:ro
      - ./docker/postgres/lifeos-seed-data.sql:/docker-entrypoint-initdb.d/99-lifeos-seed-data.sql:ro
    networks:
      - lifeos-network
      - database-network
    command: >
      postgres 
      -c config_file=/etc/postgresql/postgresql.conf
      -c log_destination=stderr
      -c logging_collector=on
      -c log_directory=/var/lib/postgresql/data/log
      -c log_filename=postgresql-%Y-%m-%d_%H%M%S.log
      -c log_rotation_age=1d
      -c log_rotation_size=100MB
      -c log_min_duration_statement=1000ms
      -c log_line_prefix='%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U lifeos_user -d lifeos_database"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - SETUID
      - SETGID
      - DAC_OVERRIDE
    labels:
      - "act.service=lifeos-postgres"
      - "act.environment=lifeos"
      - "act.data-residency=australia"
      - "act.beautiful-obsolescence=enabled"
      - "act.community-control=enabled"

  # Neo4j 5.x - Graph database for relationships and community networks
  lifeos-neo4j:
    image: neo4j:5.21-community
    container_name: lifeos-neo4j
    restart: unless-stopped
    environment:
      # Authentication
      - NEO4J_AUTH=neo4j/${LIFEOS_NEO4J_PASSWORD:-neo4j_secure_password_2024}
      # Plugins for graph analytics and procedures (disabled for initial setup)
      # - NEO4J_PLUGINS=["apoc", "graph-data-science"]
      # - NEO4J_dbms_security_procedures_unrestricted=apoc.*,gds.*
      # - NEO4J_dbms_security_procedures_allowlist=apoc.*,gds.*
      # File import/export for Life OS data (disabled for initial setup)
      # - NEO4J_apoc_export_file_enabled=true
      # - NEO4J_apoc_import_file_enabled=true
      # - NEO4J_apoc_import_file_use__neo4j__config=true
      # Memory configuration for Life OS analytics
      - NEO4J_dbms_memory_heap_initial__size=1G
      - NEO4J_dbms_memory_heap_max__size=4G
      - NEO4J_dbms_memory_pagecache_size=2G
      # Australian timezone
      - TZ=Australia/Sydney
      # Performance settings
      - NEO4J_dbms_connectors_default__listen__address=0.0.0.0
      - NEO4J_dbms_connector_bolt_listen__address=0.0.0.0:7687
      - NEO4J_dbms_connector_http_listen__address=0.0.0.0:7474
      # Security settings for Beautiful Obsolescence compliance
      - NEO4J_dbms_security_auth__minimum__password__length=12
    ports:
      - "${LIFEOS_NEO4J_HTTP_PORT:-7475}:7474"   # Neo4j Browser
      - "${LIFEOS_NEO4J_BOLT_PORT:-7688}:7687"   # Bolt connector
    volumes:
      # Data persistence with Australian data residency
      - lifeos-neo4j-data:/data
      - lifeos-neo4j-logs:/logs
      - lifeos-neo4j-import:/var/lib/neo4j/import
      - lifeos-neo4j-plugins:/plugins
    networks:
      - lifeos-network
      - knowledge-graph-network
    depends_on:
      - lifeos-postgres
    healthcheck:
      test: ["CMD-SHELL", "cypher-shell -u neo4j -p ${LIFEOS_NEO4J_PASSWORD:-neo4j_secure_password_2024} 'RETURN 1 AS health_check'"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - DAC_OVERRIDE
      - FOWNER
      - SETGID
      - SETUID
    labels:
      - "act.service=lifeos-neo4j"
      - "act.environment=lifeos"
      - "act.data-residency=australia"
      - "act.beautiful-obsolescence=enabled"
      - "act.community-networks=enabled"
      - "act.graph-analytics=enabled"

  # Redis 7+ - Caching and session management for Life OS
  lifeos-redis:
    image: redis:7-alpine
    container_name: lifeos-redis
    restart: unless-stopped
    environment:
      - TZ=Australia/Sydney
    command: >
      redis-server
      --appendonly yes
      --appendfsync everysec
      --maxmemory 2gb
      --maxmemory-policy allkeys-lru
      --requirepass ${LIFEOS_REDIS_PASSWORD:-redis_secure_password_2024}
      --save 900 1
      --save 300 10
      --save 60 10000
      --tcp-keepalive 300
      --timeout 0
      --tcp-backlog 511
      --databases 16
      --logfile "/data/redis.log"
      --loglevel notice
    ports:
      - "${LIFEOS_REDIS_PORT:-6380}:6379"
    volumes:
      # Data persistence with Australian data residency
      - lifeos-redis-data:/data
      # Configuration
      - ./docker/redis/redis-lifeos.conf:/usr/local/etc/redis/redis.conf:ro
    networks:
      - lifeos-network
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${LIFEOS_REDIS_PASSWORD:-redis_secure_password_2024}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - SETUID
      - SETGID
    read_only: true
    tmpfs:
      - /tmp
      - /var/run
    labels:
      - "act.service=lifeos-redis"
      - "act.environment=lifeos"
      - "act.data-residency=australia"
      - "act.beautiful-obsolescence=enabled"
      - "act.caching-layer=enabled"

  # Database Administration and Monitoring Service
  lifeos-admin:
    image: postgres:16-alpine
    container_name: lifeos-admin
    restart: "no"
    environment:
      - PGPASSFILE=/root/.pgpass
      - TZ=Australia/Sydney
    volumes:
      # Administrative scripts
      - ./scripts/database/lifeos-backup.sh:/usr/local/bin/lifeos-backup.sh:ro
      - ./scripts/database/lifeos-restore.sh:/usr/local/bin/lifeos-restore.sh:ro
      - ./scripts/database/lifeos-maintenance.sh:/usr/local/bin/lifeos-maintenance.sh:ro
      - ./scripts/database/lifeos-health-check.sh:/usr/local/bin/lifeos-health-check.sh:ro
      # Backup storage
      - lifeos-backups:/var/backups
      # Configuration
      - ./docker/postgres/pgpass:/root/.pgpass:ro
    networks:
      - lifeos-network
    depends_on:
      - lifeos-postgres
      - lifeos-neo4j
      - lifeos-redis
    entrypoint: ["tail", "-f", "/dev/null"]  # Keep container running for manual operations
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    labels:
      - "act.service=lifeos-admin"
      - "act.environment=lifeos"
      - "act.role=database-administration"

# Network Configuration for Life OS
networks:
  # Life OS internal network for all services
  lifeos-network:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: lifeos-br
    ipam:
      config:
        - subnet: 172.28.1.0/24
          gateway: 172.28.1.1
    internal: false  # Allow external connections for development
    labels:
      - "purpose=lifeos-database-orchestration"
      - "environment=lifeos"
      - "data-residency=australia"
      - "security-zone=internal"

  # Knowledge graph network for Life OS Neo4j integration
  knowledge-graph-network:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: lifeos-graph-br
    ipam:
      config:
        - subnet: 172.28.2.0/24
          gateway: 172.28.2.1
    labels:
      - "purpose=graph-analytics"
      - "environment=lifeos"
      - "data-residency=australia"

  # Database network (shared with existing infrastructure)
  database-network:
    external: true  # Connect to existing network from docker-compose.yml

# Persistent Volumes with Australian Data Residency Compliance
volumes:
  # PostgreSQL data with encryption at rest
  lifeos-postgres-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${LIFEOS_DATA_ROOT:-./data}/lifeos/postgres
    labels:
      - "data-residency=australia"
      - "backup-required=true"
      - "encryption-required=true"
      - "service=lifeos-postgres"
      - "beautiful-obsolescence=2027"

  # Neo4j data with community control
  lifeos-neo4j-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${LIFEOS_DATA_ROOT:-./data}/lifeos/neo4j/data
    labels:
      - "data-residency=australia"
      - "backup-required=true"
      - "service=lifeos-neo4j"
      - "community-networks=enabled"
      - "beautiful-obsolescence=2027"

  lifeos-neo4j-logs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${LIFEOS_DATA_ROOT:-./data}/lifeos/neo4j/logs
    labels:
      - "data-residency=australia"
      - "service=lifeos-neo4j"
      - "retention-period=90d"

  lifeos-neo4j-import:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${LIFEOS_DATA_ROOT:-./data}/lifeos/neo4j/import
    labels:
      - "data-residency=australia"
      - "service=lifeos-neo4j"

  lifeos-neo4j-plugins:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${LIFEOS_DATA_ROOT:-./data}/lifeos/neo4j/plugins
    labels:
      - "data-residency=australia"
      - "service=lifeos-neo4j"

  lifeos-neo4j-conf:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${LIFEOS_DATA_ROOT:-./data}/lifeos/neo4j/conf
    labels:
      - "data-residency=australia"
      - "service=lifeos-neo4j"

  # Redis data with performance optimization
  lifeos-redis-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${LIFEOS_DATA_ROOT:-./data}/lifeos/redis
    labels:
      - "data-residency=australia"
      - "backup-required=true"
      - "service=lifeos-redis"
      - "beautiful-obsolescence=2027"

  # Backup storage for database maintenance
  lifeos-backups:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${LIFEOS_DATA_ROOT:-./data}/lifeos/backups
    labels:
      - "data-residency=australia"
      - "backup-storage=true"
      - "retention-period=365d"
      - "beautiful-obsolescence=2027"