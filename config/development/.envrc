#!/usr/bin/env bash

# ACT Placemat - direnv configuration
# This file automatically loads environment variables when entering the directory
# Install direnv: https://direnv.net/docs/installation.html

# ==============================================
# ENVIRONMENT SETUP
# ==============================================

# Set Node environment
export NODE_ENV="${NODE_ENV:-development}"

# Load environment files using dotenv-flow pattern
if [[ -f ".env.local" ]]; then
  echo "üîë Loading .env.local (local overrides)"
  dotenv_if_exists ".env.local"
fi

if [[ -f ".env.${NODE_ENV}.local" ]]; then
  echo "üîë Loading .env.${NODE_ENV}.local (environment-specific local)"
  dotenv_if_exists ".env.${NODE_ENV}.local"
fi

if [[ -f ".env.${NODE_ENV}" ]]; then
  echo "üîë Loading .env.${NODE_ENV} (environment-specific)"
  dotenv_if_exists ".env.${NODE_ENV}"
fi

if [[ -f ".env" ]]; then
  echo "üîë Loading .env (base configuration)"
  dotenv_if_exists ".env"
fi

# Load intelligence-specific configuration
if [[ -f "config/intelligence.env" ]]; then
  echo "üß† Loading intelligence configuration"
  dotenv_if_exists "config/intelligence.env"
fi

# ==============================================
# DEVELOPMENT TOOLS
# ==============================================

# Add local node_modules/.bin to PATH
PATH_add node_modules/.bin

# Add local tools to PATH
if [[ -d "tools/bin" ]]; then
  PATH_add tools/bin
fi

# ==============================================
# PROJECT-SPECIFIC CONFIGURATION
# ==============================================

# Set default ports if not specified
export FRONTEND_PORT="${FRONTEND_PORT:-5173}"
export BACKEND_PORT="${BACKEND_PORT:-4000}"
export API_PORT="${API_PORT:-3000}"

# Set URLs based on ports
export VITE_API_URL="${VITE_API_URL:-http://localhost:${BACKEND_PORT}}"
export VITE_FRONTEND_URL="${VITE_FRONTEND_URL:-http://localhost:${FRONTEND_PORT}}"
export FRONTEND_URL="${FRONTEND_URL:-http://localhost:${FRONTEND_PORT}}"
export API_BASE_URL="${API_BASE_URL:-http://localhost:${BACKEND_PORT}}"

# Application metadata
export APP_NAME="${APP_NAME:-ACT Placemat}"
export APP_VERSION="${APP_VERSION:-2.0.0}"

# ==============================================
# AUSTRALIAN LOCALISATION
# ==============================================

export TIMEZONE="${TIMEZONE:-Australia/Sydney}"
export LOCALE="${LOCALE:-en-AU}"
export CURRENCY="${CURRENCY:-AUD}"
export TZ="Australia/Sydney"

# ==============================================
# BULLETPROOF ENVIRONMENT MANAGEMENT üîí
# ==============================================

# Auto-check environment health when entering directory
if [[ -z "$CI" ]] && [[ -z "$GITHUB_ACTIONS" ]]; then
  if [[ ! -f .env ]]; then
    echo "‚ùå No .env file found. Run: ./env-quick.sh fix"
  fi
fi

# Environment management aliases
alias env-fix='./env-quick.sh fix'
alias env-check='./env-quick.sh check'
alias env-status='./env-quick.sh status'
alias env-backup='./env-quick.sh backup'
alias env-restore='./env-quick.sh restore'
alias env-intelligence='./scripts/env-intelligence-setup.sh'

# ==============================================
# DEVELOPMENT HELPERS
# ==============================================

# Enable helpful aliases for development
alias nxdev="nx run-many --target=serve --projects=frontend,backend --parallel"
alias nxbuild="nx run-many --target=build --projects=frontend,backend --parallel"
alias nxtest="nx run-many --target=test --projects=frontend,backend --parallel"
alias nxlint="nx run-many --target=lint --projects=frontend,backend --parallel"

# Task Master AI shortcuts
alias tm="task-master"
alias taskmaster="task-master"
alias tmnext="task-master next"
alias tmlist="task-master list"

# Quick development commands
alias dev="npm run dev"
alias build="npm run build"
alias test="npm run test"
alias lint="npm run lint"
alias format="npm run format"
alias typecheck="npm run type-check"

# Server management
alias start-ecosystem="./start-ecosystem-bulletproof.sh"
alias stop-ecosystem="./stop-ecosystem.sh"

# ==============================================
# LOGGING AND DEBUGGING
# ==============================================

# Create logs directory if it doesn't exist
if [[ ! -d "logs" ]]; then
  mkdir -p logs
fi

export LOG_LEVEL="${LOG_LEVEL:-info}"
export LOG_FILE="${LOG_FILE:-logs/app.log}"

# ==============================================
# SECURITY WARNINGS
# ==============================================

# Check for sensitive files that shouldn't be committed
check_sensitive_files() {
  local sensitive_files=(
    ".env.local"
    ".env.production.local"
    ".env.development.local"
    "secrets.yaml"
    "secrets.enc.yaml"
  )
  
  for file in "${sensitive_files[@]}"; do
    if [[ -f "$file" ]] && git check-ignore "$file" >/dev/null 2>&1; then
      :  # File is properly ignored
    elif [[ -f "$file" ]]; then
      echo "‚ö†Ô∏è  Warning: $file contains sensitive data and should not be committed"
      echo "   Add it to .gitignore if not already there"
    fi
  done
}

# Run security check (suppress in CI/CD)
if [[ -z "$CI" ]] && [[ -z "$GITHUB_ACTIONS" ]]; then
  check_sensitive_files
fi

# ==============================================
# COMPLETION MESSAGE
# ==============================================

echo "üåè ACT Placemat environment loaded for ${NODE_ENV}"
echo "üì± Frontend: http://localhost:${FRONTEND_PORT}"
echo "üîó Backend: http://localhost:${BACKEND_PORT}"

# Show available commands
if [[ "$1" == "--help" ]] || [[ "$1" == "-h" ]]; then
  echo ""
  echo "Available aliases:"
  echo "  dev, build, test, lint, format, typecheck"
  echo "  nxdev, nxbuild, nxtest, nxlint"
  echo "  tm, taskmaster, tmnext, tmlist"
  echo "  start-ecosystem, stop-ecosystem"
fi