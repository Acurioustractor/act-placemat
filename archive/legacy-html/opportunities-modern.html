<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACT Placemat - Opportunities</title>
    <link rel="stylesheet" href="modern-styles.css">
    <style>
        .opportunities-filters {
            background: var(--surface);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            margin-bottom: var(--space-6);
        }

        .opportunities-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: var(--space-6);
        }

        .opportunity-card {
            background: var(--surface);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            overflow: hidden;
            transition: all var(--transition-normal);
            cursor: pointer;
        }

        .opportunity-card:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        .opportunity-header {
            padding: var(--space-6);
            border-bottom: 1px solid var(--gray-200);
        }

        .opportunity-title {
            font-size: var(--text-lg);
            font-weight: var(--font-semibold);
            color: var(--text-primary);
            margin: 0 0 var(--space-2) 0;
            line-height: var(--leading-tight);
        }

        .opportunity-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-3);
        }

        .opportunity-amount {
            font-size: var(--text-xl);
            font-weight: var(--font-bold);
            color: var(--success);
        }

        .opportunity-deadline {
            font-size: var(--text-sm);
            color: var(--text-secondary);
            background: var(--warning-light);
            color: var(--warning);
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-sm);
        }

        .opportunity-description {
            color: var(--text-secondary);
            font-size: var(--text-sm);
            line-height: var(--leading-normal);
        }

        .opportunity-content {
            padding: var(--space-6);
        }

        .opportunity-tags {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-2);
            margin-bottom: var(--space-4);
        }

        .opportunity-tag {
            padding: var(--space-1) var(--space-2);
            font-size: var(--text-xs);
            background: var(--primary-light);
            color: var(--primary);
            border-radius: var(--radius-sm);
            font-weight: var(--font-medium);
        }

        .opportunity-progress {
            margin-bottom: var(--space-4);
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: var(--space-2);
            font-size: var(--text-sm);
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: var(--gray-200);
            border-radius: var(--radius-sm);
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            transition: width var(--transition-normal);
        }

        .opportunity-actions {
            display: flex;
            gap: var(--space-3);
            padding: var(--space-6);
            background: var(--background-secondary);
            border-top: 1px solid var(--gray-200);
        }

        .empty-state {
            text-align: center;
            padding: var(--space-16);
            color: var(--text-secondary);
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: var(--space-4);
            color: var(--gray-400);
        }
    </style>
    <script src="menu-bar.js"></script>
</head>
<body>
    <div class="app-container">
        <div class="app-main">
            <header class="app-header">
                <h1 class="header-title">Opportunities</h1>
                <div class="header-actions">
                    <button class="btn btn-ghost btn-sm" onclick="refreshOpportunities()">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"/>
                        </svg>
                        Refresh
                    </button>
                    <button class="btn btn-primary btn-sm">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
                        </svg>
                        Add Opportunity
                    </button>
                </div>
            </header>

            <main class="app-content">
                <!-- Summary Statistics -->
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value" id="total-opportunities">-</div>
                        <div class="metric-label">Total Opportunities</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="active-opportunities">-</div>
                        <div class="metric-label">Active Opportunities</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="total-value">-</div>
                        <div class="metric-label">Total Value</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="success-rate">-</div>
                        <div class="metric-label">Success Rate</div>
                    </div>
                </div>

                <!-- Filters -->
                <div class="opportunities-filters">
                    <div class="grid grid-cols-4">
                        <div class="form-group">
                            <label class="form-label">Search Opportunities</label>
                            <input type="text" class="form-input" id="search-input" placeholder="Search by name or type...">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="status-filter">
                                <option value="all">All Statuses</option>
                                <option value="open">Open</option>
                                <option value="in-progress">In Progress</option>
                                <option value="submitted">Submitted</option>
                                <option value="awarded">Awarded</option>
                                <option value="closed">Closed</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Type</label>
                            <select class="form-select" id="type-filter">
                                <option value="all">All Types</option>
                                <option value="grant">Grant</option>
                                <option value="contract">Contract</option>
                                <option value="partnership">Partnership</option>
                                <option value="investment">Investment</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Amount Range</label>
                            <select class="form-select" id="amount-filter">
                                <option value="all">All Amounts</option>
                                <option value="0-10000">$0 - $10K</option>
                                <option value="10000-50000">$10K - $50K</option>
                                <option value="50000-100000">$50K - $100K</option>
                                <option value="100000+">$100K+</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Opportunities Grid -->
                <div id="opportunities-loading" class="loading hidden">
                    <div class="spinner"></div>
                    Loading opportunities...
                </div>

                <div id="opportunities-error" class="text-center text-secondary hidden">
                    Failed to load opportunities
                </div>

                <div id="opportunities-container" class="opportunities-grid">
                    <!-- Opportunities will be loaded here -->
                </div>

                <!-- Empty State -->
                <div id="empty-state" class="empty-state hidden">
                    <svg fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <h3 class="text-lg font-semibold mb-2">No Opportunities Found</h3>
                    <p class="text-secondary mb-4">Start by adding your first opportunity or adjust your filters.</p>
                    <button class="btn btn-primary">Add First Opportunity</button>
                </div>
            </main>
        </div>
    </div>

    <script src="modern-nav.js"></script>
    <script>
        let allOpportunities = [];
        let filteredOpportunities = [];

        async function initOpportunities() {
            try {
                await loadOpportunities();
                setupFilters();
            } catch (error) {
                console.error('Failed to initialize opportunities:', error);
                showError('Failed to initialize opportunities');
            }
        }

        async function loadOpportunities() {
            try {
                console.log('ðŸ”„ Starting to load opportunities...');
                
                // Fetch real opportunities from Notion
                const response = await fetch('/api/notion/query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        databaseId: '234ebcf9-81cf-804e-873f-f352f03c36da' // Opportunities database ID
                    })
                });

                console.log('ðŸ“¡ Opportunities response:', response.status, response.statusText);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('ðŸ“Š Raw opportunities data:', data.results?.length, 'opportunities');
                
                allOpportunities = data.results.map(parseNotionOpportunity);
                filteredOpportunities = [...allOpportunities];
                
                console.log('ðŸ“ˆ Parsed opportunities:', allOpportunities.length);
                
                updateMetrics();
                renderOpportunities();
                
                console.log('âœ… About to hide opportunities loading...');
                hideLoading();
                console.log('âœ… Opportunities loading hidden successfully');
                
            } catch (error) {
                console.error('âŒ Error loading opportunities:', error);
                showError('Failed to load opportunities');
            }
        }

        function parseNotionOpportunity(page) {
            const props = page.properties;
            
            const getName = (prop) => {
                if (!prop) return '';
                if (prop.title && prop.title.length > 0) return prop.title[0].plain_text;
                if (prop.rich_text && prop.rich_text.length > 0) return prop.rich_text[0].plain_text;
                return '';
            };

            const getSelect = (prop) => {
                if (!prop || !prop.select) return '';
                return prop.select.name;
            };

            const getNumber = (prop) => {
                if (!prop || prop.number === null) return 0;
                return prop.number;
            };

            const getDate = (prop) => {
                if (!prop || !prop.date) return null;
                return prop.date.start;
            };

            return {
                id: page.id,
                title: getName(props.Name) || 'Untitled Opportunity',
                description: getName(props['Next Action']) || 'No description available',
                amount: getNumber(props.Amount) || 0,
                deadline: getDate(props.Deadline),
                status: getSelect(props.Stage)?.toLowerCase() || 'unknown',
                type: 'opportunity',
                tags: [getSelect(props.Stage)].filter(Boolean),
                probability: getSelect(props.Probability) || '0%',
                organization: 'Connected via Notion'
            };
        }

        function generateMockOpportunities() {
            return [
                {
                    id: '1',
                    title: 'Federal Indigenous Innovation Grant',
                    description: 'Funding for Indigenous-led technology and innovation projects focused on community development.',
                    amount: 150000,
                    deadline: '2025-08-15',
                    status: 'open',
                    type: 'grant',
                    tags: ['Indigenous', 'Innovation', 'Community'],
                    probability: '25%',
                    organization: 'Department of Innovation'
                },
                {
                    id: '2',
                    title: 'Queensland Community Impact Fund',
                    description: 'Supporting community-led initiatives that address local challenges and create lasting positive change.',
                    amount: 75000,
                    deadline: '2025-07-30',
                    status: 'in-progress',
                    type: 'grant',
                    tags: ['Community', 'Queensland', 'Social Impact'],
                    probability: '50%',
                    organization: 'Queensland Government'
                },
                {
                    id: '3',
                    title: 'Youth Justice Reform Partnership',
                    description: 'Collaborative partnership opportunity to develop innovative approaches to youth justice and rehabilitation.',
                    amount: 200000,
                    deadline: '2025-09-01',
                    status: 'open',
                    type: 'partnership',
                    tags: ['Youth Justice', 'Reform', 'Partnership'],
                    probability: '25%',
                    organization: 'Justice Reform Initiative'
                },
                {
                    id: '4',
                    title: 'Digital Storytelling Platform Contract',
                    description: 'Contract to develop and maintain digital storytelling platform for community organizations.',
                    amount: 120000,
                    deadline: '2025-08-01',
                    status: 'submitted',
                    type: 'contract',
                    tags: ['Digital', 'Storytelling', 'Platform'],
                    probability: '90%',
                    organization: 'Community Stories Network'
                },
                {
                    id: '5',
                    title: 'Social Impact Investment Round',
                    description: 'Investment opportunity for scalable social impact ventures with proven community outcomes.',
                    amount: 500000,
                    deadline: '2025-10-15',
                    status: 'open',
                    type: 'investment',
                    tags: ['Investment', 'Social Impact', 'Scalable'],
                    probability: '15%',
                    organization: 'Impact Capital Partners'
                }
            ];
        }

        function updateMetrics() {
            const total = allOpportunities.length;
            const active = allOpportunities.filter(o => o.status === 'open' || o.status === 'in-progress').length;
            const totalValue = allOpportunities.reduce((sum, o) => sum + o.amount, 0);
            const awarded = allOpportunities.filter(o => o.status === 'awarded').length;
            const successRate = total > 0 ? Math.round((awarded / total) * 100) : 0;

            document.getElementById('total-opportunities').textContent = total;
            document.getElementById('active-opportunities').textContent = active;
            document.getElementById('total-value').textContent = formatCurrency(totalValue);
            document.getElementById('success-rate').textContent = successRate + '%';
        }

        function renderOpportunities() {
            const container = document.getElementById('opportunities-container');
            
            if (filteredOpportunities.length === 0) {
                container.classList.add('hidden');
                document.getElementById('empty-state').classList.remove('hidden');
                return;
            }

            document.getElementById('empty-state').classList.add('hidden');
            container.classList.remove('hidden');

            container.innerHTML = filteredOpportunities.map(opportunity => `
                <div class="opportunity-card" onclick="viewOpportunity('${opportunity.id}')">
                    <div class="opportunity-header">
                        <h3 class="opportunity-title">${opportunity.title}</h3>
                        <div class="opportunity-meta">
                            <div class="opportunity-amount">${formatCurrency(opportunity.amount)}</div>
                            <div class="opportunity-deadline">Due: ${formatDate(opportunity.deadline)}</div>
                        </div>
                        <p class="opportunity-description">${opportunity.description}</p>
                    </div>
                    
                    <div class="opportunity-content">
                        <div class="opportunity-tags">
                            ${opportunity.tags.map(tag => `<span class="opportunity-tag">${tag}</span>`).join('')}
                        </div>
                        
                        
                        <div class="text-sm text-secondary">
                            <strong>Organization:</strong> ${opportunity.organization}
                        </div>
                    </div>
                    
                    <div class="opportunity-actions">
                        <div class="status-badge ${getOpportunityStatusClass(opportunity.status)}">
                            ${capitalizeFirst(opportunity.status.replace('-', ' '))}
                        </div>
                        <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); editOpportunity('${opportunity.id}')">
                            Edit
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); applyToOpportunity('${opportunity.id}')">
                            ${opportunity.status === 'open' ? 'Apply' : 'View Details'}
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function setupFilters() {
            document.getElementById('search-input').addEventListener('input', applyFilters);
            document.getElementById('status-filter').addEventListener('change', applyFilters);
            document.getElementById('type-filter').addEventListener('change', applyFilters);
            document.getElementById('amount-filter').addEventListener('change', applyFilters);
        }

        function applyFilters() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const statusFilter = document.getElementById('status-filter').value;
            const typeFilter = document.getElementById('type-filter').value;
            const amountFilter = document.getElementById('amount-filter').value;
            
            filteredOpportunities = allOpportunities.filter(opportunity => {
                // Search filter
                if (searchTerm && !opportunity.title.toLowerCase().includes(searchTerm) && 
                    !opportunity.description.toLowerCase().includes(searchTerm) &&
                    !opportunity.tags.some(tag => tag.toLowerCase().includes(searchTerm))) {
                    return false;
                }
                
                // Status filter
                if (statusFilter !== 'all' && opportunity.status !== statusFilter) {
                    return false;
                }
                
                // Type filter
                if (typeFilter !== 'all' && opportunity.type !== typeFilter) {
                    return false;
                }
                
                // Amount filter
                if (amountFilter !== 'all') {
                    const [min, max] = amountFilter.includes('+') ? 
                        [parseInt(amountFilter.replace('+', '')), Infinity] :
                        amountFilter.split('-').map(x => parseInt(x));
                    
                    if (opportunity.amount < min || opportunity.amount > max) {
                        return false;
                    }
                }
                
                return true;
            });
            
            renderOpportunities();
        }

        function hideLoading() {
            document.getElementById('opportunities-loading').classList.add('hidden');
            document.getElementById('opportunities-container').classList.remove('hidden');
        }

        function viewOpportunity(opportunityId) {
            // Find the opportunity
            const opportunity = allOpportunities.find(o => o.id === opportunityId);
            if (!opportunity) return;
            
            // For now, show details in an alert - later can be a modal or detail page
            const details = `
Opportunity: ${opportunity.title}
Amount: $${opportunity.amount?.toLocaleString() || 'Unknown'}
Stage: ${opportunity.status || 'Unknown'}
Deadline: ${opportunity.deadline || 'Not set'}
Status: ${opportunity.status || 'Unknown'}
Organization: ${opportunity.organization || 'Unknown'}

Description: ${opportunity.description || 'No description available'}
            `.trim();
            
            alert(details);
        }

        function showError(message) {
            document.getElementById('opportunities-loading').classList.add('hidden');
            document.getElementById('opportunities-error').classList.remove('hidden');
            document.getElementById('opportunities-error').textContent = message;
        }

        async function refreshOpportunities() {
            document.getElementById('opportunities-loading').classList.remove('hidden');
            document.getElementById('opportunities-container').classList.add('hidden');
            document.getElementById('opportunities-error').classList.add('hidden');
            document.getElementById('empty-state').classList.add('hidden');
            
            await loadOpportunities();
        }

        // Utility functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
        }

        function capitalizeFirst(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        function getOpportunityStatusClass(status) {
            switch (status) {
                case 'open': return 'status-active';
                case 'in-progress': return 'status-planning';
                case 'submitted': return 'status-planning';
                case 'awarded': return 'status-active';
                case 'closed': return 'status-completed';
                default: return 'status-planning';
            }
        }

        // Placeholder functions
        function viewOpportunity(opportunityId) {
            console.log('Viewing opportunity:', opportunityId);
        }

        function editOpportunity(opportunityId) {
            console.log('Editing opportunity:', opportunityId);
        }

        function applyToOpportunity(opportunityId) {
            console.log('Applying to opportunity:', opportunityId);
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', initOpportunities);
    </script>
</body>
</html>