<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACT Placemat - Dashboard</title>
    <link rel="stylesheet" href="shared-styles.css">
    <style>
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
        }
        
        .metric-card {
            background: var(--white);
            padding: var(--spacing-lg);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-sm);
            text-align: center;
        }
        
        .metric-value {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
            color: var(--primary-blue);
            margin-bottom: var(--spacing-sm);
        }
        
        .metric-label {
            color: var(--text-secondary);
            font-size: var(--font-size-sm);
        }
        
        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
        }
        
        .project-card {
            background: var(--white);
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-sm);
            border-left: 4px solid var(--secondary-blue);
        }
        
        .project-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--spacing-md);
        }
        
        .project-title {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            color: var(--primary-blue);
            margin: 0;
        }
        
        .project-status {
            font-size: var(--font-size-sm);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--border-radius-sm);
            background: var(--light-gray);
            color: var(--text-secondary);
        }
        
        .opportunities-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--spacing-lg);
        }
        
        .opportunity-card {
            background: var(--white);
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-sm);
            border-left: 4px solid var(--accent-green);
        }
        
        .opportunity-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--spacing-md);
        }
        
        .opportunity-title {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            color: var(--primary-blue);
            margin: 0;
        }
        
        .opportunity-amount {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-bold);
            color: var(--accent-green);
        }
        
        .loading {
            text-align: center;
            padding: var(--spacing-xl);
            color: var(--text-secondary);
        }
        
        .error {
            background: rgba(244, 67, 54, 0.1);
            border: 1px solid var(--error-red);
            border-radius: var(--border-radius-md);
            padding: var(--spacing-lg);
            color: var(--error-red);
            margin-bottom: var(--spacing-lg);
        }
        
        .refresh-btn {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 100;
        }
    </style>
    <script src="menu-bar.js"></script>
    <script src="supabase-stories-connector.js"></script>
    <script src="supabase-services-connector.js"></script>
</head>
<body>
    <button class="act-btn refresh-btn" onclick="refreshDashboard()">üîÑ Refresh</button>
    
    <div class="act-content">
        <div class="act-card act-text-center">
            <div style="font-size: 48px; margin-bottom: var(--spacing-md);">üå±</div>
            <h1>ACT Placemat Dashboard</h1>
            <p style="color: var(--text-secondary); margin-bottom: var(--spacing-lg);">
                Real-time overview of projects and opportunities
            </p>
            <div class="act-status act-status-success">
                <span class="act-status-dot"></span>
                <span>System Online</span>
            </div>
        </div>

        <!-- Metrics Overview -->
        <div class="metrics-grid" id="metrics-container">
            <div class="metric-card">
                <div class="metric-value" id="total-projects">-</div>
                <div class="metric-label">Total Projects</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="total-opportunities">-</div>
                <div class="metric-label">Active Projects</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="pipeline-value">-</div>
                <div class="metric-label">Total Revenue</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="weighted-pipeline">-</div>
                <div class="metric-label">Revenue Potential</div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="act-card">
            <div class="act-card-header">
                <h2 class="act-card-title">üöÄ Quick Access</h2>
            </div>
            <div class="act-grid act-grid-4">
                <a href="map-modern.html" class="act-btn">üó∫Ô∏è Projects Map</a>
                <a href="opportunities-modern.html" class="act-btn">üéØ Opportunities</a>
                <a href="analytics-modern.html" class="act-btn act-btn-secondary">üìä Full Dashboard</a>
                <a href="docs-modern.html" class="act-btn act-btn-secondary">üìö Docs</a>
            </div>
        </div>

        <!-- Recent Projects -->
        <div class="act-card">
            <div class="act-card-header">
                <h2 class="act-card-title">üó∫Ô∏è Recent Projects</h2>
                <a href="map-modern.html" class="act-btn act-btn-secondary">View All</a>
            </div>
            <div id="projects-loading" class="loading hidden">
                <div class="act-loading"></div>
                <p>Loading projects...</p>
            </div>
            <div id="projects-error" class="error" style="display: none;"></div>
            <div id="projects-container" class="projects-grid" style="display: none;"></div>
        </div>

        <!-- Active Opportunities -->
        <div class="act-card">
            <div class="act-card-header">
                <h2 class="act-card-title">üéØ Active Opportunities</h2>
                <a href="opportunities-modern.html" class="act-btn act-btn-secondary">View All</a>
            </div>
            <div id="opportunities-loading" class="loading hidden">
                <div class="act-loading"></div>
                <p>Loading opportunities...</p>
            </div>
            <div id="opportunities-error" class="error" style="display: none;"></div>
            <div id="opportunities-container" class="opportunities-grid" style="display: none;"></div>
        </div>

        <!-- Community Stories Section -->
        <div class="act-card" id="stories-section" style="display: none;">
            <div class="act-card-header">
                <h2 class="act-card-title">üìö Community Stories</h2>
                <span class="act-badge" id="stories-count">-</span>
            </div>
            <div id="stories-loading" class="loading hidden">
                <div class="act-loading"></div>
                <p>Loading community stories...</p>
            </div>
            <div id="stories-error" class="error" style="display: none;"></div>
            <div id="stories-container" class="projects-grid" style="display: none;"></div>
        </div>

        <!-- Australia-wide Services Section -->
        <div class="act-card" id="services-section" style="display: none;">
            <div class="act-card-header">
                <h2 class="act-card-title">üá¶üá∫ Australia-wide Services</h2>
                <span class="act-badge" id="services-count">-</span>
            </div>
            <div id="services-loading" class="loading">
                <div class="act-loading"></div>
                <p>Loading services database...</p>
            </div>
            <div id="services-error" class="error" style="display: none;"></div>
            <div id="services-container" style="display: none;"></div>
        </div>
    </div>

    <script src="notion-mcp-enhanced.js"></script>
    <script src="notion-real-data.js"></script>
    <script>
        let notion;
        
        async function initDashboard() {
            notion = new NotionRealData();
            await loadDashboardData();
        }
        
        async function loadDashboardData() {
            try {
                console.log('Loading dashboard data...');
                const allData = await notion.fetchAllProjects();
                
                updateMetrics(allData);
                renderProjects(allData.projects);
                renderOpportunities([]); // No opportunities data yet from real API
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showError('projects', error.message);
                showError('opportunities', error.message);
            }
        }
        
        function updateMetrics(data) {
            document.getElementById('total-projects').textContent = data.summary?.totalProjects || data.projects.length;
            document.getElementById('total-opportunities').textContent = data.summary?.activeProjects || data.projects.filter(p => p.status?.includes('Active')).length;
            document.getElementById('pipeline-value').textContent = formatCurrency(data.summary?.totalRevenue || 0);
            document.getElementById('weighted-pipeline').textContent = formatCurrency(data.summary?.totalPotential || 0);
        }
        
        function renderProjects(projects) {
            const container = document.getElementById('projects-container');
            const loading = document.getElementById('projects-loading');
            
            loading.style.display = 'none';
            container.style.display = 'grid';
            
            if (projects.length === 0) {
                container.innerHTML = '<p class="act-text-center">No projects found. <a href="map-modern.html">View projects page</a></p>';
                return;
            }
            
            // Show first 6 projects
            const recentProjects = projects.slice(0, 6);
            
            container.innerHTML = recentProjects.map(project => `
                <div class="project-card">
                    <div class="project-header">
                        <h3 class="project-title">${project.name || 'Untitled Project'}</h3>
                        <span class="project-status">${project.status || 'Unknown'}</span>
                    </div>
                    <p style="color: var(--text-secondary); margin-bottom: var(--spacing-md);">
                        ${project.description || 'No description available'}
                    </p>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: var(--text-secondary);">${project.area || 'General'}</span>
                        ${project.revenueActual ? `<span style="color: var(--accent-green); font-weight: var(--font-weight-semibold);">${formatCurrency(project.revenueActual)}</span>` : ''}
                    </div>
                </div>
            `).join('');
        }
        
        function renderOpportunities(opportunities) {
            const container = document.getElementById('opportunities-container');
            const loading = document.getElementById('opportunities-loading');
            
            loading.style.display = 'none';
            container.style.display = 'grid';
            
            if (opportunities.length === 0) {
                container.innerHTML = '<p class="act-text-center">No opportunities found. <a href="/opportunities">View opportunities page</a></p>';
                return;
            }
            
            // Show first 6 opportunities
            const activeOpportunities = opportunities.slice(0, 6);
            
            container.innerHTML = activeOpportunities.map(opp => `
                <div class="opportunity-card">
                    <div class="opportunity-header">
                        <h3 class="opportunity-title">${opp.name || 'Untitled Opportunity'}</h3>
                        <span class="opportunity-amount">${formatCurrency(opp.amount || 0)}</span>
                    </div>
                    <div style="margin-bottom: var(--spacing-md);">
                        <span class="act-status ${getStageColor(opp.stage)}">
                            <span class="act-status-dot"></span>
                            <span>${opp.stage || 'Unknown'}</span>
                        </span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: var(--text-secondary);">${opp.type || 'General'}</span>
                        <span style="color: var(--accent-green); font-weight: var(--font-weight-semibold);">
                            ${opp.probability || 50}% ¬∑ ${formatCurrency(opp.weightedRevenue || 0)}
                        </span>
                    </div>
                </div>
            `).join('');
        }
        
        function getStageColor(stage) {
            switch(stage) {
                case 'Closed Won': return 'act-status-success';
                case 'Negotiation': return 'act-status-warning';
                case 'Closed Lost': return 'act-status-error';
                default: return 'act-status-warning';
            }
        }
        
        function showError(section, message) {
            const loading = document.getElementById(`${section}-loading`);
            const error = document.getElementById(`${section}-error`);
            const container = document.getElementById(`${section}-container`);
            
            loading.style.display = 'none';
            container.style.display = 'none';
            error.style.display = 'block';
            error.textContent = `Error loading ${section}: ${message}`;
        }
        
        function formatCurrency(amount) {
            if (!amount) return '$0';
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }
        
        async function refreshDashboard() {
            document.getElementById('projects-loading').style.display = 'block';
            document.getElementById('opportunities-loading').style.display = 'block';
            document.getElementById('projects-container').style.display = 'none';
            document.getElementById('opportunities-container').style.display = 'none';
            
            await notion.refreshAll();
            await loadDashboardData();
        }
        
        // üìö Stories Integration
        let storiesIntegration;
        
        async function loadStories() {
            const storiesSection = document.getElementById('stories-section');
            const storiesLoading = document.getElementById('stories-loading');
            const storiesError = document.getElementById('stories-error');
            const storiesContainer = document.getElementById('stories-container');
            const storiesCount = document.getElementById('stories-count');
            
            try {
                if (typeof SupabaseStoriesConnector !== 'undefined') {
                    storiesLoading.style.display = 'block';
                    storiesError.style.display = 'none';
                    storiesContainer.style.display = 'none';
                    
                    storiesIntegration = new SupabaseStoriesConnector();
                    const stories = await storiesIntegration.getStoriesWithDetails();
                    
                    console.log(`‚úÖ Loaded ${stories.length} stories from Supabase`);
                    
                    // Update count badge
                    storiesCount.textContent = stories.length;
                    
                    // Create stories HTML
                    const storiesHTML = stories.slice(0, 6).map(story => `
                        <div class="project-card">
                            <div class="project-header">
                                <h3 class="project-title">${story.title || 'Untitled Story'}</h3>
                                <span class="project-status" style="background: var(--primary-light); color: var(--primary);">Story</span>
                            </div>
                            <p style="color: var(--text-secondary); margin-bottom: var(--spacing-md); line-height: 1.5;">
                                ${(story.description || '').substring(0, 150)}...
                            </p>
                            <div style="display: flex; justify-content: space-between; align-items: center; font-size: var(--font-size-sm);">
                                <span style="color: var(--text-tertiary);">by ${story.storytellerName || 'Anonymous'}</span>
                                ${story.relatedProject ? `<span style="color: var(--primary); font-weight: 500;">${story.relatedProject}</span>` : ''}
                            </div>
                        </div>
                    `).join('');
                    
                    storiesContainer.innerHTML = storiesHTML;
                    
                    // Show the stories section
                    storiesLoading.style.display = 'none';
                    storiesContainer.style.display = 'grid';
                    storiesSection.style.display = 'block';
                    
                } else {
                    console.log('üìö Stories integration not available');
                }
            } catch (error) {
                console.log('üìö Stories loading failed:', error.message);
                storiesLoading.style.display = 'none';
                storiesError.style.display = 'block';
                storiesError.innerHTML = `<p>Failed to load stories: ${error.message}</p>`;
            }
        }

        // üá¶üá∫ Services Integration
        let servicesIntegration;
        
        async function loadServices() {
            const servicesSection = document.getElementById('services-section');
            const servicesLoading = document.getElementById('services-loading');
            const servicesError = document.getElementById('services-error');
            const servicesContainer = document.getElementById('services-container');
            const servicesCount = document.getElementById('services-count');
            
            try {
                if (typeof ServicesIntegration !== 'undefined') {
                    servicesLoading.style.display = 'block';
                    servicesError.style.display = 'none';
                    servicesContainer.style.display = 'none';
                    
                    servicesIntegration = new ServicesIntegration();
                    
                    // Initialize services and get analytics
                    await servicesIntegration.initializeServicesSection();
                    
                    const analytics = await servicesIntegration.connector.getServiceAnalytics();
                    const services = await servicesIntegration.connector.getServicesForMapping();
                    
                    console.log(`‚úÖ Loaded ${services.length} services from Australia-wide database`);
                    
                    // Update count badge
                    servicesCount.textContent = analytics.overview.totalServices;
                    
                    // Show the services section
                    servicesLoading.style.display = 'none';
                    servicesContainer.style.display = 'block';
                    servicesSection.style.display = 'block';
                    
                } else {
                    console.log('üá¶üá∫ Services integration not available');
                }
            } catch (error) {
                console.log('üá¶üá∫ Services loading failed:', error.message);
                servicesLoading.style.display = 'none';
                servicesError.style.display = 'block';
                servicesError.innerHTML = `<p>Failed to load services: ${error.message}</p>`;
            }
        }

        // Enhanced refresh function
        async function refreshDashboard() {
            document.getElementById('projects-loading').style.display = 'block';
            document.getElementById('opportunities-loading').style.display = 'block';
            document.getElementById('projects-container').style.display = 'none';
            document.getElementById('opportunities-container').style.display = 'none';
            
            await notion.refreshAll();
            await loadDashboardData();
            await loadStories(); // Also refresh stories
            await loadServices(); // Also refresh services
        }

        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initDashboard();
            loadStories(); // Load stories on page load
            loadServices(); // Load services on page load
        });
    </script>
</body>
</html>