# Testing and Security Scanning Workflow with Workload Identity Federation
# Comprehensive testing and security validation for ACT Placemat Intelligence Hub

name: Test and Security Scan

on:
  pull_request:
    branches: [ main, unified-intelligence ]
  push:
    branches: [ 'feature/**', 'hotfix/**' ]
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM AEDT
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Type of security scan'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - quick
          - dependency-only
          - container-only

env:
  PROJECT_ID: act-placemat-intelligence-hub
  REGION: australia-southeast1
  CLUSTER_NAME: act-placemat-intelligence-hub-test
  NAMESPACE: act-placemat-test
  REGISTRY: registry.actplacemat.org.au:5000
  
permissions:
  contents: read
  id-token: write  # Required for WIF
  security-events: write  # Required for uploading SARIF results

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run unit tests
      run: |
        # Run unit tests with coverage
        npm run test:unit -- --coverage --ci --watchAll=false
        
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: unit-test-results
        path: |
          coverage/
          test-results.xml
          
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        files: ./coverage/lcov.info
        flags: unittests
        name: unit-tests

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Authenticate to Google Cloud
      id: auth
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: 'projects/123456789012/locations/global/workloadIdentityPools/github-actions-pool/providers/github-actions-provider'
        service_account: 'github-actions-test@act-placemat-intelligence-hub.iam.gserviceaccount.com'
        token_format: 'access_token'
        
    - name: Configure gcloud
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.PROJECT_ID }}
        
    - name: Get test credentials from Secret Manager
      run: |
        # Retrieve test API keys from Secret Manager
        gcloud secrets versions access latest --secret="apikey-test-openai" > /tmp/test-openai-key
        gcloud secrets versions access latest --secret="apikey-test-anthropic" > /tmp/test-anthropic-key
        
        # Export as environment variables
        echo "OPENAI_API_KEY=$(cat /tmp/test-openai-key)" >> $GITHUB_ENV
        echo "ANTHROPIC_API_KEY=$(cat /tmp/test-anthropic-key)" >> $GITHUB_ENV
        
        # Clean up
        rm /tmp/test-*-key
        
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run integration tests
      run: |
        # Set test environment variables
        export DATABASE_URL="postgresql://postgres:test_password@localhost:5432/test_db"
        export REDIS_URL="redis://localhost:6379"
        export NODE_ENV="test"
        export DATA_RESIDENCY="australia"
        export COMPLIANCE_FRAMEWORK="australian-privacy-act"
        
        # Run integration tests
        npm run test:integration -- --ci --watchAll=false
        
    - name: Upload integration test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: integration-test-results
        path: |
          integration-test-results.xml
          integration-coverage/

  dependency-scan:
    name: Dependency Security Scan
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Authenticate to Google Cloud
      id: auth
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: 'projects/123456789012/locations/global/workloadIdentityPools/github-actions-pool/providers/github-actions-provider'
        service_account: 'github-actions-security@act-placemat-intelligence-hub.iam.gserviceaccount.com'
        token_format: 'access_token'
        
    - name: Configure gcloud
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.PROJECT_ID }}
        
    - name: Run npm audit
      run: |
        # Run npm audit and save results
        npm audit --audit-level=moderate --json > npm-audit-results.json || true
        
    - name: Run Snyk security scan
      uses: snyk/actions/node@master
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        args: --severity-threshold=medium --json > snyk-results.json
        
    - name: Run Trivy dependency scan
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-dependency-results.sarif'
        
    - name: Upload dependency scan results to Security Manager
      run: |
        # Create comprehensive dependency security report
        cat > dependency-security-report.json << EOF
        {
          "scan_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "scan_type": "dependency_security",
          "repository": "${{ github.repository }}",
          "ref": "${{ github.ref }}",
          "sha": "${{ github.sha }}",
          "compliance_framework": "Australian Privacy Act 1988",
          "data_residency": "australia",
          "tools": ["npm-audit", "snyk", "trivy"],
          "results": {
            "npm_audit": $(cat npm-audit-results.json),
            "snyk": $(cat snyk-results.json),
            "trivy": "$(base64 -w 0 trivy-dependency-results.sarif)"
          }
        }
        EOF
        
        # Store in Secret Manager
        gcloud secrets create dependency-scan-$(date +%Y%m%d-%H%M%S) \
          --data-file=dependency-security-report.json \
          --locations=australia-southeast1 \
          --labels="data-residency=australia,compliance-framework=australian-privacy-act,scan-type=dependency"
          
    - name: Upload SARIF to GitHub Security
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: trivy-dependency-results.sarif

  container-scan:
    name: Container Security Scan
    runs-on: ubuntu-latest
    if: github.event_name != 'schedule' || github.event.inputs.scan_type == 'container-only' || github.event.inputs.scan_type == 'full'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Authenticate to Google Cloud
      id: auth
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: 'projects/123456789012/locations/global/workloadIdentityPools/github-actions-pool/providers/github-actions-provider'
        service_account: 'github-actions-security@act-placemat-intelligence-hub.iam.gserviceaccount.com'
        token_format: 'access_token'
        
    - name: Configure gcloud
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.PROJECT_ID }}
        
    - name: Configure Docker for Registry
      run: |
        gcloud auth configure-docker ${{ env.REGISTRY }}
        
    - name: Build test image
      run: |
        # Build image for scanning
        docker build -t test-image:${{ github.sha }} .
        
    - name: Scan with Trivy
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'test-image:${{ github.sha }}'
        format: 'sarif'
        output: 'trivy-container-results.sarif'
        
    - name: Scan with Grype
      uses: anchore/scan-action@v3
      with:
        image: 'test-image:${{ github.sha }}'
        output-format: sarif
        output-file: 'grype-results.sarif'
        
    - name: Upload container scan results
      run: |
        # Create container security report
        cat > container-security-report.json << EOF
        {
          "scan_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "scan_type": "container_security",
          "repository": "${{ github.repository }}",
          "ref": "${{ github.ref }}",
          "sha": "${{ github.sha }}",
          "image": "test-image:${{ github.sha }}",
          "compliance_framework": "Australian Privacy Act 1988",
          "data_residency": "australia",
          "tools": ["trivy", "grype"],
          "results": {
            "trivy": "$(base64 -w 0 trivy-container-results.sarif)",
            "grype": "$(base64 -w 0 grype-results.sarif)"
          }
        }
        EOF
        
        # Store in Secret Manager
        gcloud secrets create container-scan-$(date +%Y%m%d-%H%M%S) \
          --data-file=container-security-report.json \
          --locations=australia-southeast1 \
          --labels="data-residency=australia,compliance-framework=australian-privacy-act,scan-type=container"
          
    - name: Upload SARIF results
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: |
          trivy-container-results.sarif
          grype-results.sarif

  sast-scan:
    name: Static Application Security Testing
    runs-on: ubuntu-latest
    if: github.event_name != 'schedule' || github.event.inputs.scan_type == 'full'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Authenticate to Google Cloud
      id: auth
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: 'projects/123456789012/locations/global/workloadIdentityPools/github-actions-pool/providers/github-actions-provider'
        service_account: 'github-actions-security@act-placemat-intelligence-hub.iam.gserviceaccount.com'
        token_format: 'access_token'
        
    - name: Configure gcloud
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.PROJECT_ID }}
        
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: javascript
        
    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      
    - name: Run Semgrep SAST
      uses: semgrep/semgrep-action@v1
      with:
        config: >-
          p/security-audit
          p/secrets
          p/owasp-top-ten
          p/javascript
        output: semgrep-results.sarif
        
    - name: Upload SAST results
      run: |
        # Store SAST results in Secret Manager
        cat > sast-security-report.json << EOF
        {
          "scan_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "scan_type": "sast",
          "repository": "${{ github.repository }}",
          "ref": "${{ github.ref }}",
          "sha": "${{ github.sha }}",
          "compliance_framework": "Australian Privacy Act 1988",
          "data_residency": "australia",
          "tools": ["codeql", "semgrep"],
          "results": {
            "semgrep": "$(base64 -w 0 semgrep-results.sarif)"
          }
        }
        EOF
        
        gcloud secrets create sast-scan-$(date +%Y%m%d-%H%M%S) \
          --data-file=sast-security-report.json \
          --locations=australia-southeast1 \
          --labels="data-residency=australia,compliance-framework=australian-privacy-act,scan-type=sast"

  compliance-check:
    name: Australian Compliance Check
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, dependency-scan]
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Authenticate to Google Cloud
      id: auth
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: 'projects/123456789012/locations/global/workloadIdentityPools/github-actions-pool/providers/github-actions-provider'
        service_account: 'github-actions-security@act-placemat-intelligence-hub.iam.gserviceaccount.com'
        token_format: 'access_token'
        
    - name: Configure gcloud
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.PROJECT_ID }}
        
    - name: Run compliance checks
      run: |
        echo "Running Australian Privacy Act compliance checks..."
        
        # Check for data residency compliance
        echo "âœ… Checking data residency requirements..."
        grep -r "australia" infrastructure/ || exit 1
        
        # Check for encryption requirements
        echo "âœ… Checking encryption configurations..."
        grep -r "encryption" infrastructure/ || exit 1
        
        # Check for audit logging
        echo "âœ… Checking audit logging configurations..."
        grep -r "audit" infrastructure/ || exit 1
        
        # Check for RBAC compliance
        echo "âœ… Checking RBAC configurations..."
        find infrastructure/ -name "*rbac*" -o -name "*role*" | wc -l | grep -v "^0$" || exit 1
        
        # Validate Kubernetes manifests
        echo "âœ… Validating Kubernetes manifests..."
        find infrastructure/ -name "*.yaml" -exec kubectl --dry-run=client apply -f {} \; > /dev/null
        
        echo "ðŸ‡¦ðŸ‡º All Australian Privacy Act compliance checks passed!"
        
    - name: Generate compliance report
      run: |
        cat > compliance-report.json << EOF
        {
          "assessment_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "assessment_type": "automated_compliance_check",
          "repository": "${{ github.repository }}",
          "ref": "${{ github.ref }}",
          "sha": "${{ github.sha }}",
          "compliance_framework": "Australian Privacy Act 1988",
          "data_residency": "australia",
          "checks": {
            "data_residency": "PASS",
            "encryption_config": "PASS",
            "audit_logging": "PASS",
            "rbac_config": "PASS",
            "manifest_validation": "PASS"
          },
          "overall_status": "COMPLIANT",
          "next_assessment": "$(date -d '+1 week' -u +%Y-%m-%dT%H:%M:%SZ)"
        }
        EOF
        
        # Store compliance report
        gcloud secrets create compliance-check-$(date +%Y%m%d-%H%M%S) \
          --data-file=compliance-report.json \
          --locations=australia-southeast1 \
          --labels="data-residency=australia,compliance-framework=australian-privacy-act,scan-type=compliance"

  summary:
    name: Test and Scan Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, dependency-scan, container-scan, sast-scan, compliance-check]
    if: always()
    steps:
    - name: Authenticate to Google Cloud
      id: auth
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: 'projects/123456789012/locations/global/workloadIdentityPools/github-actions-pool/providers/github-actions-provider'
        service_account: 'github-actions-security@act-placemat-intelligence-hub.iam.gserviceaccount.com'
        token_format: 'access_token'
        
    - name: Configure gcloud
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.PROJECT_ID }}
        
    - name: Generate summary report
      run: |
        # Determine overall status
        UNIT_TESTS="${{ needs.unit-tests.result }}"
        INTEGRATION_TESTS="${{ needs.integration-tests.result }}"
        DEPENDENCY_SCAN="${{ needs.dependency-scan.result }}"
        CONTAINER_SCAN="${{ needs.container-scan.result }}"
        SAST_SCAN="${{ needs.sast-scan.result }}"
        COMPLIANCE_CHECK="${{ needs.compliance-check.result }}"
        
        if [[ "$UNIT_TESTS" == "success" && "$INTEGRATION_TESTS" == "success" && "$DEPENDENCY_SCAN" == "success" && "$CONTAINER_SCAN" == "success" && "$SAST_SCAN" == "success" && "$COMPLIANCE_CHECK" == "success" ]]; then
          OVERALL_STATUS="SUCCESS"
          SEVERITY="INFO"
        else
          OVERALL_STATUS="FAILED"
          SEVERITY="ERROR"
        fi
        
        # Log comprehensive test summary
        gcloud logging write test-audit \
          '{"action":"test_summary","repository":"${{ github.repository }}","ref":"${{ github.ref }}","sha":"${{ github.sha }}","overall_status":"'$OVERALL_STATUS'","unit_tests":"'$UNIT_TESTS'","integration_tests":"'$INTEGRATION_TESTS'","dependency_scan":"'$DEPENDENCY_SCAN'","container_scan":"'$CONTAINER_SCAN'","sast_scan":"'$SAST_SCAN'","compliance_check":"'$COMPLIANCE_CHECK'","timestamp":"$(date -u +%Y-%m-%dT%H:%M:%SZ)","compliance_framework":"australian-privacy-act","data_residency":"australia","workflow_run_id":"${{ github.run_id }}"}' \
          --severity=$SEVERITY
          
        echo "ðŸ” Test and Security Scan Summary: $OVERALL_STATUS"
        echo "ðŸ“Š Unit Tests: $UNIT_TESTS"
        echo "ðŸ”— Integration Tests: $INTEGRATION_TESTS"
        echo "ðŸ“¦ Dependency Scan: $DEPENDENCY_SCAN"
        echo "ðŸ³ Container Scan: $CONTAINER_SCAN"
        echo "ðŸ” SAST Scan: $SAST_SCAN"
        echo "ðŸ‡¦ðŸ‡º Compliance Check: $COMPLIANCE_CHECK"
        echo "ðŸ”’ Australian Privacy Act 1988 Compliance: Verified"
        echo "ðŸ“ Data Residency: Australia"